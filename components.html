<!DOCTYPE html>
<html data-protected="all">
    <head>
        <title>Webstrate Componenets package repository</title>
        <meta charset="UTF-8">
    </head>
    <body>
        <div class="packages">
            <div class="package" id="wsc-icon-registry">
                <script id="descriptor-script" type="descriptor">
{
    "friendlyName": "Icon registry",
    "description": "Icon providers can register icons for everyone and everything",
    "dependencies": [],
    "assets": [
    ],
    "version": "0.1",
    "license": "Apache 2.0 + CC-BY",    
    "changelog": {
        "0.1": "Initial version"
    }
}

</script>

                <script id="IconRegistry-script" type="disabled">
/**
 *  IconRegistry
 *  Register icons and use them on the page
 * 
 *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/

/**
 * Registers icons and uses them on the page
 */
window.IconRegistry = class IconRegistry {   
    static registerProvider(iconProvider){
        IconRegistry.iconProviders.push(iconProvider);
        
        // TODO: update all icons
    }
        
    static createIcon(iconIdentifier){        
        let icon = null;
        let searchPath = null;
        
        if (Array.isArray(iconIdentifier)){
            searchPath = iconIdentifier;
        } else {        
            searchPath = [iconIdentifier];
        }

        // Query each icon or fallback in order
        search: for (const attempt of searchPath){
            for (const provider of IconRegistry.iconProviders){
                if (provider.provides(attempt)){
                    icon = provider.createIcon(attempt);
                    break search;
                }
            }
        }        

        
        // Ultimate fallback is invisible
        if (icon===null){
            icon = document.createElement("span");
        }
        icon.classList.add("wsc-registry-icon");
        icon.wscIconIdentifier = iconIdentifier;
        
        return icon;
    }
};
window.IconRegistry.iconProviders = [];

</script>

                <style id="icons-style">
.wsc-registry-icon {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

/* Fix Chrome SVG render bug for gradients/filters etc */
head {
    display: block;
    position: absolute;
    z-index: -10;
    opacity: 0;
    pointer-events: none;
}
</style>

            </div>
            <div class="package" id="FragmentLogoIcons">
                <script id="descriptor-script" type="descriptor">
{
    "friendlyName": "Fragment Logo Icon Set",
    "description": "Provides Icons for Fragments based on their logos",
    "dependencies": [
        "#wsc-icon-registry"
    ],
    "assets": [
    ],
    "version": "0.1",
    "license": "Apache 2.0 + Various",
    "changelog": {
        "0.1": "Initial version"
    }
}

</script>

                <script id="FragmentLogoIconProvider-script" type="disabled">
/**
 *  FragmentLogoIconProvider
 *  A provider for Codestrate fragment type icons
 * 
 *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/
    
/**
 * A provider for Codestrate fragment type icons
 */
window.FragmentLogoIconProvider = class FragmentLogoIconProvider {
    provides(iconIdentifier){
        return iconIdentifier.startsWith("code-fragment:");
    }
    
    /**
     * Create an icon
     */
    createIcon(iconIdentifier) {
        let mimeType = iconIdentifier.slice(14);
        /*
          "wpm/descriptor": (
            base: #000080,
            text: #A0A0FF,
            name: 'WPM Package Descriptor',
            type: 'wpm'
          ),
        */
        let supportedTypes = [
            "text/html",
            "text/javascript",
            "text/javascript+babel",
            "text/css",
            "text/x-typescript",
            "text/markdown",
            "text/x-latex",
            "image/svg+xml",
            "application/json",
            "text/p5js",
            "text/ruby",
            "application/x-lua",
            "model/vnd.usda",
            "text/x-scss",
            "text/python"
        ];               
        if (mimeType==="text/javascript+babel") mimeType = "text/javascript";
        if (supportedTypes.includes(mimeType)){
            let icon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            let link = document.createElementNS('http://www.w3.org/2000/svg', 'use');
            link.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', '#'+mimeType.replace(/(\/|\+)/g, "-"));
            icon.appendChild(link);
            return icon;
        }

        if (mimeType==="wpm/descriptor"){
            return IconRegistry.createIcon("mdc:list_alt");
        } else if (mimeType==="text/mirrorverse-audio-router"){
            return IconRegistry.createIcon("mdc:route");
        } else if (mimeType==="text/varv"){
            return IconRegistry.createIcon("webstrates:varv");
        }
        
        return null;
    }
}


/**
 * Icons for fragments
 * @type {FragmentIcons.IconProvider}
 * @hideconstructor
 */
IconRegistry.registerProvider(new FragmentLogoIconProvider());

</script>

                <?xml version="1.0" encoding="utf-8"?>
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 595.3 841.9">
    <symbol id="text-html" viewBox="0 0 512 512">
        <!-- License: Creative Commons Attribution 3.0: W3C -->
        <path d="M108.4 0h23v22.8h21.2V0h23v69h-23V46h-21v23h-23.2M206 23h-20.3V0h63.7v23H229v46h-23M259.5 0h24.1l14.8 24.3L313.2 0h24.1v69h-23V34.8l-16.1 24.8l-16.1-24.8v34.2h-22.6M348.7 0h23v46.2h32.6V69h-55.6"/>
        <path fill="#e44d26" d="M107.6 471l-33-370.4h362.8l-33 370.2L255.7 512"/>
        <path fill="#f16529" d="M256 480.5V131H404.3L376 447"/>
        <path fill="#ebebeb" d="M142 176.3h114v45.4h-64.2l4.2 46.5h60v45.3H154.4M156.4 336.3H202l3.2 36.3 50.8 13.6v47.4l-93.2-26"/>
        <path fill="#fff" d="M369.6 176.3H255.8v45.4h109.6M361.3 268.2H255.8v45.4h56l-5.3 59-50.7 13.6v47.2l93-25.8"/>
    </symbol>
    <symbol id="text-css" viewBox="0 0 362.73 512">
        <!-- License: Creative Commons Attribution 3.0: Rudloff -->
        <g transform="translate(-193.63 -276.36)">
            <g transform="translate(119 276.36)">
                <polygon points="437.37 100.62 404.32 470.82 255.78 512 107.64 470.88 74.633 100.62" fill="#264de4"/>
                <polygon points="376.03 447.25 404.27 130.89 256 130.89 256 480.52" fill="#2965f1"/>
                <g fill="#ebebeb">
                    <polygon points="150.31 268.22 154.38 313.63 256 313.63 256 268.22"/>
                    <polygon points="256 176.3 255.84 176.3 142.13 176.3 146.26 221.72 256 221.72"/>
                    <polygon points="256 433.4 256 386.15 255.8 386.21 205.23 372.55 201.99 336.33 177.42 336.33 156.41 336.33 162.77 407.63 255.79 433.46"/>
                </g>
                <path d="m160 0h55v23h-32v23h32v23h-55z"/>
                <path d="m226 0h55v20h-32v4h32v46h-55v-21h32v-4h-32z"/>
                <path d="m292 0h55v20h-32v4h32v46h-55v-21h32v-4h-32z"/>
                <polygon points="311.76 313.63 306.49 372.52 255.84 386.19 255.84 433.44 348.94 407.63 349.62 399.96 360.29 280.41 361.4 268.22 369.6 176.3 255.84 176.3 255.84 221.72 319.83 221.72 315.7 268.22 255.84 268.22 255.84 313.63" fill="#fff"/>
            </g>
        </g>
    </symbol>
    <symbol id="text-javascript" viewBox="0 0 630 630">
        <!-- License: MIT: Copyright (c) 2011 Christopher Williams -->
        <rect width="630" height="630" fill="#f7df1e"/>
        <path d="m423.2 492.19c12.69 20.72 29.2 35.95 58.4 35.95 24.53 0 40.2-12.26 40.2-29.2 0-20.3-16.1-27.49-43.1-39.3l-14.8-6.35c-42.72-18.2-71.1-41-71.1-89.2 0-44.4 33.83-78.2 86.7-78.2 37.64 0 64.7 13.1 84.2 47.4l-46.1 29.6c-10.15-18.2-21.1-25.37-38.1-25.37-17.34 0-28.33 11-28.33 25.37 0 17.76 11 24.95 36.4 35.95l14.8 6.34c50.3 21.57 78.7 43.56 78.7 93 0 53.3-41.87 82.5-98.1 82.5-54.98 0-90.5-26.2-107.88-60.54zm-209.13 5.13c9.3 16.5 17.76 30.45 38.1 30.45 19.45 0 31.72-7.61 31.72-37.2v-201.3h59.2v202.1c0 61.3-35.94 89.2-88.4 89.2-47.4 0-74.85-24.53-88.81-54.075z"/>
    </symbol>
    <symbol id="text-x-latex" viewBox="0 0 1200 500">
        <path d="M285.7 238h-11.25c-4.5 45.9-10.8 101.7-90 101.7H148c-21.15 0-22.05-3.15-22.05-18V82.75c0-15.3 0-21.6 42.3-21.6h14.85v-13.5C166.9 49 126.4 49 107.95 49 90.4 49 55.3 49 40 47.65v13.5h10.35C85 61.15 85.9 66.1 85.9 82.3v236.25c0 16.2-.9 21.15-35.55 21.15H40v13.95h233.55L285.7 238z"/>
        <path d="M278.05 47.2c-1.8-5.4-2.7-7.2-8.55-7.2-5.85 0-7.2 1.8-9 7.2l-72.45 183.6c-3.15 7.65-8.55 21.6-36.45 21.6v11.25h69.75V252.4c-13.95 0-22.5-6.3-22.5-15.3 0-2.25.45-3.15 1.35-6.3l15.3-38.7h89.1l18 45.9c.9 1.8 1.8 4.05 1.8 5.4 0 9-17.1 9-25.65 9v11.25h88.65V252.4h-6.3c-21.15 0-23.4-3.15-26.55-12.15L278.05 47.2zm-18 31.95l40.05 101.7H220l40.05-101.7z"/>
        <path d="M638.5 50.35H364.45l-8.1 100.8h10.8c6.3-72.45 13.05-87.3 81-87.3 8.1 0 19.8 0 24.3.9 9.45 1.8 9.45 6.75 9.45 17.1V318.1c0 15.3 0 21.6-47.25 21.6h-18v13.95c18.45-1.35 63.9-1.35 84.6-1.35 20.7 0 67.05 0 85.5 1.35V339.7h-18c-47.25 0-47.25-6.3-47.25-21.6V81.85c0-9 0-15.3 8.1-17.1 4.95-.9 17.1-.9 25.65-.9 67.5 0 74.25 14.85 80.55 87.3h11.25l-8.55-100.8z"/>
        <path d="M879.7 339.25h-11.25c-11.25 68.85-21.6 101.7-98.55 101.7h-59.4c-21.15 0-22.05-3.15-22.05-18v-119.7h40.05c43.65 0 48.6 14.4 48.6 52.65h11.25V237.1H777.1c0 38.25-4.95 52.2-48.6 52.2h-40.05V181.75c0-14.85.9-18 22.05-18h57.6c68.85 0 80.55 24.75 87.75 87.3h11.25l-12.6-100.8h-252v13.5h10.35c34.65 0 35.55 4.95 35.55 21.15v234.9c0 16.2-.9 21.15-35.55 21.15H602.5v13.95h258.3l18.9-115.65z"/>
        <path d="M1015.15 180.4l61.65-90c9.45-14.4 24.75-28.8 64.8-29.25v-13.5h-107.1v13.5c18 .45 27.9 10.35 27.9 20.7 0 4.5-.9 5.4-4.05 10.35l-51.3 75.6-57.6-86.4c-.9-1.35-3.15-4.95-3.15-6.75 0-5.4 9.9-13.05 28.8-13.5v-13.5C959.8 49 926.95 49 909.85 49c-13.95 0-41.85-.45-58.5-1.35v13.5h8.55c24.75 0 33.3 3.15 41.85 15.75l82.35 124.65L910.75 310c-6.3 9-19.8 29.7-64.8 29.7v13.95h107.1V339.7c-20.7-.45-28.35-12.6-28.35-20.7 0-4.05 1.35-5.85 4.5-10.8l63.45-94.05 71.1 107.1c.9 1.8 2.25 3.6 2.25 4.95 0 5.4-9.9 13.05-29.25 13.5v13.95c15.75-1.35 48.6-1.35 65.25-1.35 18.9 0 39.6.45 58.5 1.35V339.7h-8.55c-23.4 0-32.85-2.25-42.3-16.2l-94.5-143.1z"/>
    </symbol>
    <symbol id="text-x-typescript" viewBox="0 0 400 400">
        <path fill="#007acc" d="M0 200V0h400v400H0"/>
        <path d="M87.7 200.7V217h52v148h36.9V217h52v-16c0-9 0-16.3-.4-16.5 0-.3-31.7-.4-70.2-.4l-70 .3v16.4l-.3-.1zM321.4 184c10.2 2.4 18 7 25 14.3 3.7 4 9.2 11 9.6 12.8 0 .6-17.3 12.3-27.8 18.8-.4.3-2-1.4-3.6-4-5.2-7.4-10.5-10.6-18.8-11.2-12-.8-20 5.5-20 16 0 3.2.6 5 1.8 7.6 2.7 5.5 7.7 8.8 23.2 15.6 28.6 12.3 41 20.4 48.5 32 8.5 13 10.4 33.4 4.7 48.7-6.4 16.7-22 28-44.3 31.7-7 1.2-23 1-30.5-.3-16-3-31.3-11-40.7-21.3-3.7-4-10.8-14.7-10.4-15.4l3.8-2.4 15-8.7 11.3-6.6 2.6 3.5c3.3 5.2 10.7 12.2 15 14.6 13 6.7 30.4 5.8 39-2 3.7-3.4 5.3-7 5.3-12 0-4.6-.7-6.7-3-10.2-3.2-4.4-9.6-8-27.6-16-20.7-8.8-29.5-14.4-37.7-23-4.7-5.2-9-13.3-11-20-1.5-5.8-2-20-.6-25.7 4.3-20 19.4-34 41-38 7-1.4 23.5-.8 30.4 1l-.2.2z"/>
    </symbol>
    <symbol id="text-markdown" viewBox="0 0 208 128">
        <!-- License: Creative Commons CC0 1.0 Universal Public Domain Dedication -->
        <rect width="198" height="118" x="5" y="5" ry="10" stroke="currentColor" stroke-width="10" fill="none"/>
        <path d="M30 98V30h20l20 25 20-25h20v68H90V59L70 84 50 59v39zm125 0l-30-33h20V30h20v35h20z"/>
    </symbol>
        
    <symbol id="text-x-scss" viewBox="0 0 548 548">
        <!-- License: Creative Commons CC0 1.0 Universal Public Domain Dedication, (c) Jonas Oxenbøll Petersen -->            
        <g fill="#D465A7">
            <path d="M199 370c-31 0-55 15-51 35 5 21 41 36 84 36 17 0 34-1 48-4 6-35-23-67-81-67zm125-206c-8 12-14 26-15 42-2 20 7 34 19 34 9 0 15-9 17-20s4-35-21-56z"/>
            <path d="M274 0a274 274 0 1 0 0 548 274 274 0 0 0 0-548zm143 109c-3 11-12 17-21 17-16 0-32 6-47 16a82 82 0 0 1 22 78c-4 24-24 46-47 46-25 0-45-23-43-60 1-17 7-37 16-52l-24-3c-71 0-101 45-97 82 4 38 36 52 86 70 49 17 106 37 92 91-6 23-27 42-60 51a69 69 0 0 1-47 38c-5 0-8-2-8-5 0-2 1-4 5-5 11-3 23-11 30-23a308 308 0 0 1-42 3c-50 0-96-18-103-48-7-28 22-52 68-52 63 0 105 36 101 78 19-7 33-21 36-37 8-37-26-53-80-71-47-15-96-31-105-90-8-54 32-118 126-118 18 0 33 4 46 8 23-21 52-35 84-35 9 0 15 9 12 21z"/>
        </g>
    </symbol>
    <symbol id="text-p5js" viewBox="0 0 202 202">
        <!-- License: Creative Commons CC0 1.0 Universal Public Domain Dedication, (c) Jonas Oxenbøll Petersen -->            
        <g fill="#E83B71">
            <path d="M0 0v202h202V0H0zm66 157c-9 5-26 6-35-6v38H16V98h14v9l1-1c16-17 42-11 49 11 4 16-1 33-14 40zm62 2c-14 5-31 2-39-10l-2-2 11-10c3 7 8 11 16 12 12 0 20-9 18-21-2-9-8-14-17-15l-12 1-12 4 1-48h51v13h-36l-1 18c7 1 14 0 20 2 13 3 20 12 21 25 1 14-6 26-19 31zm56-66-5 4-6-8-6 7-5-4 6-7-9-3 2-7 9 3v-9h6v9l9-2 2 6-8 3 5 8z"/>
            <path d="M45 109c-10 2-17 13-14 24 2 10 10 16 20 15 9-1 15-9 15-20 0-12-9-21-21-19z"/>
        </g>
    </symbol>
    <symbol id="image-svg-xml" viewBox="0 0 966 966">
        <!-- License: Creative Commons CC0 1.0 Universal Public Domain Dedication, (c) Jonas Oxenbøll Petersen -->            
        <path fill="#000100" d="M825 0H141C63 0 0 63 0 141v684c0 78 63 141 141 141h684c78 0 141-63 141-141V141C966 63 903 0 825 0z"/>
        <path fill="#FAAE3C" d="M659 217a34 34 0 0 0-48 0h-70l49-49a34 34 0 1 0-34-34l-49 49v-69a34 34 0 1 0-48 0v69l-49-49a34 34 0 1 0-34 34l49 49h-70a34 34 0 1 0 0 49h70l-49 49a34 34 0 1 0 34 34l49-49v69a34 34 0 1 0 48 0v-69l49 49a34 34 0 1 0 34-34l-49-49h70a34 34 0 1 0 48-49z"/>
        <path fill="#FFF" d="M144 687a125 125 0 0 1 89-213c69 0 125 56 125 125h-74a52 52 0 1 0-88 36c9 10 17 13 37 16 34 3 65 14 88 36a125 125 0 0 1-88 214c-69 0-126-56-126-125h74a52 52 0 1 0 88-37c-9-9-23-12-36-15-34-5-66-14-89-37zm464-213-88 427h-74l-88-427h73l52 250 52-250h73zm125 177h126v125a125 125 0 0 1-251 0V599a125 125 0 0 1 251 0h-74a52 52 0 0 0-103 0v177a52 52 0 0 0 103 0v-52h-52v-73z"/>
    </symbol>        
    <symbol id="text-ruby" viewBox="0 0 384.9 369">
        <!-- License: Creative Commons CC0 1.0 Universal Public Domain Dedication, (c) Jonas Oxenbøll Petersen -->            
        <path fill="#D5181D" d="M274 223 106 331l254 35-86-143zM384 63l-23 34-77 116c-1 3-3 4-1 8l74 123 13 19 15-299-1-1zM44 191c1 2 4 2 6 2l71-36c8-5 13-12 20-18l65-60 4-4 23-46-28-10c-1-1-3 0-4 1l-63 36c-10 6-18 15-27 24a3253 3253 0 0 0-53 52l-30 43 16 16zm88-19L96 323l168-108-132-43zm94-84 49 118 94-142-143 24zm-92 74 130 42-49-117-81 75zm-88 59L1 329l86-2-41-106zm42 81 1-1 32-131-69 36 36 96zM352 57l-42-11-59-16c-3-1-5-1-6 2l-21 43-1 2 129-19v-1zm-80-33 112 31-18-53-94 21v1zm34 344-93-13-115-15c-14-2-28-1-43 0a2033 2033 0 0 0-38 2l288 27 1-1zM3 296l37-86c1-3 1-5-2-7l-15-17L0 300h1l2-3zM247 17l63-15 4-1V0l-91 12c9 4 15 7 24 5z"/>
    </symbol>
    <symbol id="model-vnd.usda" viewBox="0 0 20 22.72">
      <g>
        <path d="m13.88,22.72V7.31L0,2.54v15.43l13.88,4.75Zm-11.34-6.69V6.36l8.69,2.96v9.67l-8.69-2.96Z" fill="#208ecd" stroke-width="0"/>
        <path d="m3.55,15.19l6.63,2.27v-7.31l-6.63-2.27v7.31Z" fill="#7dd1f6" stroke-width="0"/>
        <path d="m17.85,11.19l2.15.75V2.72L12.09,0v2.33l5.76,2v6.87Z" fill="#7dd1f6" stroke-width="0"/>
        <path d="m5.97,1.19v2.33l8.78,3.04v9.94l2.15.72V4.96L5.97,1.19Z" fill="#35c3f1" stroke-width="0"/>
      </g>
    </symbol>
        
    <symbol id="application-x-lua" viewBox="0 0 946.5 946.5">
        <!-- License:
            Copyright © 1998 Lua.org. Graphic design by Alexandre Nakonechnyj.

            Permission is hereby granted, without written agreement and without license or royalty fees, to use, copy, and distribute this logo for any purpose, including commercial applications, subject to the following conditions:
           
            The origin of this logo must not be misrepresented; you must not claim that you drew the original logo.
            The only modification you can make is to adapt the orbiting text to your product name.
            The logo can be used in any scale as long as the relative proportions of its elements are maintained. 
        -->
        <path fill="navy" d="M835 473a362 362 0 1 0-724 1 362 362 0 0 0 724-1"/>
        <path fill="#fff" d="M729 323a106 106 0 1 0-212 0 106 106 0 0 0 212 0"/>
        <path fill="navy" d="M941 111a106 106 0 1 0-212 0 106 106 0 0 0 212 0"/>
        <path fill="#fff" d="M258 628h117v26H228V417h30zm257 26v-24c-16 23-32 32-57 32-33 0-54-18-54-47V484h27v120c0 21 14 34 35 34 28 0 47-23 47-58v-96h27v170zm223 5-18 3c-18 0-27-8-28-25a81 81 0 0 1-58 25c-35 0-56-20-56-51 0-22 10-37 30-45 10-5 16-6 54-11 22-2 29-7 29-19v-7c0-16-14-25-39-25s-37 9-40 30h-27c1-17 4-27 12-35 11-13 32-20 56-20 42 0 65 16 65 46v101c0 8 5 13 14 13l6-1zm-47-89c-10 4-15 5-44 9s-41 14-41 32c0 17 12 27 33 27 16 0 30-5 41-15 8-8 11-13 11-23z"/>
        <path fill="none" stroke="gray" stroke-dasharray="40.8" stroke-miterlimit="10" stroke-width="10.9" d="M890 261A468 468 0 1 1 709 69"/>
    </symbol>
    
    <defs>
        <linearGradient id="application-json-linearGradient8385">
            <stop offset="0"/>
            <stop stop-color="#fff" offset="1"/>
        </linearGradient>
        <linearGradient id="application-json-linearGradient3002" x1="-553.27" x2="-666.12" y1="525.91" y2="413.05" gradientTransform="matrix(.99884 0 0 .9987 689.01 -388.84)" gradientUnits="userSpaceOnUse" xlink:href="#application-json-linearGradient8385"/>
        <linearGradient id="application-json-linearGradient3005" x1="-666.12" x2="-553.27" y1="413.04" y2="525.91" gradientTransform="matrix(.99884 0 0 .9987 689.01 -388.84)" gradientUnits="userSpaceOnUse" xlink:href="#application-json-linearGradient8385"/>
    </defs>            
    <symbol id="application-json" viewBox="0 0 160 160">
        <!-- License:
            Douglas Crockford
            This logo image consists only of simple geometric shapes or text. It does not meet the threshold of originality needed for copyright protection, and is therefore in the public domain. Although it is free of copyright restrictions, this image may still be subject to other restrictions - Wikimedia Commons
        -->
        <path d="m79.865 119.1c35.398 48.255 70.04-13.469 69.989-50.587-0.0602-43.886-44.541-68.414-70.018-68.414-40.892 0-79.836 33.796-79.836 80.036 0 51.396 44.64 79.865 79.836 79.865-7.9645-1.1468-34.506-6.834-34.863-67.967-0.23987-41.347 13.488-57.866 34.805-50.599 0.47743 0.17707 23.514 9.2645 23.514 38.951 0 29.56-23.427 38.715-23.427 38.715z" color="#000000" fill="url(#application-json-linearGradient3005)" fill-rule="evenodd"/>
        <path d="m79.823 41.401c-23.39-8.0619-52.043 11.216-52.043 49.829 0 63.048 46.721 68.77 52.384 68.77 40.892 0 79.836-33.796 79.836-80.036 0-51.396-44.64-79.865-79.836-79.865 9.7481-1.35 52.541 10.55 52.541 69.037 0 38.141-31.953 58.905-52.735 50.033-0.47743-0.17707-23.514-9.2645-23.514-38.951 0-29.56 23.367-38.818 23.367-38.818z" color="#000000" fill="url(#application-json-linearGradient3002)" fill-rule="evenodd"/>
    </symbol>

    <defs>
        <linearGradient id="text-python-b" x1="89.1" x2="147.8" y1="111.9" y2="168.1" gradientUnits="userSpaceOnUse">
            <stop offset="0" stop-color="#ffe052"/>
            <stop offset="1" stop-color="#ffc331"/>
        </linearGradient>
        <linearGradient id="text-python-a" x1="55.5" x2="110.2" y1="77.1" y2="131.8" gradientUnits="userSpaceOnUse">
            <stop offset="0" stop-color="#387eb8"/>
            <stop offset="1" stop-color="#366994"/>
        </linearGradient>
    </defs>
    <symbol id="text-python" viewBox="0 0 110.4 109.8">
        <!-- License:  
            https://www.python.org/psf/trademarks/
            Use of Python Two-Snakes trademarked logo (version 1.5.0):

            [...] stating accurately that software is written in the Python programming language, 
        that it is compatible with the Python programming language, or that it contains the Python 
        programming language, is always allowed. In those cases, you may use the word "Python" 
        or the unaltered logos to indicate this, without our prior approval. This is true 
        both for non-commercial and commercial uses.

        This clause overrides other clauses of this policy

            [...]-->        

        <g color="#000">
            <path fill="url(#text-python-a)" d="M100 67c-28 0-27 13-27 13l1 12h26v4H63s-18-2-18 26c0 29 16 28 16 28h9v-14s-1-15 15-15h27s15 0 15-15V82s2-15-27-15zm-15 9a5 5 0 1 1 0 10 5 5 0 0 1 0-10z" transform="translate(-45 -67)"/>
            <path fill="url(#text-python-b)" d="M101 177c28 0 26-12 26-12v-12h-27v-4h37s18 2 18-26c0-29-15-28-15-28h-10v13s1 16-15 16H88s-14 0-14 14v25s-3 14 27 14zm14-8a5 5 0 1 1 0-10 5 5 0 0 1 0 10z" transform="translate(-45 -67)"/>
        </g>            
</svg>

            </div>
            <div class="package" id="WebstrateIcons">
                <script id="descriptor-script" type="descriptor">
{
    "friendlyName": "Webstrates Default Icon Set",
    "description": "Provides Icons for Webstrate features",
    "dependencies": [
        "#wsc-icon-registry"
    ],
    "assets": [],
    "version": "0.1",
    "license": "Apache 2.0 + CC-BY",
    "changelog": {
        "0.1": "Initial version"
    }
}

</script>

                <script id="WSIconProvider-script" type="disabled">
/**
 *  WSIconProvider
 *  A provider for webstrates icons
 * 
 *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/

/**
 * A provider for webstrates icons
 */
window.WSIconProvider = class WSIconProvider {
    constructor(){
        this.supportedTypes = [
            "webstrates:logo",
            "webstrates:wpm-package-open",
            "webstrates:wpm-package-closed",
            "webstrates:cauldron",
            "webstrates:codestrates",
            "webstrates:components",
            "webstrates:varv"
        ];
    }
    
    provides(iconIdentifier){
        return this.supportedTypes.includes(iconIdentifier);
    }
    
    createIcon(iconIdentifier) {
            let icon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            let link = document.createElementNS('http://www.w3.org/2000/svg', 'use');
            link.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', '#'+iconIdentifier.replace(/webstrates:/g, '')+"-icon");
            icon.appendChild(link);
            return icon;
    }
};

IconRegistry.registerProvider(new WSIconProvider());

</script>

                <?xml version="1.0" encoding="utf-8"?>
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
     viewBox="0 0 595.3 841.9" enable-background="new 0 0 595.3 841.9" xml:space="preserve">
    <symbol id="logo-icon" viewBox="0 0 265.000000 265.000000" preserveAspectRatio="xMidYMid meet">
        <!-- License:
            Copyright (c) 2020, 2021 Jonas Oxenbøll Petersen, CAVI - Center for Advanced Visualization and Interaction, Aarhus University
            Distributed under Creative Commons Attribution 4.0 (CC-BY-4.0)
        -->        
    <g transform="translate(0.000000,265.000000) scale(0.100000,-0.100000)"
    fill="currentColor" stroke="none">
    <path d="M407 2300 c-119 -42 -177 -101 -177 -180 0 -45 0 -46 120 -153 41
    -38 42 -40 36 -87 -10 -75 -69 -251 -186 -555 -173 -449 -173 -450 -178 -593
    -5 -145 8 -190 70 -258 53 -57 108 -77 196 -72 126 7 265 94 471 293 63 60
    147 150 187 198 l74 88 0 -83 c1 -157 49 -304 129 -390 129 -140 376 -156 607
    -40 336 170 658 570 798 992 58 174 68 246 64 442 -3 165 -4 176 -31 233 -62
    132 -123 176 -252 183 -130 7 -231 -31 -282 -107 -29 -43 -31 -108 -4 -142 57
    -73 87 -169 101 -318 16 -172 -18 -337 -110 -528 -94 -197 -228 -355 -354
    -414 -152 -72 -228 -10 -228 186 0 179 53 341 234 719 95 196 111 237 115 290
    4 52 2 66 -19 95 -12 19 -40 43 -60 53 -48 25 -166 34 -240 19 -100 -21 -111
    -34 -233 -269 -137 -264 -256 -458 -399 -649 -104 -139 -338 -395 -350 -382
    -8 8 69 222 182 505 218 547 249 723 145 843 -18 22 -59 52 -91 67 -49 24 -72
    28 -167 31 -92 3 -120 0 -168 -17z m317 -60 c27 -14 63 -42 80 -64 31 -37 31
    -40 30 -144 -1 -136 -23 -208 -186 -622 -140 -354 -201 -530 -196 -568 2 -22
    9 -28 35 -30 27 -3 43 8 128 90 250 239 482 577 732 1068 70 138 87 151 204
    158 96 6 162 -11 190 -47 39 -49 25 -102 -98 -357 -182 -377 -228 -523 -228
    -724 0 -115 2 -130 26 -175 14 -28 41 -61 60 -73 29 -21 43 -23 95 -19 232 18
    509 376 588 761 22 103 20 269 -3 381 -17 84 -67 205 -91 220 -5 3 -10 21 -10
    40 0 45 37 87 101 115 44 18 66 21 140 18 78 -3 92 -6 131 -33 53 -38 103
    -126 117 -211 89 -510 -334 -1265 -852 -1520 -110 -53 -176 -67 -291 -62 -145
    8 -239 64 -295 177 -43 86 -52 120 -64 268 l-12 138 -30 3 c-27 2 -38 -7 -99
    -83 -86 -105 -288 -304 -381 -374 -192 -145 -329 -163 -422 -57 -80 90 -83
    228 -9 441 24 72 81 225 126 340 101 258 165 446 185 542 21 102 10 129 -81
    203 -53 42 -64 56 -64 81 0 42 15 65 59 93 71 45 118 56 231 53 90 -2 113 -6
    154 -27z"/>
    </g>
    </symbol>
    <symbol id="wpm-package-open-icon" viewBox="0 0 195 195" enable-background="new 0 0 195 195" xml:space="preserve">
        <!-- License:
            Copyright (c) 2020, 2021 Jonas Oxenbøll Petersen, CAVI - Center for Advanced Visualization and Interaction, Aarhus University
            Distributed under Creative Commons Attribution 4.0 (CC-BY-4.0)
        -->        
        
            <g>
                <polygon fill="#8C6239" points="35.9,45.1 83.6,72.2 86.5,163.7 42,121.1 	"/>
                <polygon fill="#C69C6D" points="163.2,51.3 155.1,132.7 86.5,163.7 83.6,72.2 	"/>
                <g id="izg6T3.tif_6_">
                        <g>
                                <path fill="#298158" d="M129.2,125.9c-1.2,0.2-2.5,0.6-3.7,0.6c-2.5,0.1-4-1.4-5-3.6c-0.7-1.6-1.1-3.5-1.7-5.5
                                        c-0.8,1.8-1.6,3.5-2.4,5.2c-2.3,4.8-4.8,9.4-8.1,13.6c-3.5,4.2-7.4,5.2-9.6,2.2c-1-1.4-1.7-3.5-1.7-5.6c0.2-5.4,1-11,1.5-16.8
                                        c0.4-4.2,0.6-8.6,0.8-13c0.1-1.7-0.7-2.5-2.1-2.8c-0.3-0.1-0.6-0.2-1-0.3c-3.3-0.8-3.8-2.7-1.7-6.4c2.9-5,11.6-8.8,14.8-5.1
                                        c1.8,2,2,4.9,1.7,7.6c-0.7,7.4-1.8,14.6-2.6,21.5c-0.4,2.9-0.6,5.7-1,8.5c0.2,0,0.4,0,0.5,0c0.9-1.7,1.9-3.3,2.7-5.1
                                        c4.6-9.8,7.8-20.1,10.2-31.2c0.3-1.2,0.4-2.6,0.9-3.7c0.6-1.3,1.3-3,2.2-3.7c1.8-1.3,3.9-2.6,5.8-2.9c2.6-0.5,3.6,1.7,2.8,5
                                        c-1,4.5-2.2,9-3.1,13.3c-1.2,5.5-2.2,10.9-1.2,15.5c0.2,0.8,0.6,1.5,1,2c0.7,1,1.7,0.8,2.9-0.3c2.6-2.3,4.2-5.3,5.6-8.5
                                        c2.7-6.6,4.2-13.3,3.5-19.9c-0.3-3.3-1-6.5-3-8.8c-1.5-1.7-0.3-5.7,2.4-7.9c4.9-4.1,8-3.2,9.7,2.4c1.3,5.6,0.4,10.2,0.4,10.7
                                        c-0.7,6.9-2.5,13.5-5.2,20c-2.5,6-5.3,11.6-9.4,16.4c-1.6,1.9-3.4,3.5-5.2,5.3C130.6,125.1,129.9,125.5,129.2,125.9z M150.5,76.9
                                        c-0.2-1-0.4-2.7-0.9-4.4c-1.2-4.6-5.2-5.1-8.8-1.1c-1.9,2.2-2.3,4.3-1,5.9c1.7,2.1,2.3,4.9,2.7,7.9c0.6,4.5,0.1,9.1-1.1,13.8
                                        c-1.4,5.5-3.3,10.8-7,15.2c-2.5,3-4.7,3.7-6.1,0.9c-0.5-1-0.8-2.2-0.9-3.5c-0.2-4.3,0.4-9,1.5-13.7c0.9-4.4,2.1-8.8,3.2-13.4
                                        c0.6-2.7,0-4.2-2-4c-1.5,0.2-3.1,1.1-4.6,2c-1.4,0.9-2.1,2.6-2.5,4.4c-1.6,6.2-3.1,12.3-5,18.2c-1.5,4.7-3.3,9.3-5.1,13.8
                                        c-1.1,2.6-2.5,5.1-3.9,7.5c-0.3,0.5-1,0.8-1.5,1.2c-0.1-0.5-0.5-0.9-0.4-1.5c0.8-6.7,1.7-13.7,2.4-20.9c0.4-4.2,0.6-8.5,0.7-12.8
                                        c0-2.1-1-3.7-2.9-4.1c-3.5-0.8-6.8,0.9-9.9,3.7c-1.3,1.2-2.5,2.7-2.3,4.6c0.1,1.9,1.9,2,3.2,2.3c1.9,0.4,2.7,1.7,2.7,3.8
                                        c0,1.8,0,3.6-0.2,5.3c-0.6,6.1-1.3,12-2,17.7c-0.4,3.9-0.8,7.7,0.5,10.9c1,2.5,4.6,3.2,7.2,0.6c3.8-3.8,6-8.4,8.5-13
                                        c1.2-2.3,2.1-4.7,3.2-7.1c0.2-0.5,0.8-1.1,1.2-1.2c0.3-0.1,0.7,0.5,0.8,0.9c0.4,1.3,0.6,2.7,1,4c1.9,5.9,6,6,11.3,1.8
                                        c3.4-2.6,5.9-6.4,8.2-10.4c2.8-4.8,5-9.9,6.8-15.3C149.3,90.8,150.5,84.3,150.5,76.9z"/>
                                <path fill="#31A36E" d="M150.5,76.9c0.1,7.4-1.2,13.8-3.2,20.2c-1.7,5.4-4,10.5-6.8,15.3c-2.3,4-4.9,7.8-8.2,10.4
                                        c-5.3,4.1-9.4,4-11.3-1.8c-0.4-1.3-0.6-2.7-1-4c-0.1-0.4-0.5-0.9-0.8-0.9c-0.4,0.1-0.9,0.7-1.2,1.2c-1.1,2.4-2,4.8-3.2,7.1
                                        c-2.5,4.6-4.7,9.2-8.5,13c-2.6,2.6-6.2,1.9-7.2-0.6c-1.2-3.2-0.9-7-0.5-10.9c0.6-5.7,1.3-11.6,2-17.7c0.2-1.8,0.2-3.6,0.2-5.3
                                        c0-2-0.8-3.4-2.7-3.8c-1.3-0.3-3-0.3-3.2-2.3c-0.1-1.8,1-3.4,2.3-4.6c3.1-2.8,6.4-4.5,9.9-3.7c1.9,0.4,3,2,2.9,4.1
                                        c0,4.3-0.3,8.6-0.7,12.8c-0.7,7.2-1.7,14.2-2.4,20.9c-0.1,0.5,0.3,1,0.4,1.5c0.5-0.4,1.2-0.7,1.5-1.2c1.4-2.5,2.9-4.9,3.9-7.5
                                        c1.9-4.5,3.7-9.1,5.1-13.8c1.8-5.9,3.3-11.9,5-18.2c0.5-1.8,1.1-3.6,2.5-4.4c1.5-0.9,3.1-1.9,4.6-2c2.1-0.3,2.7,1.3,2,4
                                        c-1.1,4.6-2.2,9-3.2,13.4c-1,4.8-1.7,9.4-1.5,13.7c0.1,1.3,0.4,2.5,0.9,3.5c1.5,2.8,3.6,2.1,6.1-0.9c3.8-4.4,5.6-9.7,7-15.2
                                        c1.2-4.7,1.7-9.3,1.1-13.8c-0.4-3-1-5.8-2.7-7.9c-1.3-1.6-0.9-3.8,1-5.9c3.6-4,7.6-3.5,8.8,1.1C150,74.2,150.3,76,150.5,76.9z"/>
                        </g>
                </g>
                <polygon fill="#754C24" points="105.9,31.3 107.3,66 83.6,72.2 35.9,45.1 	"/>
                <polygon fill="#603813" points="163.2,51.3 107.3,66 105.9,31.3 	"/>
                <polygon fill="#A67C52" points="35.9,45.1 83.6,72.2 42.3,103.8 0.9,67.4 	"/>
                <polygon fill="#A67C52" points="105.9,31.3 35.9,45.1 17.2,25.2 86.5,16.5 	"/>
                <polygon fill="#A67C52" points="163.2,51.3 105.9,31.3 130.3,8.9 190.1,21.8 	"/>
                <polygon fill="#A67C52" points="83.6,72.2 163.2,51.3 193.2,81.2 111.8,112.5 	"/>
            </g>
    </symbol>
    <symbol id="wpm-package-closed-icon" viewBox="0 0 195 195" enable-background="new 0 0 195 195" xml:space="preserve">
        <!-- License:
            Copyright (c) 2020, 2021 Jonas Oxenbøll Petersen, CAVI - Center for Advanced Visualization and Interaction, Aarhus University
            Distributed under Creative Commons Attribution 4.0 (CC-BY-4.0)
        -->        
        <g>
                <polygon fill="#8C6239" points="35.8,45.1 83.5,72.2 86.5,163.7 41.9,121.1 	"/>
                <polygon fill="#C69C6D" points="163.2,51.3 155,132.7 86.5,163.7 83.5,72.2 	"/>
                <polygon fill="#A67C52" points="104.9,31.3 163.2,51.3 83.5,72.2 35.8,45.1 	"/>
                <g id="izg6T3.tif_3_">
                        <g>
                                <path fill="#298158" d="M129.1,125.9c-1.2,0.2-2.5,0.6-3.7,0.6c-2.5,0.1-4-1.4-5-3.6c-0.7-1.6-1.1-3.5-1.7-5.5
                                        c-0.8,1.8-1.6,3.5-2.4,5.2c-2.3,4.8-4.8,9.4-8.1,13.6c-3.5,4.2-7.4,5.2-9.6,2.2c-1-1.4-1.7-3.5-1.7-5.6c0.2-5.4,1-11,1.5-16.8
                                        c0.4-4.2,0.6-8.6,0.8-13c0.1-1.7-0.7-2.5-2.1-2.8c-0.3-0.1-0.6-0.2-1-0.3c-3.3-0.8-3.8-2.7-1.7-6.4c2.9-5,11.6-8.8,14.8-5.1
                                        c1.8,2,2,4.9,1.7,7.6c-0.7,7.4-1.8,14.6-2.6,21.5c-0.4,2.9-0.6,5.7-1,8.5c0.2,0,0.4,0,0.5,0c0.9-1.7,1.9-3.3,2.7-5.1
                                        c4.6-9.8,7.8-20.1,10.2-31.2c0.3-1.2,0.4-2.6,0.9-3.7c0.6-1.3,1.3-3,2.2-3.7c1.8-1.3,3.9-2.6,5.8-2.9c2.6-0.5,3.6,1.7,2.8,5
                                        c-1,4.5-2.2,9-3.1,13.3c-1.2,5.5-2.2,10.9-1.2,15.5c0.2,0.8,0.6,1.5,1,2c0.7,1,1.7,0.8,2.9-0.3c2.6-2.3,4.2-5.3,5.6-8.5
                                        c2.7-6.6,4.2-13.3,3.5-19.9c-0.3-3.3-1-6.5-3-8.8c-1.5-1.7-0.3-5.7,2.4-7.9c4.9-4.1,8-3.2,9.7,2.4c1.3,5.6,0.4,10.2,0.4,10.7
                                        c-0.7,6.9-2.5,13.5-5.2,20c-2.5,6-5.3,11.6-9.4,16.4c-1.6,1.9-3.4,3.5-5.2,5.3C130.5,125.1,129.8,125.5,129.1,125.9z M150.4,76.9
                                        c-0.2-1-0.4-2.7-0.9-4.4c-1.2-4.6-5.2-5.1-8.8-1.1c-1.9,2.2-2.3,4.3-1,5.9c1.7,2.1,2.3,4.9,2.7,7.9c0.6,4.5,0.1,9.1-1.1,13.8
                                        c-1.4,5.5-3.3,10.8-7,15.2c-2.5,3-4.7,3.7-6.1,0.9c-0.5-1-0.8-2.2-0.9-3.5c-0.2-4.3,0.4-9,1.5-13.7c0.9-4.4,2.1-8.8,3.2-13.4
                                        c0.6-2.7,0-4.2-2-4c-1.5,0.2-3.1,1.1-4.6,2c-1.4,0.9-2.1,2.6-2.5,4.4c-1.6,6.2-3.1,12.3-5,18.2c-1.5,4.7-3.3,9.3-5.1,13.8
                                        c-1.1,2.6-2.5,5.1-3.9,7.5c-0.3,0.5-1,0.8-1.5,1.2c-0.1-0.5-0.5-0.9-0.4-1.5c0.8-6.7,1.7-13.7,2.4-20.9c0.4-4.2,0.6-8.5,0.7-12.8
                                        c0-2.1-1-3.7-2.9-4.1c-3.5-0.8-6.8,0.9-9.9,3.7c-1.3,1.2-2.5,2.7-2.3,4.6c0.1,1.9,1.9,2,3.2,2.3c1.9,0.4,2.7,1.7,2.7,3.8
                                        c0,1.8,0,3.6-0.2,5.3c-0.6,6.1-1.3,12-2,17.7c-0.4,3.9-0.8,7.7,0.5,10.9c1,2.5,4.6,3.2,7.2,0.6c3.8-3.8,6-8.4,8.5-13
                                        c1.2-2.3,2.1-4.7,3.2-7.1c0.2-0.5,0.8-1.1,1.2-1.2c0.3-0.1,0.7,0.5,0.8,0.9c0.4,1.3,0.6,2.7,1,4c1.9,5.9,6,6,11.3,1.8
                                        c3.4-2.6,5.9-6.4,8.2-10.4c2.8-4.8,5-9.9,6.8-15.3C149.2,90.8,150.4,84.3,150.4,76.9z"/>
                                <path fill="#31A36E" d="M150.4,76.9c0.1,7.4-1.2,13.8-3.2,20.2c-1.7,5.4-4,10.5-6.8,15.3c-2.3,4-4.9,7.8-8.2,10.4
                                        c-5.3,4.1-9.4,4-11.3-1.8c-0.4-1.3-0.6-2.7-1-4c-0.1-0.4-0.5-0.9-0.8-0.9c-0.4,0.1-0.9,0.7-1.2,1.2c-1.1,2.4-2,4.8-3.2,7.1
                                        c-2.5,4.6-4.7,9.2-8.5,13c-2.6,2.6-6.2,1.9-7.2-0.6c-1.2-3.2-0.9-7-0.5-10.9c0.6-5.7,1.3-11.6,2-17.7c0.2-1.8,0.2-3.6,0.2-5.3
                                        c0-2-0.8-3.4-2.7-3.8c-1.3-0.3-3-0.3-3.2-2.3c-0.1-1.8,1-3.4,2.3-4.6c3.1-2.8,6.4-4.5,9.9-3.7c1.9,0.4,3,2,2.9,4.1
                                        c0,4.3-0.3,8.6-0.7,12.8c-0.7,7.2-1.7,14.2-2.4,20.9c-0.1,0.5,0.3,1,0.4,1.5c0.5-0.4,1.2-0.7,1.5-1.2c1.4-2.5,2.9-4.9,3.9-7.5
                                        c1.9-4.5,3.7-9.1,5.1-13.8c1.8-5.9,3.3-11.9,5-18.2c0.5-1.8,1.1-3.6,2.5-4.4c1.5-0.9,3.1-1.9,4.6-2c2.1-0.3,2.7,1.3,2,4
                                        c-1.1,4.6-2.2,9-3.2,13.4c-1,4.8-1.7,9.4-1.5,13.7c0.1,1.3,0.4,2.5,0.9,3.5c1.5,2.8,3.6,2.1,6.1-0.9c3.8-4.4,5.6-9.7,7-15.2
                                        c1.2-4.7,1.7-9.3,1.1-13.8c-0.4-3-1-5.8-2.7-7.9c-1.3-1.6-0.9-3.8,1-5.9c3.6-4,7.6-3.5,8.8,1.1C149.9,74.2,150.2,76,150.4,76.9z"
                                        />
                        </g>
                </g>
        </g>
    </symbol>
    <symbol id="cauldron-icon" viewBox="0 0 121.1 121.1" enable-background="new 0 0 121.1 121.1" xml:space="preserve">
        <!-- License:
            Copyright (c) 2020, 2021 Jonas Oxenbøll Petersen, CAVI - Center for Advanced Visualization and Interaction, Aarhus University
            Distributed under Creative Commons Attribution 4.0 (CC-BY-4.0)
        -->        
        <path fill="none" stroke="currentColor" stroke-width="12" stroke-miterlimit="10" d="M102.4,36.5v60.9c0,9.7-9.1,17.6-20.3,17.6H39.8
                c-11.2,0-20.3-7.9-20.3-17.6V36.5"/>
        <path d="M83.6,29.9c-2.2,4.4-5.1,7.5-8.6,10.1c-3,2.2-6.2,4-9.8,5.1c-2.9,1-6,1.6-9,0.9c-4.7-1.2-6.9-4.2-5.4-9.2
                c0.3-1,0.8-2.1,1.1-3.1c0.1-0.3,0.1-0.9-0.1-1c-0.2-0.2-0.8-0.2-1.1-0.1c-1.5,0.7-3,1.6-4.6,2.1c-3.2,1.1-6.4,2.4-9.9,2.2
                c-2.4-0.2-3.8-3-3-5.1c0.9-2.6,2.8-4.5,4.7-6.4c2.7-2.7,5.4-5.3,8.1-8c0.8-0.8,1.5-1.6,2.1-2.5c0.8-1,0.9-2,0.2-3.2
                c-0.5-0.8-1.2-1.7-0.6-2.6c0.6-0.9,1.7-1,2.7-0.9c2.4,0.2,4.5,1.1,5.8,3.2c0.7,1.2,0.7,2.4,0,3.4c-1.6,2.1-3.2,4.1-5,6
                c-3.2,3.4-6.5,6.6-9.7,9.9c-0.3,0.3-0.3,0.7-0.5,1.1c0.4,0.1,0.9,0.4,1.2,0.3c1.7-0.5,3.5-1,5.1-1.8c2.8-1.4,5.5-2.9,8.1-4.6
                c3.1-2.1,6.1-4.4,9.1-6.7c0.9-0.7,1.8-1.2,2.8-0.8c1.1,0.4,2.3,0.8,3.1,1.5c1.2,1,1.1,2.2-0.2,3.2c-2.1,1.8-4.3,3.5-6.4,5.4
                c-2.3,2.1-4.4,4.4-6,7.1c-0.5,0.8-0.8,1.8-0.9,2.8c-0.3,2.8,1.2,3.9,3.8,3.7c3.9-0.2,7-2.3,9.9-4.7c2.4-2,4.2-4.5,5.3-7.5
                c0.7-1.9,1.3-3.9,0.9-6c-0.3-1.6,0.6-2.5,2.4-2.6c3.3-0.1,5.5,2.5,5,5.8C84.1,28.1,83.8,29.2,83.6,29.9z"/>
        <path d="M53.1,64.3c0.4,1.5,0.3,2.9,0.1,4.2c-0.3,1.2-0.7,2.3-1.3,3.3c-0.5,0.9-1.1,1.7-2,2.1c-1.4,0.7-2.6,0.4-3.3-1.1
                c-0.1-0.3-0.2-0.7-0.4-1c0-0.1-0.2-0.2-0.2-0.2c-0.1,0-0.2,0.1-0.3,0.2c-0.2,0.5-0.4,1-0.7,1.5c-0.5,0.9-1,1.9-1.9,2.6
                c-0.6,0.5-1.5,0.1-1.8-0.6c-0.3-0.8-0.3-1.7-0.2-2.5c0.1-1.2,0.2-2.4,0.3-3.7c0-0.3,0-0.7,0-1.1c0-0.4-0.2-0.7-0.6-0.8
                c-0.3-0.1-0.6-0.1-0.7-0.5c0-0.3,0.2-0.6,0.5-0.8c0.6-0.4,1.3-0.7,2.1-0.4c0.4,0.1,0.7,0.4,0.7,0.8c0.1,0.8,0.1,1.7,0,2.5
                c-0.1,1.5-0.2,3-0.2,4.4c0,0.1,0.1,0.2,0.1,0.4c0.1-0.1,0.3-0.1,0.4-0.2c0.3-0.5,0.6-1,0.8-1.5c0.4-0.9,0.7-1.9,1-2.8
                c0.3-1.2,0.5-2.3,0.8-3.5c0.1-0.3,0.2-0.7,0.5-0.8c0.3-0.1,0.7-0.3,1.1-0.3c0.5,0,0.7,0.3,0.6,0.8c-0.1,0.9-0.3,1.8-0.4,2.6
                c-0.1,1-0.1,2,0,3c0.1,0.3,0.2,0.6,0.4,0.9c0.5,0.7,1.1,0.7,1.7,0.1c0.9-0.9,1.2-2,1.4-3.2c0.1-1,0.1-2-0.3-2.9
                c-0.2-0.6-0.5-1.2-1-1.6c-0.4-0.3-0.4-0.7,0-1.1c0.8-0.7,1.9-0.6,2.4,0.3C52.9,63.8,53,64.1,53.1,64.3z"/>
        <path d="M46.9,88.1c0.1,1.6-0.1,2.9-0.6,4.2c-0.4,1.1-1,2.1-1.8,3.1c-0.6,0.8-1.4,1.5-2.3,1.8c-1.5,0.5-2.6,0-3.1-1.6
                c-0.1-0.3-0.1-0.7-0.2-1c0-0.1-0.1-0.3-0.2-0.3c-0.1,0-0.2,0.1-0.3,0.2c-0.3,0.4-0.5,0.9-0.9,1.4c-0.7,0.9-1.3,1.7-2.3,2.3
                c-0.7,0.4-1.5-0.2-1.7-0.9c-0.2-0.9,0-1.7,0.2-2.5c0.3-1.2,0.6-2.4,0.8-3.6c0.1-0.3,0.1-0.7,0.1-1c0-0.4-0.1-0.7-0.5-0.9
                c-0.3-0.1-0.6-0.2-0.6-0.6c0-0.3,0.3-0.6,0.6-0.7c0.7-0.3,1.4-0.5,2.1-0.1c0.4,0.2,0.6,0.5,0.6,0.9c-0.1,0.8-0.2,1.7-0.3,2.5
                c-0.3,1.5-0.6,2.9-0.9,4.3c0,0.1,0,0.3,0.1,0.4c0.1,0,0.3,0,0.4-0.1c0.4-0.4,0.8-0.9,1.1-1.4c0.5-0.8,1-1.7,1.4-2.6
                c0.5-1.1,0.9-2.2,1.3-3.4c0.1-0.3,0.3-0.6,0.6-0.7c0.4-0.1,0.7-0.2,1.1-0.1c0.5,0.1,0.7,0.4,0.5,0.9c-0.3,0.9-0.6,1.7-0.8,2.6
                C41,92,40.8,93,40.9,94c0,0.3,0.1,0.6,0.2,0.9c0.4,0.8,1,0.8,1.7,0.4c1-0.7,1.5-1.8,1.9-3c0.3-1,0.4-1.9,0.2-2.9
                c-0.1-0.6-0.3-1.3-0.8-1.8c-0.4-0.4-0.3-0.8,0.2-1.1c0.9-0.6,1.9-0.3,2.3,0.7C46.7,87.6,46.8,87.9,46.9,88.1z"/>
        <path d="M67.2,84.2c-0.2,1.6-0.7,2.8-1.4,4c-0.6,1-1.4,1.9-2.4,2.6c-0.8,0.6-1.6,1.2-2.6,1.3c-1.6,0.2-2.6-0.5-2.7-2.2
                c0-0.4,0-0.7,0-1.1c0-0.1-0.1-0.3-0.1-0.3c-0.1,0-0.3,0-0.3,0.1c-0.4,0.4-0.7,0.8-1.1,1.2c-0.8,0.7-1.6,1.4-2.7,1.8
                c-0.7,0.2-1.5-0.5-1.5-1.2c0-0.9,0.3-1.7,0.7-2.4c0.5-1.1,1-2.2,1.5-3.3c0.1-0.3,0.3-0.7,0.4-1c0.1-0.4,0-0.7-0.3-1
                c-0.2-0.2-0.6-0.4-0.5-0.7c0.1-0.3,0.4-0.5,0.7-0.6c0.7-0.2,1.5-0.2,2.1,0.3c0.4,0.3,0.5,0.6,0.4,1c-0.2,0.8-0.5,1.6-0.8,2.4
                c-0.6,1.4-1.2,2.7-1.8,4.1c0,0.1,0,0.3,0,0.4c0.1,0,0.3,0,0.4-0.1c0.5-0.4,0.9-0.7,1.3-1.1c0.7-0.7,1.3-1.5,1.9-2.3c0.7-1,1.3-2,2-3
                c0.2-0.3,0.4-0.6,0.7-0.6c0.4,0,0.8,0,1.1,0.1c0.5,0.2,0.6,0.5,0.3,1c-0.4,0.8-0.9,1.5-1.3,2.3c-0.5,0.9-0.8,1.8-1,2.8
                c0,0.3,0,0.6,0,0.9c0.2,0.9,0.8,1,1.6,0.7c1.2-0.5,1.8-1.5,2.4-2.5c0.5-0.9,0.8-1.8,0.8-2.8c0-0.7-0.1-1.3-0.4-1.9
                c-0.3-0.5-0.1-0.8,0.4-1c1-0.4,2,0.1,2.1,1.2C67.2,83.6,67.2,84,67.2,84.2z"/>
        <path d="M84.3,82.9c0.8,1.3,1.2,2.6,1.4,4c0.1,1.2,0.1,2.4-0.2,3.5c-0.2,1-0.5,1.9-1.3,2.6c-1.1,1.1-2.3,1.2-3.4,0
                c-0.2-0.3-0.4-0.6-0.7-0.8c-0.1-0.1-0.2-0.2-0.3-0.2c-0.1,0-0.2,0.2-0.2,0.3c-0.1,0.5-0.1,1.1-0.2,1.6c-0.2,1.1-0.4,2.2-1,3.1
                c-0.4,0.6-1.4,0.5-1.9,0c-0.6-0.7-0.8-1.5-1-2.3c-0.3-1.2-0.6-2.4-0.9-3.6c-0.1-0.3-0.2-0.7-0.3-1c-0.1-0.4-0.4-0.6-0.8-0.6
                c-0.3,0-0.7,0.1-0.8-0.3c-0.1-0.3,0-0.6,0.2-0.9c0.5-0.6,1-1,1.8-1.1c0.4,0,0.8,0.2,0.9,0.6c0.3,0.8,0.6,1.6,0.8,2.4
                c0.4,1.4,0.8,2.9,1.1,4.3c0,0.1,0.2,0.2,0.2,0.3c0.1-0.1,0.3-0.2,0.3-0.3c0.1-0.6,0.3-1.1,0.3-1.7c0.1-1,0.1-2,0.1-3
                c-0.1-1.2-0.2-2.4-0.3-3.6c0-0.3,0-0.7,0.2-0.9c0.3-0.2,0.6-0.5,0.9-0.6c0.5-0.2,0.8,0.1,0.9,0.6c0.1,0.9,0.3,1.8,0.4,2.6
                c0.2,1,0.5,1.9,1,2.8c0.1,0.3,0.4,0.5,0.6,0.7c0.7,0.5,1.3,0.3,1.7-0.4c0.6-1.1,0.5-2.3,0.3-3.5c-0.2-1-0.5-1.9-1.2-2.7
                c-0.4-0.5-0.8-1-1.5-1.2c-0.5-0.2-0.6-0.6-0.3-1.1c0.5-0.9,1.6-1.1,2.4-0.4C83.9,82.5,84.2,82.7,84.3,82.9z"/>
        <path d="M80.8,69.5c-0.4,1.5-1.2,2.7-2.1,3.7c-0.8,0.9-1.7,1.6-2.8,2.2c-0.9,0.5-1.8,0.9-2.8,0.8c-1.6-0.1-2.4-0.9-2.3-2.6
                c0-0.3,0.1-0.7,0.2-1c0-0.1,0-0.3-0.1-0.3c-0.1,0-0.3,0-0.3,0c-0.4,0.3-0.9,0.7-1.3,0.9c-0.9,0.5-1.9,1.1-3,1.3
                c-0.8,0.1-1.4-0.7-1.3-1.4c0.1-0.9,0.6-1.6,1.1-2.3c0.7-1,1.4-2,2.1-3c0.2-0.3,0.4-0.6,0.5-0.9c0.2-0.4,0.2-0.7-0.1-1
                c-0.2-0.2-0.5-0.4-0.3-0.8c0.1-0.3,0.5-0.4,0.8-0.4c0.8-0.1,1.5,0.1,2,0.7c0.3,0.3,0.4,0.7,0.2,1.1c-0.4,0.7-0.8,1.5-1.2,2.2
                c-0.8,1.2-1.6,2.5-2.5,3.7c-0.1,0.1-0.1,0.2-0.1,0.4c0.1,0,0.3,0.1,0.4,0c0.5-0.3,1-0.5,1.5-0.9c0.8-0.6,1.6-1.2,2.3-1.9
                c0.9-0.8,1.7-1.8,2.5-2.6c0.2-0.3,0.5-0.5,0.8-0.4c0.4,0,0.8,0.1,1.1,0.3c0.4,0.3,0.5,0.6,0.1,1c-0.6,0.7-1.1,1.4-1.7,2.1
                c-0.6,0.8-1.1,1.6-1.5,2.6c-0.1,0.3-0.1,0.6-0.1,0.9c0.1,0.9,0.6,1.1,1.4,0.9c1.2-0.3,2.1-1.1,2.8-2.1c0.6-0.8,1.1-1.7,1.2-2.7
                c0.1-0.6,0.2-1.3-0.1-1.9c-0.2-0.5,0-0.8,0.6-0.9c1-0.2,1.9,0.5,1.9,1.5C80.8,68.9,80.8,69.3,80.8,69.5z"/>
        <path fill="none" stroke="currentColor" stroke-width="2" stroke-miterlimit="10" d="M24,55.9c0,0,9.5-4,16-4s12.7,4,20.9,4
                S75.5,52,82.1,52s16,3.9,16,3.9"/>
        <path fill="none" stroke="currentColor" stroke-width="2" stroke-miterlimit="10" d="M32.2,25.1C24,15.3,12.7,14.7,12.7,14.7"/>
        <path fill="none" stroke="currentColor" stroke-width="2" stroke-miterlimit="10" d="M36.2,19.1C24.5,7.8,12.7,7.8,12.7,7.8"/>
        <path fill="none" stroke="currentColor" stroke-width="2" stroke-miterlimit="10" d="M40.2,13.1C28.8,1,12.7,1,12.7,1"/>
    </symbol>
    <symbol id="varv-icon" viewBox="0 0 567 567">
        <!-- License:
            Copyright (c) 2022 Jonas Oxenbøll Petersen, CAVI - Center for Advanced Visualization and Interaction, Aarhus University
            Distributed under Creative Commons Attribution 4.0 (CC-BY-4.0)
        -->        
        <path fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="50" d="M39 56h503M6 147h503M95 238h472M26 329h416M1 420h503M39 511h485"/>
    </symbol>
    <symbol id="codestrates-icon" viewBox="0 0 567 567">
        <!-- License:
            Copyright (c) 2022 Jonas Oxenbøll Petersen, CAVI - Center for Advanced Visualization and Interaction, Aarhus University
            Distributed under Creative Commons Attribution 4.0 (CC-BY-4.0)
        -->        
        <ellipse cx="283.5" cy="250.8" fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="20" rx="270.1" ry="86.3"/><ellipse cx="283.5" cy="316.2" fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="20" rx="270.1" ry="86.3"/><path fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="20" d="M13 251v65M554 251v65"/><path fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="9" d="m262 308-25-25 25-25M305 258l26 25-26 25M291 249l-15 69"/>
    </symbol>
    <symbol id="components-icon" viewBox="0 0 567 567">
        <!-- License:
            Copyright (c) 2022 Jonas Oxenbøll Petersen, CAVI - Center for Advanced Visualization and Interaction, Aarhus University
            Distributed under Creative Commons Attribution 4.0 (CC-BY-4.0)
        -->        
        <path fill="currentColor" d="M335 410c-1 13-4 23-9 33-5 8-11 16-18 23-6 5-12 10-20 11-13 3-21-2-23-16l-1-8-1-3-3 1-8 10c-6 6-13 13-21 16-6 2-12-3-13-9 0-7 2-13 4-20l11-27 2-9c1-3 0-5-3-7-2-2-4-3-4-6 1-3 3-4 6-5 5-2 11-2 17 2 3 2 4 5 3 8l-5 19-12 34v3l3-1 10-9 14-20 14-25c2-3 3-5 6-5h9c4 1 5 4 3 8l-9 19c-3 8-6 15-7 23l1 8c2 7 7 8 13 5 9-5 14-13 18-22 4-8 5-15 5-23-1-6-1-11-4-16-3-3-2-6 3-8 7-4 15 0 17 8l2 8z"/><path fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="20" d="M13 364h541v144H13zM80 326h100v38H80zM385 326h100v38H385z"/><path fill="currentColor" d="M335 144c-1 13-4 24-9 33s-11 16-18 23c-6 5-12 10-20 12-13 2-21-3-23-16l-1-9-1-2c-1-1-2 0-3 1l-8 9c-6 7-13 13-21 16-6 3-12-3-13-8 0-8 2-14 4-21l11-27 2-8c1-3 0-6-3-8-2-1-4-3-4-6 1-2 3-4 6-5 5-2 11-2 17 2 3 2 4 5 3 8l-5 20-12 33v3h3l10-10 14-19 14-26c2-2 3-5 6-5h9c4 1 5 4 3 8l-9 20c-3 7-6 15-7 23l1 7c2 7 7 8 13 5 9-5 14-13 18-22 4-7 5-15 5-23-1-6-1-11-4-15s-2-7 3-9c7-4 15 0 17 8l2 8z"/><path fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="20" d="M13 98h541v144H13zM80 60h100v38H80zM385 60h100v38H385z"/>
    </symbol>
</svg>

            </div>
            <div class="package" id="MaterialDesignOutlinedIcons">
                <script id="descriptor-script" type="descriptor">
{
    "friendlyName": "Icons based on the outlined Material Design icon set",
    "description": "Various icons from Material Design",
    "dependencies": [
        "#wsc-icon-registry",
        "wpm_js_libs #material-design-icons"
    ],
    "assets": [],
    "version": "0.1",
    "changelog": {
        "0.1": "Initial version"
    },
    "license": "Apache 2.0"
}

</script>

                <script id="material-design-outlined-icon-provider-script" type="disabled">
/**
 *  MaterialDesignOutlinedIconProvider
 *  A provider for registering material icons
 * 
 *  Copyright 2020, 2021, 2024 Rolf Bagge, Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/

/**
 * A provider for registering material icons in the outlined variation
 */
window.MaterialDesignOutlinedIconProvider = class MaterialDesignOutlinedIconProvider {
    provides(iconIdentifier){
        return iconIdentifier.startsWith("mdc:");
    }
    
    /**
     * Create a MaterialDesign icon
     * @param {String} iconIdentifier - The id of the icon
     * @returns {HTMLSpanElement} - The created icon
     */
    createIcon(iconIdentifier) {
        let iconName = iconIdentifier.slice(4);
        
        let icon = document.createElement("span");
        icon.classList.add("material-icons-outlined");
        icon.textContent = iconName;
        return icon;
    }
};

IconRegistry.registerProvider(new MaterialDesignOutlinedIconProvider());

</script>

            </div>            
                        
            <div class="package" id="WebstrateComponents_Tools">
                <script id="descriptor-script" type="descriptor">
{
    "friendlyName": "WebstrateComponents Tools",
    "description": "Various tools that are nice to reuse",
    "dependencies": [],
    "assets": [],
    "version": "0.1",
    "license": "Apache 2.0",
    "changelog": {
        "0.1": "Initial version"
    }
}

</script>

                <script id="Tools-script" type="disabled">
/**
 * WebstrateComponents Tools
 * 
 * Ease-of-use tools to help manage WPM package info and templates
 *
 * Copyright 2019, 2020, 2021 Rolf Bagge, Janus Bager Kristensen,
 * CAVI - Center for Advanced Visualisation and Interaction,
 * Aarhus University
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/

/**
 * @namespace WebstrateComponents
 */
window.WebstrateComponents = {};

/**
 * A collection of tools
 * @type {WebstrateComponents.Tools}
 * @hideconstructor
 */
WebstrateComponents.Tools = class Tools {
    /**
     * Tries to extract the entry with the given key from the given config. If key does not exist, returns defaultValue instead.
     * @param {Object} config - The configuration to extract the entry from
     * @param {String} key - The key of the entry to extract
     * @param {*} [defaultValue=null] - The default value to return if the key does not exist.
     */
    static fromConfig(config, key, defaultValue = null) {
        if(config != null && config[key] != null) {
            return config[key];
        }

        return defaultValue;
    }

    /**
     * Loads a template from the document and returns it
     * @param {String} id - The identifier of the template to load
     * @returns {Element} - The loaded template
     */
    static loadTemplate(id) {
        if(!id.startsWith("#")) {
            id = "#" + id;
        }

        let fragment = document.importNode(document.querySelector(id).content, true);

        if(fragment.children.length > 1) {
            console.warn("Template had more than 1 direct child:", id, fragment);
        }

        return fragment.children[0];
    }

    /**
     * Tests if the given testElement is inside the given elm
     * @param {Element} elm
     * @param {Element} testElement
     */
    static isInsideElement(elm, testElement) {
        let parent = testElement;

        while(parent != null) {
            if(parent === elm) {
                return true;
            }

            parent = parent.parentNode;
        }

        return false;
    }
};

</script>

            </div>
            
            <div class="package" id="EdgeDocker">
                <script id="descriptor-script" type="descriptor">
{
    "friendlyName": "Edge Docking Area",
    "description": "Creates a dockable area and reflows the rest of the parent around it like regular built-in developer tools",
    "dependencies": [
        "wpm_js_libs #CaviTouch",
        "WebstrateComponents_Tools"
    ],
    "assets": [],
    "version": "0.9",
    "license": "Apache 2.0",
    "changelog": {
        "0.8": "Initial checkin based on linear editor docking system",
        "0.9": "Support for moving around rest of document when docking"
    }
}

</script>

                <style id="main-style">
/**
 *  EdgeDocker Styles
 * 
 *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/
html {
  height: 100vh; }
  html[transient-data-docking-area-component-mode~="minimized"] .docking-area-resizer {
    display: none; }
  html[transient-data-docking-area-component-mode~="minimized"] .docking-area-component {
    display: none; }
  html[transient-data-docking-area-component-mode~="embedded"] .docking-area-resizer {
    display: none; }
  html[transient-data-docking-area-component-mode~="embedded"] .docking-area-component {
    width: 100%;
    height: 100%; }
  html[transient-data-docking-area-component-mode~="maximized"] > *:not(.docking-area-component):not(.docking-area--ignore) {
    /* Hide other items without breaking Monaco */
    opacity: 0;
    overflow: hidden;
    width: 1em;
    height: 1em; }
  html[transient-data-docking-area-component-mode~="maximized"] .docking-area-resizer {
    display: none; }
  html[transient-data-docking-area-component-mode~="maximized"] .docking-area-component {
    position: fixed !important;
    display: block;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important; }
  html[transient-data-docking-area-component-mode~="floating"] .docking-area-resizer {
    display: none; }
  html[transient-data-docking-area-component-mode~="floating"] .docking-area-component {
    position: fixed;
    display: block;
    top: 0;
    left: 0;
    width: 35em;
    height: 22em;
    overflow: auto;
    resize: both;
    box-sizing: border-box;
    border: 1px outset #ababab;
    box-shadow: 0.1em 0.1em 0.5em rgba(0, 0, 0, 0.15); }
  html[transient-data-docking-area-component-mode~="edge"] {
    overflow: hidden;
    display: flex; }
    html[transient-data-docking-area-component-mode~="edge"] > *:not(.docking-area--ignore) {
      flex: 1 1 auto;
      overflow: auto;
      contain: paint; }
    html[transient-data-docking-area-component-mode~="edge"] > .docking-area-resizer {
      flex: 0 0 auto;
      min-height: 1px;
      min-width: 1px;
      cursor: ew-resize;
      position: relative;
      margin: -2px;
      border: 2px solid transparent;
      contain: none;
      overflow: visible;
      z-index: 5; }
      html[transient-data-docking-area-component-mode~="edge"] > .docking-area-resizer:before {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(128, 128, 128, 0.5);
        content: ""; }
      html[transient-data-docking-area-component-mode~="edge"] > .docking-area-resizer:hover {
        margin: -0.5em;
        border: 0.5em solid transparent; }
        html[transient-data-docking-area-component-mode~="edge"] > .docking-area-resizer:hover:before {
          margin: -1px;
          border: 1px solid rgba(128, 128, 128, 0.1); }
    html[transient-data-docking-area-component-mode~="edge"] > .docking-area-component {
      contain: none;
      flex: 0 0 auto;
      min-width: 20vw;
      min-height: 20vh; }
    html[transient-data-docking-area-component-mode~="edge"][transient-data-docking-area-component-mode~="left"] > .docking-area-resizer {
      order: -1; }
    html[transient-data-docking-area-component-mode~="edge"][transient-data-docking-area-component-mode~="left"] > .docking-area-component {
      order: -2;
      height: auto; }
    html[transient-data-docking-area-component-mode~="edge"][transient-data-docking-area-component-mode~="right"] > .docking-area-resizer {
      order: 1; }
    html[transient-data-docking-area-component-mode~="edge"][transient-data-docking-area-component-mode~="right"] > .docking-area-component {
      order: 2;
      height: auto; }
    html[transient-data-docking-area-component-mode~="edge"][transient-data-docking-area-component-mode~="bottom"] {
      flex-direction: column; }
      html[transient-data-docking-area-component-mode~="edge"][transient-data-docking-area-component-mode~="bottom"] > .docking-area-resizer {
        order: 1;
        cursor: ns-resize; }
      html[transient-data-docking-area-component-mode~="edge"][transient-data-docking-area-component-mode~="bottom"] > .docking-area-component {
        order: 2; }
  html .docking-area-component {
    position: relative;
    z-index: 1000000; }
  html .docking-area-visualizer {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 15em;
    height: 10em;
    background: rgba(10, 10, 255, 0.25);
    border: 1px solid rgba(0, 0, 255, 0.3);
    box-sizing: border-box;
    transition: all 0.1s;
    opacity: 0;
    display: block;
    pointer-events: none;
    z-index: 1000000; }
  html[transient-data-docking-area-component-drag~="dragging"] {
    overflow: hidden; }
    html[transient-data-docking-area-component-drag~="dragging"] .docking-area-visualizer {
      opacity: 1; }
    html[transient-data-docking-area-component-drag~="dragging"][transient-data-docking-area-component-drag~="float"] .docking-area-visualizer {
      opacity: 0;
      transition: none; }
    html[transient-data-docking-area-component-drag~="dragging"][transient-data-docking-area-component-drag~="left"] .docking-area-visualizer {
      left: 0 !important;
      top: 0 !important;
      right: 90% !important;
      bottom: 0 !important;
      width: auto;
      height: auto; }
    html[transient-data-docking-area-component-drag~="dragging"][transient-data-docking-area-component-drag~="right"] .docking-area-visualizer {
      left: 90% !important;
      right: 0 !important;
      top: 0 !important;
      bottom: 0 !important;
      width: auto;
      height: auto; }
    html[transient-data-docking-area-component-drag~="dragging"][transient-data-docking-area-component-drag~="bottom"] .docking-area-visualizer {
      left: 0 !important;
      right: 0 !important;
      top: 90% !important;
      bottom: 0 !important;
      width: auto;
      height: auto; }
    html[transient-data-docking-area-component-drag~="dragging"][transient-data-docking-area-component-drag~="maximized"] .docking-area-visualizer {
      left: 0 !important;
      top: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      width: auto;
      height: auto; }
</style>

                <script id="edgedocker-component-script" type="disabled">
/**
 *  EdgeDocker
 *  Provides Developer-Console-like behaviour in browsers
 * 
 *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/

/**
 * @typedef {object} EdgeDocker~config
 * @property {Element} [parent=html] - The parent to attach the docker too.
 * @property {EdgeDocker.MODE} [mode=RIGHT] - The edge to attach too.
 */

/**
 * EdgeDocker can dock its container along the edges of the browser, just like Dev console does.
 */
class EdgeDocker {
    /**
     * Create a new EdgeDocker
     * @param {EdgeDocker~config} options
     */
    constructor(options) {
        let self = this;

        this.parent = WebstrateComponents.Tools.fromConfig(options, "parent", document.querySelector("html"));

        // Add the resizer and content areas
        this.resizeHandle = document.createElement("transient");
        this.resizeHandle.classList.add("docking-area-resizer");
        this.parent.appendChild(this.resizeHandle);
        this.outerComponentArea = document.createElement("component-area");
        this.outerComponentArea.classList.add("docking-area-component");
        this.outerComponentArea.setAttribute("transient-element",true);
        this.parent.appendChild(this.outerComponentArea);
        this.visualizerHandle = document.createElement("transient");
        this.visualizerHandle.classList.add("docking-area-visualizer");
        this.parent.appendChild(this.visualizerHandle);
        
        // Create shadowDOM for content in component area and simulate a fake toplevel HTML element on it
        if (options.shadowRoot){
            this.componentShadow = this.outerComponentArea.attachShadow({mode:"open"});//this.outerComponentArea;
            this.innerComponentArea = document.createElement("component-area-content");
            this.componentShadow.appendChild(this.innerComponentArea);
            this.componentShadow.matches = (query)=>{
                if (query==="html") return true;
            }
            
            // For components that do not supply their own stylesheets we can pass thru the main page's
            if (options.shadowCompatibility){
                this.shadowCompatibilityNode = document.createElement("compatibility-pasthru");
                this.shadowCompatibilityNode.style.display="none";
                this.componentShadow.appendChild(this.shadowCompatibilityNode);
                
                let updateCompatibilityPasthru = function updateCompatibilityPasthru(){
                    self.shadowCompatibilityNode.innerHTML="";
                    document.querySelectorAll("head link, head style, head wpm-package svg").forEach((style)=>{
                        self.shadowCompatibilityNode.appendChild(style.cloneNode(true));
                    });                
                }
                let observer = new MutationObserver(updateCompatibilityPasthru);
                observer.observe(document.head, {
                    childList: true, 
                    subtree: true
                });                
                updateCompatibilityPasthru();
                
            }
        } else {
            this.innerComponentArea = this.outerComponentArea;
        }
        
        // Do not let events bubble through the component area to the document below
        let stopEvent = (evt)=>{
            evt.stopPropagation();
        };
        ["click"].forEach((event)=>{
            this.outerComponentArea.addEventListener(event, stopEvent);
        });

        this.dragging = false;

        // init resize
        this.setupResizeHandle(this.resizeHandle);
        this.setMode(WebstrateComponents.Tools.fromConfig(options, "mode", EdgeDocker.MODE.RIGHT));

        this.positionAnimationFrame = null;
        this.boundsAnimationFrame = null;

        let oldStyleWidth = null;
        let oldStyleHeight = null;

        //Crude observer to check for docker resizeing
        let observer = new MutationObserver(()=>{
            let doEvent = false;


            if(self.boundsAnimationFrame != null) {
                cancelAnimationFrame(this.boundsAnimationFrame);
                self.boundsAnimationFrame = null;
            }

            self.boundsAnimationFrame = requestAnimationFrame(()=>{
                if(this.outerComponentArea.style.width != oldStyleWidth) {
                    doEvent = true;
                    oldStyleWidth = parseInt(this.outerComponentArea.style.width);
                }

                if(this.outerComponentArea.style.height != oldStyleHeight) {
                    doEvent = true;
                    oldStyleHeight = parseInt(this.outerComponentArea.style.height);
                }

                if(doEvent) {
                    self.setBounds(parseInt(this.outerComponentArea.style.left), parseInt(this.outerComponentArea.style.top), oldStyleWidth, oldStyleHeight);
                    window.dispatchEvent(new Event('resize'));
                }
            });
        });

        observer.observe(this.outerComponentArea, {
            attributes: true,
            attributeFilter: ["style"]
        });
    }

    setupResizeHandle() {
        let self = this;
        
        this.resizeAnimFrame = null;
        
        let preventEvents = ["move"];
        if(navigator.userAgent.toLowerCase().indexOf('firefox') > -1){
            preventEvents.push("down");
        }
        
        this.deltaWidth = 0;
        this.deltaHeight = 0;

        new CaviTouch(this.resizeHandle, {
            minDragDistance: 0
        });

        this.resizeHandle.addEventListener("caviDrag", (evt)=>{
            switch(self.currentMode) {
                case EdgeDocker.MODE.MAXIMIZED:
                    break;
                case EdgeDocker.MODE.BOTTOM:
                    self.deltaHeight -= evt.detail.caviEvent.deltaPosition.y;
                    break;
                case EdgeDocker.MODE.LEFT:
                    self.deltaWidth += evt.detail.caviEvent.deltaPosition.x;
                    break;
                case EdgeDocker.MODE.RIGHT:
                    self.deltaWidth -= evt.detail.caviEvent.deltaPosition.x;
                    break;
                case EdgeDocker.MODE.FLOAT:
                    self.deltaWidth += evt.detail.caviEvent.deltaPosition.x;
                    self.deltaHeight += evt.detail.caviEvent.deltaPosition.y;
                    break;
            }
            
            if(self.resizeAnimFrame === null) {
                cancelAnimationFrame(self.resizeAnimFrame);
            }
            self.resizeAnimFrame = requestAnimationFrame(()=>{
                self.resizeAnimFrame = null;
                let width = this.outerComponentArea.offsetWidth + self.deltaWidth;
                let height = this.outerComponentArea.offsetHeight + self.deltaHeight;
                
                self.deltaWidth = 0;
                self.deltaHeight = 0;

                this.setBounds(parseInt(this.outerComponentArea.style.left), parseInt(this.outerComponentArea.style.top), width, height);
                /*
                this.outerComponentArea.style.width = width+"px";
                this.outerComponentArea.style.height = height+"px";
                */
            });
        });
    }
    
    setupDragHandle(element) {
        let self = this;

        new CaviTouch(element, {
            preventDefaultEvents: []
        });

        let currentSelectedMode = null;
        let oldSelectedMode = null;

        let currentX = 0;
        let currentY = 0;
        
        element.addEventListener("caviDoubleTap", ()=>{
            if(self.currentMode !== EdgeDocker.MODE.MAXIMIZED){
                self.setMode(EdgeDocker.MODE.MAXIMIZED);
            } else {
                self.setMode(EdgeDocker.MODE.FLOAT);
            }
        });

        element.addEventListener("caviDragStart", (evt)=>{
            self.dragging = true;

            oldSelectedMode = self.currentMode;

            if(self.currentMode !== EdgeDocker.MODE.FLOAT) {
                self.setMode(EdgeDocker.MODE.FLOAT);

                let bounds = element.getBoundingClientRect();

                self.setPosition(evt.detail.caviEvent.position.x-bounds.width / 2.0, evt.detail.caviEvent.position.y-bounds.height / 2.0, true);
            }

            self.parent.setAttribute("transient-data-docking-area-component-drag", "dragging");

            let bounds = this.outerComponentArea.getBoundingClientRect();
            currentX = bounds.x;
            currentY = bounds.y;
        });

        element.addEventListener(("caviDrag"), (evt)=>{
            let percentWidth = self.parent.offsetWidth * 0.1;
            let percentHeight = self.parent.offsetHeight * 0.1;

            currentX += evt.detail.caviEvent.deltaPosition.x;
            currentY += evt.detail.caviEvent.deltaPosition.y;

            if(evt.detail.caviEvent.position.x < percentWidth) {
                self.parent.setAttribute("transient-data-docking-area-component-drag", "dragging left");
                currentSelectedMode = EdgeDocker.MODE.LEFT;
            } else if(self.parent.offsetWidth - evt.detail.caviEvent.position.x < percentWidth) {
                self.parent.setAttribute("transient-data-docking-area-component-drag", "dragging right");
                currentSelectedMode = EdgeDocker.MODE.RIGHT;
            } else if(evt.detail.caviEvent.position.y - self.parent.scrollTop < percentHeight) {
                self.parent.setAttribute("transient-data-docking-area-component-drag", "dragging maximized");
                currentSelectedMode = EdgeDocker.MODE.MAXIMIZED;
            } else if(self.parent.offsetHeight - (evt.detail.caviEvent.position.y - self.parent.scrollTop) < percentHeight) {
                self.parent.setAttribute("transient-data-docking-area-component-drag", "dragging bottom");
                currentSelectedMode = EdgeDocker.MODE.BOTTOM;
            } else {
                self.parent.setAttribute("transient-data-docking-area-component-drag", "dragging float");
                currentSelectedMode = EdgeDocker.MODE.FLOAT;
            }

            self.setPosition(currentX, currentY);
        });

        element.addEventListener("caviDragStop", (evt)=>{

            self.setMode(currentSelectedMode, false);

            if(oldSelectedMode !== currentSelectedMode) {
                self.saveMode();
            }

            if(currentSelectedMode === EdgeDocker.MODE.FLOAT) {
                self.saveBounds(currentSelectedMode, true);
            }

            self.parent.setAttribute("transient-data-docking-area-component-drag", "");

            if(currentSelectedMode === EdgeDocker.MODE.FLOAT) {
                self.setPosition(currentX, currentY, true);
            }

            setTimeout(()=>{
                self.dragging = false;
            });
        });
        
        element.style.cursor = "move";
    }

    /**
     * Sets the position of this EdgeDocker, Ignored if not in FLOAT mode
     * @param {Number} x
     * @param {Number} y
     */
    setPosition(x, y, immediately=false) {
        if(this.currentMode === EdgeDocker.MODE.FLOAT) {
            let self = this;

            if(this.positionAnimationFrame != null) {
                cancelAnimationFrame(this.positionAnimationFrame);
                this.positionAnimationFrame = null;
            }

            if(immediately) {
                this.outerComponentArea.style.left = x + "px";
                this.outerComponentArea.style.top = y + "px";
                self.visualizerHandle.style.left = x + "px";
                self.visualizerHandle.style.top = y + "px";
            } else {
                this.positionAnimationFrame = requestAnimationFrame(()=>{
                    if(self.currentMode === EdgeDocker.MODE.FLOAT) {
                        this.outerComponentArea.style.left = x + "px";
                        this.outerComponentArea.style.top = y + "px";
                        self.visualizerHandle.style.left = x + "px";
                        self.visualizerHandle.style.top = y + "px";
                    }
                });
            }
        }
    }

    /**
     * Sets the bounds of this EdgeDocker
     * @param {Number} x
     * @param {Number} y
     * @param {Number} width
     * @param {Number} height
     * @param {boolean} [doSave=true] - Determines if the bounds should be saved or not
     */
    setBounds(x, y, width, height, doSave = true) {
        this.setPosition(x, y, true);

        let maxWidth = this.parent.offsetWidth * 0.8;
        let maxHeight = this.parent.offsetHeight * 0.8;

        width = Math.min(width, maxWidth);
        height = Math.min(height, maxHeight);

        switch(this.currentMode) {
            case EdgeDocker.MODE.LEFT:
            case EdgeDocker.MODE.RIGHT:
                //Only Set Width
                this.outerComponentArea.style.width = width + "px";
                break;

            case EdgeDocker.MODE.BOTTOM:
                //Only Set height
                this.outerComponentArea.style.height = height + "px";
                break;

            case EdgeDocker.MODE.FLOAT:
                //Set Width and Height
                this.outerComponentArea.style.width = width + "px";
                this.outerComponentArea.style.height = height + "px";
                break;
        }

        if(doSave) {
            this.saveBounds(this.currentMode);
        }
    }

    /**
     * Sets the current dock mode of this EdgeDocker
     * @param {EdgeDocker.MODE} mode
     * @param {boolean} [doLoad=true] - Determines if this setMode should load bounds from storage or not.
     */
    setMode(mode, doLoad = true){
        let oldWidth = parseInt(this.outerComponentArea.style.height);
        let oldHeight = parseInt(this.outerComponentArea.style.width);
        let oldMode = this.currentMode;

        this.parent.setAttribute("transient-data-docking-area-component-mode", mode);
        this.currentMode = mode;

        if(this.currentMode === EdgeDocker.MODE.MAXIMIZED || this.currentMode === EdgeDocker.MODE.EMBEDDED) {
            this.outerComponentArea.style.width = "";
            this.outerComponentArea.style.height = "";
        } else if(this.currentMode === EdgeDocker.MODE.LEFT || this.currentMode === EdgeDocker.MODE.RIGHT) {
            this.outerComponentArea.style.height = "";
            this.outerComponentArea.style.width = (this.parent.offsetWidth*0.5)+"px"; //Overidden if any saved mode exists
        } else if(this.currentMode === EdgeDocker.MODE.BOTTOM) {
            this.outerComponentArea.style.width = "";
            this.outerComponentArea.style.height = (this.parent.offsetHeight*0.33)+"px"; //Overidden if any saved mode exists
        } else if(this.currentMode === EdgeDocker.MODE.FLOAT && oldMode !== EdgeDocker.MODE.FLOAT) {
            this.outerComponentArea.style.width = "";
            this.outerComponentArea.style.height = "";
        }
        
        if (this.currentMode !== EdgeDocker.MODE.FLOAT){
            this.outerComponentArea.style.top = null;
            this.outerComponentArea.style.left = null;
        }

        if(doLoad) {
            this.loadBounds(this.currentMode);
        }

        window.dispatchEvent(new Event('resize'));
    }
    
    dockInto(parentElement){
        if (parentElement){
            // Move into the element if one is given
            parentElement.appendChild(this.outerComponentArea);
        } else {
            // Default to being shown before the visualizer
            this.visualizerHandle.parentElement.insertBefore(this.outerComponentArea, this.visualizerHandle);
        }
    }

    loadBounds(mode) {
        let key = location.pathname + "_" + mode;

        let bounds = localStorage.getItem(key);

        if(bounds != null) {
            try {
                bounds = JSON.parse(bounds);
                this.setBounds(bounds.x, bounds.y, bounds.width, bounds.height);
            } catch(e) {
                console.error(e);
            }
        }
    }

    saveBounds(mode, forceSave = false) {
        if(this.dragging && !forceSave) {
            return;
        }

        let key = location.pathname + "_" + mode;

        let bounds = this.outerComponentArea.getBoundingClientRect();

        localStorage.setItem(key, JSON.stringify(bounds));
    }

    /**
     * Save the current mode
     */
    saveMode() {
        let key = location.pathname + "_Mode";
        localStorage.setItem(key, this.currentMode);
    }

    /**
     * Load the saved mode, or use fallback if no saved mode
     * @param {EdgeDocker.MODE} fallback - The mode to use if none is saved.
     */
    loadMode(fallback) {
        let key = location.pathname + "_Mode";
        let mode = localStorage.getItem(key);
        if(mode != null) {
            this.setMode(mode);
        } else {
            this.setMode(fallback);
        }
    }

    /**
     * Fetch the component area where DOM elements can be added to this EdgeDocker
     * @returns {HTMLElement}
     */
    getComponentArea(){
        return this.innerComponentArea;
    }
}

/**
 * The supported modes of EdgeDocker
 * @readonly
 * @enum
 */
EdgeDocker.MODE = {
    MAXIMIZED: "maximized",
    MINIMIZED: "minimized",
    LEFT: "left edge",
    RIGHT: "right edge",
    BOTTOM: "bottom edge",
    FLOAT: "floating",
    EMBEDDED: "embedded"
};

window.EdgeDocker = EdgeDocker;

</script>

            </div>            

            <div class="package" id="MenuSystem">
                <script id="descriptor-script" type="descriptor">
{
    "friendlyName": "MenuSystem",
    "description": "A system to dynamically register into a menu structure and present it visually",
    "dependencies": [
        "WebstrateComponents_Tools"
    ],
    "assets": [],
    "version": "0.1",
    "license": "Apache 2.0",
    "changelog": {
        "0.1": "Initial version"
    }
}

</script>

                <script id="MenuSystem-script" type="disabled">
/**
 *  MenuSystem
 *  A system to dynamically register into a menu structure and present it visually
 * 
 *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/

/**
 * @namespace MenuSystem
 */
window.MenuSystem = {};

/**
 * @typedef {Object} MenuSystem~Point
 * @property {Number} x
 * @property {Number} y
 */

/**
 * @typedef {Object} MenuSystem.Menu~menuConfig
 * @property {MenuSystem.MenuBuilder} [builder=null] - The MenuBuilder to use when instanciating the Menu, if null the DefaultBuilder will be used instead.
 * @property {*} [context=null] - The context of this Menu
 * @property {Boolean} [keepOpen=false] - Should the Menu stay open when clicked
 * @property {Boolean} [groupDividers=false] - Should group dividers be visible
 * @property {function} [onOpen] - Called when the Menu is opened
 * @property {function} [onClose] - Called when the Menu is closed
 */

/**
 * @typedef {Object} MenuSystem.MenuItem~menuItemConfig
 * @property {String} [label] - The label of this MenuItem
 * @property {*} [icon] - The icon of this MenuItem
 * @property {Number} [order=99999] - The order of this MenuItem
 * @property {function} [onAction] - The callback to call when this MenuItem has its action triggered
 * @property {function} [onOpen] - Called when the Menu this MenuItem belongs to is about to open. If false is returned, this MenuItem will not be shown.
 * @property {MenuSystem.Menu} [submenu=null] - A submenu to open when clicking this MenuItem
 * @property {boolean} [submenuOnHover=true] - Determines if this MenuItem's submenu should open on hover
 * @property {String} [group] - The group this MenuItem should belong too
 * @property {Number} [groupOrder=99999] - If this MenuItem is part of a group, this is the order the group should have. (The lowest order of all members is choosen)
 */

/**
 * MenuManager is used to interact with menus in MenuSystem
 * @hideconstructor
 * @memberof MenuSystem
 */
MenuSystem.MenuManager = class MenuManager {
    /**
     * Registers a new MenuItem for the given named menu. MenuItem's can be registered both before and after the menu is created.
     * @param {String} menuName - The name of the menu to register this MenuItem for
     * @param {MenuSystem.MenuItem~menuItemConfig} menuItemConfig - The configuration for this MenuItem
     *
     * @returns {Object} - Delete object, with a single method delete(), that removes this menuItemConfig and all menuitems associated with it
     *
     * @example
     * MenuSystem.MenuManager.registerMenuItem("MyMenu", {
     *     label: "MyMenuItem",
     *     order: 10.
     *     onAction: ()=>{console.log("MyMenuItem clicked!");}
     *     onOpen: ()=>{return true;}
     * });
     */
    static registerMenuItem(menuName, menuItemConfig) {
        menuItemConfig._allMenuItems = new Set();

        //Register this MenuItem in the set
        let menuItemSet = MenuSystem.MenuManager.menuItemMap.get(menuName);
        if(menuItemSet == null) {
            menuItemSet = new Set();
            MenuSystem.MenuManager.menuItemMap.set(menuName, menuItemSet);
        }
        menuItemSet.add(menuItemConfig);

        //Add MenuItem to all menus already created
        let menuArray = MenuSystem.MenuManager.menuMap.get(menuName);
        if(menuArray != null) {
            menuArray.forEach((menu)=>{
                menuItemConfig._allMenuItems.add(menu.addItem(menuItemConfig));
            });
        }

        return {
            delete: ()=>{
                menuItemSet.delete(menuItemConfig);

                menuItemConfig._allMenuItems.forEach((menuItem)=>{
                    menuItem.menu.removeItem(menuItem);
                });
            }
        }
    }

    /**
     * Create a new menu
     * @param {String} menuName - The name of the Menu
     * @param {MenuSystem.Menu~menuConfig} [menuConfig] - The configuration of the Menu
     * @return {MenuSystem.Menu} - The created menu
     * 
     * @example
     * MenuSystem.MenuManager.createMenu("MyMenu", {
     *     context: myContext,
     *     builder: MenuSystem.MyLovelyMenuBuilder
     *     keepOpen: false,
     *     onOpen: ()=>{console.log("MyMenu was opened!")},
     *     onClose: ()=>{console.log("MyMenu was closed!")},
     * });
     */
    static createMenu(menuName, menuConfig = {}) {

        if(menuConfig.builder == null) {
            if(MenuSystem.MenuManager.defaultBuilder == null) {
                throw "Attempt to create Menu with defaultBuilder but no default builder is set!";
            }

            menuConfig.builder = MenuSystem.MenuManager.defaultBuilder;
        }

        //Build Menu
        let menu = new MenuSystem.Menu(menuConfig);

        //Add it to our map of named menus
        let menuArray = MenuSystem.MenuManager.menuMap.get(menuName);
        if(menuArray == null) {
            menuArray = [];
            MenuSystem.MenuManager.menuMap.set(menuName, menuArray);
        }
        menuArray.push(menu);

        //Add all registered menuItems
        let menuItemSet = MenuSystem.MenuManager.menuItemMap.get(menuName);
        if(menuItemSet != null) {
            menuItemSet.forEach((itemConfig)=>{
                itemConfig._allMenuItems.add(menu.addItem(itemConfig));
            });
        }

        return menu;
    }

    static setDefaultBuilder(builder) {
        MenuSystem.MenuManager.defaultBuilder = builder;
    }
};
MenuSystem.MenuManager.menuItemMap = new Map();
MenuSystem.MenuManager.menuItemDeleterMap = new Map();
MenuSystem.MenuManager.menuMap = new Map();
MenuSystem.MenuManager.defaultBuilder = null;

/**
 * MenuBuilder is used to build concrete instances of Menu's
 */
MenuSystem.MenuBuilder = class MenuBuilder {
    /**
     * Construct the HTML code for the given Menu
     * @param {MenuSystem.Menu} menu
     */
    static buildMenuHtml(menu) {
        //Override in subclass
        throw "Remember to override buildMenuHtml()";
    }

    /**
     * Construct the HTML code for the given MenuItem
     * @param {MenuSystem.MenuItem} menuItem 
     */
    static buildMenuItemHtml(menuItem) {
        //Override in subclass
        throw "Remember to override buildMenuItemHtml()";
    }

    /**
     * Clear all MenuItem's from the given Menu
     * @param {MenuSystem.Menu} menu
     */
    static clearMenuItems(menu) {
        //Override in subclass
        throw "Remember to override clearMenuItems()";
    }

    /**
     * Attach the given MenuItem's to the given Menu
     * @param {MenuSystem.Menu} menu 
     * @param {MenuSystem.MenuItem[][]} groups - Array of MenuItem arrays, where each outer array is a grouping of MenuItems
     */
    static attachMenuItems(menu, menuItems) {
        //Override in subclass
        throw "Remember to override attachMenuItems()";
    }

    /**
     * Opens the given Menu
     * 
     * The source parameter tells where the open event originated from, which can be a Element, or a 2D point
     * @param {MenuSystem.Menu} menu - The Menu to open
     * @param {Element|MenuSystem~Point} source - The source of the open event
     */
    static open(menu, source) {
        //Override in subclass
        throw "Remember to override open()";
    }

    /**
     * Closes the given Menu
     * @param {MenuSystem.Menu} menu 
     */
    static close(menu) {
        //Override in subclass
        throw "Remember to override close()";
    }

    /**
     * Destroy the given Menu
     * @param {MenuSystem.Menu} menu 
     */
    static destroyMenu(menu) {
        //Override in subclass
        throw "Remember to override destroyMenu()";
    }

    /**
     * Destroy the given MenuItem
     * @param {MenuSystem.MenuItem} menuItem
     */
    static destroyMenuItem(menuItem) {
        //Override in subclass
        throw "Remember to override destroyMenuItem()";
    }

    /**
     * Create an icon that represents a submenu
     */
    static createSubmenuIcon() {
        //Override in subclass
        throw "Remember to override createSubmenuIcon()";
    }
};

/**
 * Represents a Menu in the MenuSystem
 */
MenuSystem.Menu = class Menu {
    /**
     * Construct a new Menu
     * @param {MenuSystem.Menu~menuConfig} [options] - The options to use for this menu
     */
    constructor(options) {
        this.options = options;

        this.context = WebstrateComponents.Tools.fromConfig(options, "context", null);
        this.builder = WebstrateComponents.Tools.fromConfig(options, "builder", null);

        this.keepOpen = WebstrateComponents.Tools.fromConfig(options, "keepOpen", false);

        this.groupDividers = WebstrateComponents.Tools.fromConfig(options, "groupDividers", false);

        this.growDirection = WebstrateComponents.Tools.fromConfig(options, "growDirection", MenuSystem.Menu.GrowDirection.RIGHT);
        this.layoutDirection = WebstrateComponents.Tools.fromConfig(options, "layoutDirection", MenuSystem.Menu.LayoutDirection.VERTICAL);
        this.layoutWrapping = WebstrateComponents.Tools.fromConfig(options, "layoutWrapping", true);
        this.layoutCompact = WebstrateComponents.Tools.fromConfig(options, "layoutCompact", false);
        this.defaultFocus = WebstrateComponents.Tools.fromConfig(options, "defaultFocus", true);

        this.onOpen = new Set();
        let openCallback = WebstrateComponents.Tools.fromConfig(options, "onOpen");
        if(openCallback != null) {
            this.onOpen.add(openCallback);
        }

        this.onClose = new Set();
        let closeCallback = WebstrateComponents.Tools.fromConfig(options, "onClose");
        if(closeCallback != null) {
            this.onClose.add(closeCallback);
        }

        this.menuItems = [];

        this.isOpen = false;
        this.currentSubmenu = null;

        /** @member {Element} - The DOM Element of this Menu */
        this.html = this.builder.buildMenuHtml(this);
        this.html.menu = this;
        this.html.classList.add("menusystem-menu");

        let self = this;

        this.html.addEventListener("contextmenu", (evt)=>{
            evt.preventDefault();
        });

        this.bodyClickHandler = function(evt) {
            self.handleBodyClick(evt);
        }

        if(this.keepOpen) {
            this.open();
        }
    }

    /**
     * Register a callback to be called when this Menu opens
     * @param {Function} callback 
     */
    registerOnOpenCallback(callback) {
        this.onOpen.add(callback);
    }

    /**
     * Deregister a callback to be called when this Menu opens
     * @param {Function} callback 
     */
    deregisterOnOpenCallback(callback) {
        this.onOpen.delete(callback);
    }

    /**
     * Register a callback to be called when this Menu closes
     * @param {Function} callback 
     */
    registerOnCloseCallback(callback) {
        this.onClose.add(callback);
    }

    /**
     * Deregister a callback to be called when this Menu closes
     * @param {Function} callback 
     */
    deregisterOnCloseCallback(callback) {
        this.onClose.delete(callback);
    }

    /**
     * Add a MenuItem to this Menu
     * @param {MenuSystem.MenuItem~menuItemConfig} itemConfig
     * @return {MenuSystem.MenuItem} - The added item
     */
    addItem(itemConfig) {
        let menuItem = new MenuSystem.MenuItem(this.builder, this, itemConfig);
        this.menuItems.push(menuItem);

        this.checkUpdate();

        return menuItem;
    }

    /**
     * Remove a MenuItem from this Menu
     * @param {MenuSystem.MenuItem} menuItem - The menu item to remove
     */
    removeItem(menuItem) {
        this.menuItems.splice(this.menuItems.indexOf(menuItem), 1);

        this.checkUpdate();
    }

    /**
     * Opens this Menu
     * @param {Element|MenuSystem~Point} [source] - Some notion of the source that openend the Menu, could be a Element or a Point
     */
    open(source = null) {
        let self = this;

        if(this.closeTimeoutId != null) {
            clearTimeout(this.closeTimeoutId);
            this.closeTimeoutId = null;
        }

        let numItems = this.update();

        if(numItems === 0 && !this.keepOpen) {
            return;
        }

        this.builder.open(this, source);

        this.isOpen = true;

        setTimeout(()=>{
            window.addEventListener("mouseup", self.bodyClickHandler, {
                capture: true
            });
        }, 0);

        this.triggerOnOpen();
    }

    checkUpdate() {
        if(this.isOpen) {
            let numItems = this.update();

            if(numItems === 0 && !this.keepOpen) {
                this.close();
            }
        }
    }

    /**
     * Updates the MenuItems in this menu.
     * @returns {number} - The number of items in the menu
     */
    update() {
        let self = this;

        this.builder.clearMenuItems(this);

        let groupMap = new Map();

        //Filter menu items
        let filteredMenuItems = this.menuItems.filter((item)=>{
            try {
                return item.onOpen(self, item);
            } catch (ex){
                console.warn("MenuSystem: Menu entry caused an exception while evaluating visibility, dropping: ", item, ex);
                return false;
            }
        });

        //Group items
        filteredMenuItems.forEach((item)=>{
            let group = groupMap.get(item.group);
            if(group == null) {
                group = [];
                groupMap.set(item.group, group);
            }

            group.push(item);
        });

        let groupArrays = Array.from(groupMap.values());

        //Sort Groups
        groupArrays.sort((g1, g2)=>{
            let g1MinGroupOrder = 99999999999;
            let g2MinGroupOrder = 99999999999;

            g1.forEach((item)=>{
                g1MinGroupOrder = Math.min(g1MinGroupOrder, item.groupOrder);
            });
            g2.forEach((item)=>{
                g2MinGroupOrder = Math.min(g2MinGroupOrder, item.groupOrder);
            });

            return g1MinGroupOrder - g2MinGroupOrder;
        });

        //Sort items in each group
        groupArrays.forEach((group)=>{
            group.sort((i1, i2) => {
                return i1.order - i2.order;
            });
        });

        this.builder.attachMenuItems(this, groupArrays);

        return filteredMenuItems.length;
    }

    /**
     * Close this Menu
     */
    close() {
        if(!this.isOpen) {
            return;
        }

        this.builder.close(this);

        this.isOpen = false;

        window.removeEventListener("mouseup", this.bodyClickHandler, {
            capture: true
        });

        this.triggerOnClose();
    }

    /**
     * Destroy this menu
     */
    destroy() {
        this.menuItems.forEach((item)=>{
            item.destroy();
        });

        this.builder.destroyMenu(this);
    }

    /**
     * Trigger the onOpen callback attached to this Menu
     * @private
     */
    triggerOnOpen() {
        let self = this;
        this.onOpen.forEach((callback)=>{
            if(typeof callback === "function") {
                try {
                    callback(self);
                } catch(e) {
                    console.error("Error inside onOpen:", e);
                }
            }
        });
    }

    /**
     * Trigger the onClose callback attached to this Menu
     * @private
     */
    triggerOnClose() {
        let self = this;
        this.onClose.forEach((callback)=>{
            if(typeof callback === "function") {
                try {
                    callback(self);
                } catch(e) {
                    console.error("Error inside onClose:", e);
                }
            }
        });
    }

    /**
     * Closes all submenus except on the given MenuItem
     * @param {MenuSystem.MenuItem} menuItem
     */
    closeAllOtherSubmenus(menuItem) {
        this.menuItems.forEach((item)=>{
            if(item != menuItem && item.submenu != null && item.submenu.isOpen) {
                item.toggleSubmenu();
            }
        });
    }

    /**
     * Signals to this Menu that the given MenuItem has been triggered
     * @private
     * @param {MenuSystem.MenuItem} menuItem 
     */
    handleItemAction(menuItem) {
        menuItem.triggerOnAction();

        if(!this.keepOpen && menuItem.submenu == null) {
            this.close();
        }
    }

    /**
     * Handles clicks to the document, to check if we should close if clicked outside
     * @private
     * @param {MouseEvent} evt 
     */
    handleBodyClick(evt) {
        let self = this;

        if(!WebstrateComponents.Tools.isInsideElement(this.html, evt.target)) {
            this.closeTimeoutId = setTimeout(()=>{
                this.closeTimeoutId = null;

                let shouldClose = !self.keepOpen && self.currentSubmenu == null;

                if(shouldClose) {
                    self.close();
                }
            }, 0);
        }
    }
};

MenuSystem.Menu.GrowDirection = {
    RIGHT: "right",
    DOWN: "down"
};
MenuSystem.Menu.LayoutDirection = {
    HORIZONTAL: "horizontal",
    VERTICAL: "vertical"
};

/**
 * Represents a MenuItem in the MenuSystem
 */
MenuSystem.MenuItem = class MenuItem {
    /**
     * Construct a new MenuItem
     * @param {MenuSystem.MenuBuilder} builder 
     * @param {MenuSystem.Menu} menu 
     * @param {MenuSystem.MenuItem~menuItemConfig} config 
     */
    constructor(builder, menu, config) {
        let self = this;

        this.builder = builder;
        this.config = config;
        this.menu = menu;

        this.order = WebstrateComponents.Tools.fromConfig(config, "order", 99999);
        this.icon = WebstrateComponents.Tools.fromConfig(config, "icon", null);
        this.metaIcon = WebstrateComponents.Tools.fromConfig(config, "metaIcon", null);
        this.label = WebstrateComponents.Tools.fromConfig(config, "label", null);
        this.tooltip = WebstrateComponents.Tools.fromConfig(config, "tooltip", null);
        this.onAction = WebstrateComponents.Tools.fromConfig(config, "onAction", ()=>{});
        this.onOpen = WebstrateComponents.Tools.fromConfig(config, "onOpen", ()=>{return true;});
        this.submenuOnHover = WebstrateComponents.Tools.fromConfig(config, "submenuOnHover", true);
        this.group = WebstrateComponents.Tools.fromConfig(config, "group", null);
        this.groupOrder = WebstrateComponents.Tools.fromConfig(config, "groupOrder", 99999);
        this.class = WebstrateComponents.Tools.fromConfig(config, "class", null);
        this.checked = WebstrateComponents.Tools.fromConfig(config, "checked", null);

        this.submenu = WebstrateComponents.Tools.fromConfig(config, "submenu", null);

        if(this.submenu != null && this.metaIcon == null) {
            this.metaIcon = this.builder.createSubmenuIcon();
        }

        /** @member {Element} - The DOM Element of this MenuItem */
        this.html = builder.buildMenuItemHtml(this);

        if(this.class != null) {
            this.html.classList.add(this.class.split(" "));
        }

        this.submenuCloseHandler = () => {
            if(self.menu.currentSubmenu === self.submenu) {
                if(!self.menu.keepOpen) {
                    self.menu.close();
                }
                self.menu.currentSubmenu = null;
            }
        }

        this.menuCloseHandler = () => {
            if(self.menu.currentSubmenu === self.submenu) {
                self.menu.currentSubmenu = null;
                self.submenu.close();
            }
        }

        this.setupSubmenuHover();
    }

    get active() {
        return this.html.classList.contains("MenuSystem_MenuItem_Active");
    }

    set active(active) {
        this.builder.setItemActive(this, active);
    }

    /**
     * Trigger the onAction callback of this MenuItem
     * @private
     */
    triggerOnAction() {
        let self = this;

        if(typeof this.onAction === "function") {
            this.onAction(this);
        }

        if(this.submenu != null) {
            this.toggleSubmenu();
        }
    }

    /**
     * Toggles the submenu of this MenuItem, undefined behaviour if this MenuItem is not currently showing in a menu
     * @private
     */
    toggleSubmenu() {
        if(this.submenu == null) {
            throw "Tried to toggle submenu on a menuitem that has no submenu!";
        }

        //Find top component after html
        let parent = this.html;
        while(parent.parentNode != null && !parent.parentNode.matches("html")) {
            parent = parent.parentNode;
        }

        parent.appendChild(this.submenu.html);

        if(this.submenu.isOpen) {
            this.menu.deregisterOnCloseCallback(this.menuCloseHandler);
            this.submenu.deregisterOnCloseCallback(this.submenuCloseHandler);
            this.submenu.close();
            this.submenu.superMenu = null;
            this.menu.currentSubmenu = null;
        } else {
            this.submenu.open(this.html);
            this.submenu.superMenu = this.menu;
            this.menu.currentSubmenu = this.submenu;
            this.submenu.registerOnCloseCallback(this.submenuCloseHandler);
            this.menu.registerOnCloseCallback(this.menuCloseHandler);
        }
    }

    /**
     * Destroys this MenuItem
     */
    destroy() {
        this.builder.destroyMenuItem(this);
    }

    /**
     * @private
     */
    setupSubmenuHover() {
        let self = this;

        let submenuHoverTimerId = null;

        this.html.addEventListener("mouseenter", (evt)=>{
            //Close all other submenus from our Menu
            self.menu.closeAllOtherSubmenus(self);

            if(this.submenuOnHover && this.submenu != null && !this.submenu.isOpen) {
                self.toggleSubmenu();
            }
        });

        this.html.addEventListener("mouseleave", (evt)=>{
            let newTarget = document.elementFromPoint(evt.pageX, evt.pageY);

            let menuItemRect = self.html.getBoundingClientRect();
            let submenuRect = null;

            if(this.submenu?.html != null) {
                submenuRect = self.submenu.html.getBoundingClientRect();

                let boxBetween = {
                    xMin: menuItemRect.x+menuItemRect.width - 5,
                    xMax: submenuRect.x + 5,
                    yMin: Math.min(submenuRect.y-5, menuItemRect.y - 5),
                    yMax: Math.max(submenuRect.y+submenuRect.height + 5, menuItemRect.y+menuItemRect.height + 5)
                }

                if(evt.pageX > boxBetween.xMin && evt.pageX < boxBetween.xMax && evt.pageY < boxBetween.yMax && evt.pageY > boxBetween.yMin) {
                    return;
                }
            }

            if(self.submenuOnHover && self.submenu != null && self.submenu.isOpen && !WebstrateComponents.Tools.isInsideElement(self.submenu.html, newTarget)) {
                self.toggleSubmenu();
            }
        });
    }
};

</script>

            </div>

            <div class="package" id="ButtonSystem">
                <script id="descriptor-script" type="descriptor">
{
    "friendlyName": "Buttons",
    "description": "Buttons for all",
    "dependencies": [],
    "assets": [
    ],
    "version": "0.1",
    "license": "Apache 2.0",
    "changelog": {
        "0.1": "Initial version"
    }
}

</script>

                <script id="buttons-script" type="disabled">
/**
 *  Button System
 *  Provides easily usable buttons
 * 
 *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/

/**
 * @namespace ButtonSystem
 */
window.ButtonSystem = {};

/**
 * @typedef {Object} ButtonSystem~ButtonConfig
 * @property {ButtonSystem.ButtonBuilder} [builder] - The builder to use when creating the button, if not specified, the DefaultBuilder will be used.
 * @property {'text'|'outlined'|'raised'|'unelevated'} [style='text'] - The style of the button
 * @property {Element} [icon] - An icon to add to the button
 * @property {boolean} [iconTrailing=true] - Wether the icon should be trailing the button text
 * @property {Function} [onAction] - The callback to run when the button has its action triggered
 */

/**
 * ButtonFactory can create buttons
 */
ButtonSystem.ButtonFactory = class ButtonFactory {
    /**
     * Create a new button
     *
     * @example
     * ButtonFactory.createButton("MyButton", {
     *     style: "outlined",
     *     onAction: ()=>{
     *         //Someone pressed my button
     *     }
     * });
     *
     * @param {String} text - The text of the button
     * @param {ButtonSystem~ButtonConfig} options
     * @returns {ButtonSystem.Button}
     */
    static createButton(text, options) {
        if(options.builder == null) {
            if(ButtonFactory.defaultBuilder == null) {
                throw "Attempt to create Button with defaultBuilder but no default builder is set!";
            }

            options.builder = ButtonFactory.defaultBuilder;
        }

        if(options.style == null) {
            options.style = "text";
        }

        return new ButtonSystem.Button(text, options);
    }
    
    /**
     * Sets the defailt button builder
     * @param {ButtonBuilder} builder
     */
    static setDefaultBuilder(builder) {
        ButtonFactory.defaultBuilder = builder;
    }
}

ButtonSystem.ButtonFactory.defaultBuilder = null;

ButtonSystem.ButtonBuilder = class ButtonBuilder {
    /**
     * Build the DOM for the given button
     * @param button
     */
    static buildButton(button) {
        //Override in subclass
    }
}

/**
 * Button represents a Button
 * @type {ButtonSystem.Button}
 */
ButtonSystem.Button = class Button {
    /**
     * @param {String} text - The text of the button
     * @param {ButtonSystem~ButtonConfig} options
     */
    constructor(text, options) {
        let self = this;

        this.text = text;
        this.options = options;

        /** @member {Element} - The DOM element of this button */
        this.html = this.options.builder.buildButton(this);

        this.html.addEventListener("click", ()=>{
            if(self.options.onAction != null) {
                self.options.onAction();
            }
        });
    }
}

</script>

            </div>

            <div class="package" id="ButtonSystem_MaterialDesign">
                <script id="descriptor-script" type="descriptor">
{
    "friendlyName": "Buttons",
    "description": "Buttons for all",
    "dependencies": [
        "#WebstrateComponents_Tools",
        "#ButtonSystem"
    ],
    "assets": [
    ],
    "version": "0.1",
    "license": "Apache 2.0",
    "changelog": {
        "0.1": "Initial version"
    }
}

</script>

                <script id="buttons-material-script" type="disabled">
/**
 *  Material Buttons
 *  Provides MDC buttons
 * 
 *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/
    
/**
 * Provides MDC buttons
 */
ButtonSystem.MaterialBuilder = class MaterialBuilder {
    static buildButton(button) {
        let buttonHtml = WebstrateComponents.Tools.loadTemplate("ButtonSystem_MaterialDesign_Button");

        buttonHtml.querySelector(".mdc-button__label").textContent = button.text;

        let buttonType = WebstrateComponents.Tools.fromConfig(button.options, "style", "text");

        switch(buttonType) {
            case "text":
                break;
            case "outlined":
            case "raised":
            case "unelevated":
                buttonHtml.classList.add("mdc-button--"+buttonType);
                break;
        }

        let icon = WebstrateComponents.Tools.fromConfig(button.options, "icon", null);

        if(icon != null) {
            let filteredClasses = Array.from(icon.classList.values()).filter((c)=>{
                return c.startsWith("material-icons");
            });
            if(filteredClasses.length > 0) {
                icon.classList.add("mdc-button__icon");
            }

            if(WebstrateComponents.Tools.fromConfig(button.options, "iconTrailing", false)) {
                buttonHtml.appendChild(icon);
            } else {
                buttonHtml.insertBefore(icon, buttonHtml.firstChild);
            }
        }

        mdc.ripple.MDCRipple.attachTo(buttonHtml);

        return buttonHtml;
    }
}

ButtonSystem.ButtonFactory.setDefaultBuilder(ButtonSystem.MaterialBuilder);

</script>

                <template id="ButtonSystem_MaterialDesign_Button">
    <button class="mdc-button"><span class="mdc-button__ripple"></span><span class="mdc-button__label"></span></button>
</template>

            </div>

            <div class="package" id="MaterialMenu">
                <script id="descriptor-script" type="descriptor">
{
    "friendlyName": "MaterialMenu",
    "description": "MDC bindings for MenuSystem visualization",
    "dependencies": [
        "wpm_js_libs #material-design-components",
        "wpm_js_libs #material-design-icons",
        "#wsc-icon-registry",
        "#MenuSystem"
    ],
    "assets": [],
    "version": "0.1",
    "license": "Apache 2.0",
    "changelog": {
        "0.1": "Initial version"
    }
}

</script>

                <script id="MaterialMenu-script" type="disabled">
/**
 *  MaterialMenuBuilder
 *  MDC binding for visual presentation of menus
 * 
 *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/

/*global mdc*/

window.MenuSystem.MaterialMenuBuilder = class MaterialMenuBuilder extends MenuSystem.MenuBuilder {
    static buildMenuHtml(menu) {
        let tpl = WebstrateComponents.Tools.loadTemplate("MenuSystem_MaterialMenu_Menu");
        
        //Setup MDC menu
        tpl.mdcMenu =  new mdc.menu.MDCMenu(tpl);

        if(menu.options.defaultFocusState != null) {
            tpl.mdcMenu.setDefaultFocusState(menu.options.defaultFocusState);
        }

        //Hook mdc-menu-surface close
        let origClose = tpl.mdcMenu.menuSurface.foundation.close;
        tpl.mdcMenu.realClose = function () {
            origClose.call(tpl.mdcMenu.menuSurface.foundation);
        };
        tpl.mdcMenu.menuSurface.foundation.close = function() {
            //Empty on purpose
        };

        //Setup listeners
        tpl.mdcMenu.listen("MDCMenu:selected", (evt)=>{
            menu.handleItemAction(evt.detail.item.menuItem);
        });

        return tpl;
    }

    static buildMenuItemHtml(menuItem) {
        let tpl = WebstrateComponents.Tools.loadTemplate("MenuSystem_MaterialMenu_MenuItem");
        
        tpl.querySelector(".mdc-list-item__text").textContent = menuItem.label;
        tpl.menuItem = menuItem;

        if(menuItem.icon != null) {
            let iconTpl = WebstrateComponents.Tools.loadTemplate("MenuSystem_MaterialMenu_MenuItem_Icon");
            tpl.insertBefore(iconTpl, tpl.firstChild);
            if(typeof menuItem.icon === "string") {
                iconTpl.textContent = menuItem.icon;
            } else if(menuItem.icon instanceof HTMLElement || menuItem.icon instanceof SVGElement) {
                iconTpl.appendChild(menuItem.icon.cloneNode(true));
            }
        }

        if(menuItem.metaIcon != null) {
            let metaIconTpl = WebstrateComponents.Tools.loadTemplate("MenuSystem_MaterialMenu_MenuItem_MetaIcon");
            tpl.insertBefore(metaIconTpl, tpl.lastChild.nextSibling);
            if(typeof menuItem.metaIcon === "string") {
                metaIconTpl.textContent = menuItem.metaIcon;
            } else if(menuItem.metaIcon instanceof HTMLElement) {
                metaIconTpl.appendChild(menuItem.metaIcon.cloneNode(true));
            }
        }
        
        if (menuItem.tooltip != null){
            tpl.setAttribute("title", menuItem.tooltip);
        }        
        
        mdc.ripple.MDCRipple.attachTo(tpl);

        if (menuItem.checked != null){
            // This is a toggle-able item, upgrade it with additional UI elements and update the state
            let checkmarkTemplate = WebstrateComponents.Tools.loadTemplate("MenuSystem_MaterialMenu_Checkmark");
            tpl.insertBefore(checkmarkTemplate, tpl.lastChild.nextSibling);
            tpl.classList.add("mdc-menu__selection-group");
            
            let wrapper = document.createElement("div");
            wrapper.classList.add("mdc-menu__selection-group");
            wrapper.appendChild(tpl);
            tpl = wrapper;
        }
        return tpl;
    }

    static clearMenuItems(menu) {
        let menuItemInsertLocation = menu.html.querySelector(".mdc-list");
        while(menuItemInsertLocation.lastChild) {
            menuItemInsertLocation.removeChild(menuItemInsertLocation.lastChild);
        }
    }

    static attachMenuItems(menu, groups) {
        let menuItemInsertLocation = menu.html.querySelector(".mdc-list");

        let first = true;

        groups.forEach((group)=>{
            if(first) {
                first = false;
            } else {
                if(menu.groupDividers) {
                    let groupDivider = WebstrateComponents.Tools.loadTemplate("MenuSystem_MaterialMenu_GroupDivider");
                    menuItemInsertLocation.appendChild(groupDivider);
                }
            }

            group.forEach((item)=>{
                menuItemInsertLocation.appendChild(item.html);
                
                // Update checked status
                if (item.checked!==null){
                    try {
                        if (item.checked()){
                            item.html.querySelector(".mdc-list-item").classList.add("mdc-menu-item--selected");
                        } else {
                            item.html.querySelector(".mdc-list-item").classList.remove("mdc-menu-item--selected");
                        }
                    } catch (ex){
                        console.warn("MenuItem caused exception in .checked ",item,ex);
                    }
                }
            });
        });
    }

    static open(menu, source) {
        if(source != null) {
            if(source.x != null && source.y != null) {
                menu.html.mdcMenu.setFixedPosition(true);
                menu.html.mdcMenu.setAbsolutePosition(source.x, source.y);
            } else if(source instanceof HTMLElement) {
                //Try fixed always if using anchor source?
                menu.html.mdcMenu.setFixedPosition(true);

                menu.html.mdcMenu.setAnchorElement(source);

                switch(menu.growDirection) {
                    case MenuSystem.Menu.GrowDirection.DOWN:
                        menu.html.mdcMenu.setAnchorCorner(mdc.menuSurface.Corner.BOTTOM_LEFT);
                        break;
                    case MenuSystem.Menu.GrowDirection.RIGHT:
                    default:
                        menu.html.mdcMenu.setAnchorCorner(mdc.menuSurface.Corner.TOP_RIGHT);
                        menu.html.mdcMenu.setAnchorMargin({
                            top: -10
                        });
                }
            }
            menu.html.style.zIndex = 9000000;           
        }

        if (menu.layoutDirection==MenuSystem.Menu.LayoutDirection.HORIZONTAL){
            menu.html.classList.add("mdc-tweaks-horizontal-menu");
        }
        if (menu.layoutWrapping===false){
            menu.html.classList.add("mdc-tweaks-nonwrapping-menu");
        }        
        if (menu.layoutCompact===true){
            menu.html.classList.add("mdc-tweaks-compact-menu");
        }

        if(!menu.defaultFocus) {
            menu.html.mdcMenu.setDefaultFocusState(0);
        }

        menu.html.mdcMenu.open = true;
    }

    static close(menu) {
        menu.html.mdcMenu.realClose();
    }

    static destroyMenu(menu) {
        menu.html.mdcMenu.destroy();
        delete menu.html["mdcMenu"];
    }

    static destroyMenuItem(item) {
    }
    
    static setItemActive(item, active){
        if(active) {
            item.html.classList.add("mdc-list-item--activated");
        } else {
            item.html.classList.remove("mdc-list-item--activated");
        }
    }

    static createSubmenuIcon() {
        return IconRegistry.createIcon("mdc:chevron_right");
    }
};

MenuSystem.MenuManager.createMaterialMenu = (menuName, menuConfig = {}) => {
    menuConfig.builder = MenuSystem.MaterialMenuBuilder;
    return MenuSystem.MenuManager.createMenu(menuName, menuConfig);
};

MenuSystem.MenuManager.setDefaultBuilder(MenuSystem.MaterialMenuBuilder);

</script>

                <template id="MenuSystem_MaterialMenu_Menu">
    <div class="mdc-menu mdc-menu-surface">
        <ul class="mdc-list" role="menu" aria-orientation="vertical" tabindex="-1">
        </ul>
      </div>    
</template>

<template id="MenuSystem_MaterialMenu_MenuItem">
    <li class="mdc-list-item" role="menuitem">        
        <span class="mdc-list-item__ripple"></span>
        <span class="mdc-list-item__text"></span>
    </li>
</template>

<template id="MenuSystem_MaterialMenu_MenuItem_Icon">
    <span class="mdc-list-item__graphic"></span>
</template>

<template id="MenuSystem_MaterialMenu_MenuItem_MetaIcon">
    <span class="mdc-list-item__meta"></span>
</template>

<template id="MenuSystem_MaterialMenu_GroupDivider">
    <li class="mdc-list-divider" role="separator"></li>
</template>

<template id="MenuSystem_MaterialMenu_Checkmark">
    <span class="mdc-list-item__graphic mdc-menu__selection-group-icon material-icons">check</span>    
</template>

                <style id="main-style">
/**
 *  MaterialMenuBuilder Styles
 * 
 *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/
.menusystem-menu.mdc-menu {
  /* Horizontally layouted menus require emulation */ }
  .menusystem-menu.mdc-menu .mdc-list-item.MenuSystem_MenuItem_Active {
    background: red;
    /* deprecated, remove? */ }
  .menusystem-menu.mdc-menu .mdc-list-item__meta {
    display: flex; }
  .menusystem-menu.mdc-menu.mdc-tweaks-horizontal-menu {
    position: relative;
    max-width: none;
    max-height: none;
    overflow: initial;
    box-shadow: none;
    background: transparent;
    min-width: auto; }
    .menusystem-menu.mdc-menu.mdc-tweaks-horizontal-menu > .mdc-list {
      display: flex;
      flex-wrap: wrap;
      padding: 0; }
      .menusystem-menu.mdc-menu.mdc-tweaks-horizontal-menu > .mdc-list > .mdc-list-item {
        height: 1.75em;
        font-size: 0.8em; }
        .menusystem-menu.mdc-menu.mdc-tweaks-horizontal-menu > .mdc-list > .mdc-list-item > .mdc-list-item__meta {
          display: none; }
  .menusystem-menu.mdc-menu.mdc-tweaks-nonwrapping-menu > .mdc-list {
    flex-wrap: nowrap; }
  .menusystem-menu.mdc-menu.mdc-tweaks-compact-menu > .mdc-list > .mdc-list-item {
    padding: 0; }
</style>

            </div>

            <div class="package" id="TreeBrowser">
                <script id="descriptor-script" type="descriptor">
{
    "friendlyName": "Tree Browser",
    "description": "Generic component for rendering tree-like navigation structures",
    "dependencies": [
        "wpm_js_libs #material-design-components",
        "wpm_js_libs #material-design-icons",
        "wpm_js_libs #CaviDraggableHTML5",
        "wpm_js_libs #CaviTouch",
        "wpm_js_libs #UUIDGenerator",
        "#WebstrateComponents_Tools",
        "#wsc-icon-registry",
        "codestrates-repos #EventSystem"
    ],
    "assets": [],
    "version": "1.0",
    "license": "Apache 2.0",
    "changelog": {
        "1.0": "Initial version"
    }
}

</script>

                <style id="mdc-treebrowser-style">
/**
 *  TreeBrowser Styles
 * 
 *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/
@keyframes tree-browser-children-appear {
  from {
    opacity: 0;
    transform: translateX(-1em); }
  to {
    opacity: 1;
    transform: translateX(0); } }

@keyframes tree-browser-hoveractions-appear {
  from {
    opacity: 0; }
  to {
    opacity: 1; } }

ul.tree-browser {
  padding: 0;
  user-select: none; }
  ul.tree-browser .tree-browser-children {
    display: none;
    padding-left: 0.75em;
    padding-bottom: 0.1em; }

.tree-browser-node {
  height: 1.5em;
  align-items: center;
  padding: 0;
  contain: paint;
  overflow: hidden; }
  .tree-browser-node .rippley {
    width: 100%;
    position: absolute;
    left: 0;
    height: 100%;
    top: 0;
    overflow: hidden;
    pointer-events: none; }
  .tree-browser-node .mdc-list-item__graphic {
    margin-right: 0em; }
    .tree-browser-node .mdc-list-item__graphic .tree-browser-custom-icon {
      max-width: 24px;
      max-height: 80%; }
      .tree-browser-node .mdc-list-item__graphic .tree-browser-custom-icon .wsc-registry-icon {
        height: auto; }
  .tree-browser-node .tree-browser-navigator {
    transition: transform 0.1s ease-out; }
  .tree-browser-node .mdc-list-item__text {
    font-size: 0.8em;
    margin-left: 0.4em; }
  .tree-browser-node .tree-browser-hoveractions {
    display: none;
    width: initial;
    animation: 0.1s tree-browser-hoveractions-appear ease-out; }
  .tree-browser-node:hover > .tree-browser-hoveractions, .tree-browser-node:focus > .tree-browser-hoveractions {
    display: block; }
  .tree-browser-node .tree-browser-icons {
    display: flex;
    position: relative; }
  .tree-browser-node .tree-browser-icon {
    display: flex;
    margin: 0.1em; }
    .tree-browser-node .tree-browser-icon .tree-browser-icon-unfolded {
      display: none; }
  .tree-browser-node.tree-browser-unfolded > .tree-browser-navigator {
    transform: rotate(90deg); }
  .tree-browser-node.tree-browser-unfolded + li.tree-browser-children {
    display: block; }
  .tree-browser-node.tree-browser-unfolded .tree-browser-icon .tree-browser-icon-unfolded {
    display: initial; }
  .tree-browser-node.tree-browser-unfolded .tree-browser-icon .tree-browser-icon-closed {
    display: none; }
  .tree-browser-node.tree-browser-node-hidden {
    display: none; }
    .tree-browser-node.tree-browser-node-hidden + li.tree-browser-children {
      padding-left: 0; }

.tree-browser-modifier {
  position: absolute;
  top: 0;
  left: 0;
  filter: drop-shadow(1px 1px 2px white); }
  .tree-browser-modifier.tree-browser-modifier-a {
    transform: translate(45%, -30%) scale(0.4); }
  .tree-browser-modifier.tree-browser-modifier-b {
    transform: translate(-50%, -30%) scale(0.4); }

/* Playground */
.mdc-list-item::before {
  pointer-events: none; }
</style>

                <script id="TreeBrowser-script" type="disabled">
/**
 *  TreeBrowser
 *  A navigation tool for presenting data as tree structures
 * 
 *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/

/* global mdc */

/**
 * Called when a TreeNode is selected in a TreeBrowser
 *
 * @event TreeBrowser#EventSystem:"TreeBrowser.Selection"
 * @type {CustomEvent}
 * @property {TreeNode} selection - The selected TreeNode
 */

/**
 * Called when a TreeNode's action is triggered. (Ie. double click it)
 *
 * @event TreeNode#EventSystem:"TreeBrowser.TreeNode.Action"
 * @type {CustomEvent}
 * @property {TreeNode} node - The node which had its action triggered
 */

/**
 * TreeBrowser can take a TreeNode and construct a browsable tree
 */
class TreeBrowser {
    /**
     * Create a TreeBrowser with the given TreeNode as root
     *
     * @param {TreeNode} rootNode
     * @param {TreeBrowser~options} options
     */
    constructor(rootNode) {
        let self = this;

        /** @member {TreeNode} - The root node used to build the tree */
        this.rootNode = rootNode;

        /** @member {Element} - The DOM Element of this Tree */
        this.html = WebstrateComponents.Tools.loadTemplate("TreeBrowser_Main");

        /** @member {MDCList} - The MDCList object from Material Design */
        this.mdcList = new mdc.list.MDCList(this.html);
        this.mdcList.singleSelection = true;
        
        this.html.mdcList = this.mdcList;

        this.mdcList.listen("MDCList:action", (evt)=>{
            let listItem = self.mdcList.listElements[evt.detail.index];

            EventSystem.triggerEvent("TreeBrowser.Selection", {
                selection: listItem.treeNode
            });
        });

        this.rootNode.insertIntoDom(this.html, null);

        this.rootNode.treeBrowser = this;

        this.html.treeBrowser = this;

        this.html.addEventListener("keyup", (evt)=>{
            let selectedItem = self.mdcList.listElements[self.mdcList.selectedIndex];

            if(selectedItem == null) {
                return;
            }

            EventSystem.triggerEvent("TreeBrowser.Keyup", {
                evt: evt,
                treeNode: selectedItem.treeNode
            });

            if(evt.key === "Enter") {
                selectedItem.treeNode.triggerAction();
            } else if(evt.key === "ArrowRight") {
                selectedItem.treeNode.unfold();
            } else if(evt.key === "ArrowLeft") {
                selectedItem.treeNode.fold();
            } else if(evt.key === "ArrowDown") {
                let focusedItem = self.mdcList.listElements[self.mdcList["foundation"].adapter.getFocusedElementIndex()];
                if(focusedItem != null) {
                    self.setSelected(focusedItem.treeNode);
                }
            } else if(evt.key === "ArrowUp") {
                let focusedItem = self.mdcList.listElements[self.mdcList["foundation"].adapter.getFocusedElementIndex()];
                if(focusedItem != null) {
                    self.setSelected(focusedItem.treeNode);
                }
            }
        });

        this.html.addEventListener("keydown", (evt)=>{
            let selectedItem = self.mdcList.listElements[self.mdcList.selectedIndex];

            if(selectedItem == null) {
                return;
            }

            EventSystem.triggerEvent("TreeBrowser.Keydown", {
                evt: evt,
                treeNode: selectedItem.treeNode
            });
        });
    }

    /**
     * Sets the given TreeNode as the current selection
     * @param {TreeNode} treeNode
     */
    setSelected(treeNode) {
        let index = -1;

        let i = 0;
        this.html.mdcList.listElements.forEach((elm)=>{
            if(elm === treeNode.html) {
                index = i;
            }

            i++;
        });

        if(index !== -1) {
            this.mdcList.selectedIndex = index;
            this.mdcList.foundation.adapter.focusItemAtIndex(index);
            EventSystem.triggerEvent("TreeBrowser.Selection", {
                selection: treeNode
            });
        }
    }

    /**
     * Finds all TreeNode's that has the given context
     * @param context
     * @returns {TreeNode[]}
     */
    findTreeNodeForContext(context) {
        function lookupContext(node) {
            let foundNodes = [];

            if(node.context === context) {
                foundNodes.push(node);
            }

            for(let child of node.childNodes) {
                foundNodes.push(...lookupContext(child));
            }

            return foundNodes;
        }

        return lookupContext(this.rootNode);
    }
    
    /**
     * Finds all TreeNodes that have the given lookupKey
     * @param key
     * @returns {TreeNode[]}
     */
    findTreeNode(lookupKey) {
        function lookupTheLookupKey(node) {
            let foundNodes = [];

            if(node.lookupKey === lookupKey) {
                foundNodes.push(node);
            }

            for(let child of node.childNodes) {
                foundNodes.push(...lookupTheLookupKey(child));
            }

            return foundNodes;
        }

        return lookupTheLookupKey(this.rootNode);
    }    

    /**
     * Find all TreeBrowsers currently in the DOM
     * @returns {TreeBrowser[]}
     */
    static findAllTreeBrowsers() {
        return Array.from(document.querySelectorAll(".tree-browser-root")).map((dom)=>{
            return dom.treeBrowser;
        });
    }
}

window.TreeBrowser = TreeBrowser;

/**
 * @typedef {Object} TreeNode~config
 * @property {string} type - The type of this TreeNode, ex. "DomTreeNode", "AssetNode", "AssetRootNode"
 * @property {*} context - The context of this TreeNode
 * @property {boolean} [alwaysOpen=false] - If this TreeNode should stay unfolded
 * @property {*} [lookupKey=context] - The lookupkey to use when TreeGenerator saves this TreeNode for later lookup
 * @property {boolean} [startOpen=false] - If this TreeNode should start unfolded
 * @property {boolean} [hideSelf=false] - If this TreeNode should be hidden.
 */

/**
 * Represents a tree node
 */
class TreeNode {
    /**
     * Create a new TreeNode with the given configuration
     * @param {TreeNode~config} config - The configuration for this TreeNode
     */
    constructor(config) {
        let self = this;

        this.config = config;

        /** @memeber {string} - The type of this TreeNode */
        this.type = this.getProperty("type");
        /** @memeber {*} - The context of this TreeNode */
        this.context = this.getProperty("context");

        /** @memeber {boolean} - If this TreeNode should always stay unfolded */
        this.alwaysOpen = this.getProperty("alwaysOpen", false);

        this.startOpen = this.getProperty("startOpen", false);

        this.lookupKey = this.getProperty("lookupKey", this.context);

        /** @member {TreeNode[]} - The children of this TreeNode */
        this.childNodes = [];

        /** @member {Element} - The DOM Element of this TreeNode */
        this.html = WebstrateComponents.Tools.loadTemplate("TreeBrowser_Leaf");
        this.html.treeNode = this;

        this.hideSelf = this.getProperty("hideSelf", false);

        this.childrenHtml = WebstrateComponents.Tools.loadTemplate("TreeBrowser_Children");
        this.childrenUl = this.childrenHtml.querySelector("ul.tree-browser");

        /** @member {TreeNode} - The parent node of this TreeNode */
        this.parentNode = null;

        /** @member {Element[]} - Meta icons of this TreeNode */
        this.metaIcons = [];

        this.html.addEventListener("mouseup", (evt)=>{
            if(evt.button === 2) {
                self.select();
            }
        });

        this.onDecoratedCallbacks = new Set();

        self.html.querySelector(".tree-browser-navigator").addEventListener("click", ()=>{
            if(!self.isLeaf()) {
                if(self.alwaysOpen) {
                    self.unfold();
                } else {
                    self.toggleFold();
                }
            }
        });

        if(this.startOpen) {
            this.unfold();
            console.log("Opening up!");
        } else {
            this.fold();
        }

        this.setupContextMenu();

        this.setupMetaMenu();

        this.setupDragging();

        this.render();

        this.setupClickListeners();
    }

    get hideSelf() {
        return this.html.classList.contains("tree-browser-node-hidden");
    }

    set hideSelf(hide) {
        if(hide) {
            this.html.classList.add("tree-browser-node-hidden");
        } else {
            this.html.classList.remove("tree-browser-node-hidden");
        }
    }

    /**
     * Return the TreeBrowser at the top of the tree this TreeNode is in, if any
     * @returns {null|TreeBrowser}
     */
    getTreeBrowser() {
        if(this.treeBrowser != null) {
            return this.treeBrowser;
        } else if(this.parentNode != null) {
            return this.parentNode.getTreeBrowser();
        }

        return null;
    }

    /**
     * @private
     * @param parent
     */
    insertIntoDom(parent) {
        parent.appendChild(this.html);
        parent.insertBefore(this.childrenHtml, this.html.nextElementSibling);
    }

    /**
     * @private
     */
    removeFromDom() {
        this.html.remove();
        this.childrenHtml.remove();
        if(this.nextAnimFrame != null) {
            cancelAnimationFrame(this.nextAnimFrame);
            this.nextAnimFrame = null;
        }
    }

    /**
     * Retrieve the value of the given property
     * @param {String} propertyName
     * @param {*} [defaultValue] - The default value if the property does not exist
     * @returns {*}
     */
    getProperty(propertyName, defaultValue = null) {
        return WebstrateComponents.Tools.fromConfig(this.config, propertyName, defaultValue);
    }

    /**
     * Sets the value of the given property
     * @param {String} propertyName
     * @param {*} value
     */
    setProperty(propertyName, value) {
        this.config[propertyName] = value;
    }

    /**
     * Add a meta icon to this TreeNode
     * @param {*} icon
     */
    addMetaIcon(icon) {
        this.metaIcons.push(icon);
        this.render();
    }

    /**
     * Remove a meta icon from this TreeNode
     * @param {*} icon
     */
    removeMetaIcon(icon) {
        this.metaIcons.splice(this.metaIcons.indexOf(icon),1);
        this.render();
    }

    /**
     * Add a child node to this node at a given index
     * @param {Number} index
     * @param {TreeNode} node
     */
    addNode(node, index = -1) {
        node.parentNode = this;

        if(this.isFolded()) {
            node.html.classList.remove("mdc-list-item");
        } else {
            node.html.classList.add("mdc-list-item");
        }

        if(index === -1) {
            this.childNodes.push(node);
        } else {
            this.childNodes.splice(index, 0, node);
        }

        this.updateChildren();
    }

    /**
     * Remove a child node from this node
     * @param {TreeNode} node
     */
    removeNode(node) {
        if(this.childNodes.indexOf(node) !== -1) {
            this.childNodes.splice(this.childNodes.indexOf(node), 1);
            node.removeFromDom();
        }
    }

    /**
     * Removes all child nodes from this TreeNode
     */
    clearNodes() {
        let self = this;
        let childNodeClone = this.childNodes.slice();
        childNodeClone.forEach((child)=>{
            self.removeNode(child);
        });
    }

    /**
     * Checks if this TreeNode has any children
     * @returns {boolean} True/False depending on if this TreeNode has any children
     */
    isLeaf() {
        let visibleChildNodes = this.childNodes.filter((child)=>{
            return !child.hideSelf;
        });

        return visibleChildNodes.length === 0;
    }

    /**
     * Unfold this TreeNode
     */
    unfold() {
        if(!this.isLeaf()) {
            this.html.classList.add("tree-browser-unfolded");

            this.childNodes.forEach((child)=>{
                child.html.classList.add("mdc-list-item");
            });
        }
    }

    /**
     * Fold this TreeNode
     */
    fold() {
        if(this.alwaysOpen) {
            return;
        }

        this.html.classList.remove("tree-browser-unfolded");

        this.childNodes.forEach((child)=>{
            child.html.classList.remove("mdc-list-item");
        });
    }

    /**
     * Toggle fold state of this TreeNode
     */
    toggleFold() {
        if(this.html.classList.contains("tree-browser-unfolded")) {
            this.fold();
        } else {
            this.unfold();
        }
    }

    /**
     * Check wether this TreeNode is folded or unfolded
     * @returns {boolean} - True of this TreeNode is folded, false if unfolded
     */
    isFolded() {
        return !this.html.classList.contains("tree-browser-unfolded");
    }

    /**
     * Make this TreeNode the selected node in the tree
     */
    select() {
        let self = this;

        let treeBrowser = this.getTreeBrowser();

        if(treeBrowser != null) {
            treeBrowser.setSelected(this);
            EventSystem.triggerEvent("TreeBrowser.Selection", {
                selection: self
            });
        }
    }

    /**
     * Make this TreeNode and all parent TreeNode's unfold,
     */
    reveal() {
        this.unfold();

        if(this.parentNode != null) {
            this.parentNode.reveal();
        }
    }

    /**
     * Called when we are removed from the tree
     */
    onRemoved() {
        this.removeFromDom();
    }

    /**
     * Called when this TreeNode has been decorated
     */
    onDecorated() {
        let self = this;

        this.render();

        this.onDecoratedCallbacks.forEach((callback)=>{
            callback(self);
        });
    }

    /**
     * @private
     */
    setupContextMenu() {
        let self = this;

        if(window.MenuSystem != null) {
            this.html.addEventListener("contextmenu", (evt)=>{
                evt.preventDefault();
            });

            let contextMenu = null;

            this.html.addEventListener("mouseup", (evt)=>{
                if(evt.button !== 2) {
                    return;
                }
                self.select();

                //Find top component after html
                let parent = self.html;
                while(parent.parentNode != null && !parent.parentNode.matches("html")) {
                    parent = parent.parentNode;
                }

                //Setup context menus
                if(contextMenu == null) {
                    contextMenu = MenuSystem.MenuManager.createMenu("TreeBrowser.TreeNode.ContextMenu", {
                        context: self,
                        groupDividers: true
                    });

                    contextMenu.registerOnCloseCallback(() => {
                        if (contextMenu.html.parentNode != null) {
                            contextMenu.html.parentNode.removeChild(contextMenu.html);
                        }
                    });
                }

                parent.appendChild(contextMenu.html);
                contextMenu.open({
                    x: evt.pageX,
                    y: evt.pageY
                });
                evt.stopPropagation();
                evt.preventDefault();
            });
        }
    }

    /**
     * @private
     */
    updateChildren() {
        let self = this;

        this.render();

        if(this.updateChildrenAnimFrame != null) {
            return;
        }

        this.updateChildrenAnimFrame = requestAnimationFrame(()=>{
            //Reinsert all nodes?
            self.childNodes.forEach((child)=>{
                child.insertIntoDom(self.childrenUl);
            });

            self.updateChildrenAnimFrame = null;
        });
    }

    /**
     * @private
     */
    render() {
        let self = this;

        if(this.nextAnimFrame != null) {
            //We are already scheduled to render
            return;
        }

        this.nextAnimFrame = requestAnimationFrame(()=>{
            let content = self.getProperty("content");

            let contentContainer = self.html.querySelector(":scope > .tree-browser-content");
            while(contentContainer.lastChild) contentContainer.lastChild.remove();

            if(content != null) {
                if (typeof content === "string") {
                    contentContainer.textContent = content;
                } else if (content instanceof Element) {
                    contentContainer.appendChild(content);
                } else {
                    contentContainer.textContent = "Unknown 'content' [" + (typeof content) + "]:[" + JSON.stringify(content) + "]";
                }
            }
            
            // Tooltips
            let tooltip = self.getProperty("tooltip");
            if (tooltip != null){
                self.html.setAttribute("title", tooltip);
            }

            let icon = self.getProperty("icon");

            let iconContainer = self.html.querySelector(":scope > .tree-browser-icons");

            let oldIcon = iconContainer.querySelector(".tree-browser-icon");
            if(oldIcon != null) {
                oldIcon.remove();
            }

            if(icon != null) {
                if(typeof icon === "string") {
                    //Probabely wrong!
                    let textSpan = document.createElement("span");
                    textSpan.textContent = icon;
                    icon = textSpan;
                }

                icon.classList.add("tree-browser-icon");
                iconContainer.append(icon);
            }

            ["a", "b", "c", "d"].forEach((modifierType)=>{
                //Remove old modifier
                let oldModifier = iconContainer.querySelector(".tree-browser-modifier-"+modifierType);

                if(oldModifier != null) {
                    oldModifier.remove();
                }

                let modifier = self.getProperty("modifier-"+modifierType);

                if(modifier != null) {
                    let tpl = WebstrateComponents.Tools.loadTemplate("TreeBrowser_Modifier");
                    tpl.classList.add("tree-browser-modifier-"+modifierType);

                    if(typeof modifier === "string") {
                        let textSpan = document.createElement("span");
                        textSpan.textContent = modifier;
                        modifier = textSpan;
                    }

                    tpl.appendChild(modifier);

                    iconContainer.appendChild(tpl);
                }
            });

            let metaIconContainer = self.html.querySelector(":scope > .mdc-list-item__meta");
            while(metaIconContainer.lastChild) metaIconContainer.lastChild.remove();

            self.metaIcons.forEach((icon)=>{
                metaIconContainer.appendChild(icon);
            });

            if(self.isLeaf()) {
                if(!self.html.classList.contains("tree-browser-leaf")) {
                    self.html.querySelector(".tree-browser-navigator").innerHTML = "";
                    self.html.classList.add("tree-browser-leaf");
                }

                this.fold();
            } else {
                if(self.html.classList.contains("tree-browser-leaf")) {
                    let icon = (IconRegistry.createIcon("mdc:chevron_right"));
                    self.html.querySelector(".tree-browser-navigator").appendChild(icon);
                    self.html.classList.remove("tree-browser-leaf");
                }

                if(self.alwaysOpen) {
                    self.unfold();
                }
            }

            self.nextAnimFrame = null;
        });
    }

    /**
     * @private
     */
    setupDragging() {
        let self = this;

        let uuid = UUIDGenerator.generateUUID();

        this.html.setAttribute("transient-drag-id", uuid);

        let hoverStartTime = -1;

        new CaviDraggableHTML5(this.html, {
            onDragStart: (evt)=>{
                evt.dataTransfer.setData("treenode/href", location.href);
                evt.dataTransfer.setData("treenode/uuid", uuid);
                evt.dataTransfer.setData("treenodedata/uuid|"+uuid, "");
                TreeGenerator.decorateDataTransfers(self, evt.dataTransfer);
            },
            onDragComplete: (evt)=>{
                if(evt.dataTransfer.dropEffect !== "none") {
                    EventSystem.triggerEvent("TreeBrowser.TreeNode.DragEnd", {
                        draggedNode: self,
                        dropEffect: evt.dataTransfer.dropEffect,
                        dragEvent: evt
                    });
                }
            }
        });

        new CaviDroppableHTML5(this.html, {
            onDragLeave: (evt)=>{
                hoverStartTime = -1;
                EventSystem.triggerEvent("TreeBrowser.TreeNode.DragLeave", {
                    node: self,
                    dragEvent: evt
                });
            },
            onDragOver: (evt)=>{
                evt.dataTransfer.dropEffect = "none";

                if(hoverStartTime === -1) {
                    hoverStartTime = Date.now();
                }

                let hoverTime = Date.now() - hoverStartTime;

                if(hoverTime > 1000) {
                    self.unfold();
                }

                EventSystem.triggerEvent("TreeBrowser.TreeNode.DragOver", {
                    node: self,
                    dragEvent: evt
                });
            },
            onDrop: (evt, dropEffect)=>{
                let otherWebstrate = null;

                if(evt.dataTransfer.types.includes("treenode/href")) {
                    otherWebstrate = evt.dataTransfer.getData("treenode/href");
                }

                if(evt.dataTransfer.types.includes("treenode/uuid")) {
                    try {
                        let dragUUID = evt.dataTransfer.getData("treenode/uuid");
                        let dragged = document.querySelector("[transient-drag-id='" + dragUUID + "']");
                        if (dragged != null && dragged.treeNode != null) {
                            EventSystem.triggerEvent("TreeBrowser.TreeNode.Dropped", {
                                draggedNode: dragged.treeNode,
                                droppedNode: self,
                                dropEffect: dropEffect,
                                otherWebstrate: otherWebstrate,
                                dragEvent: evt
                            });
                            return;
                        }
                    } catch(e) {
                        console.log("Error accepting drop as treenode/uuid", );
                    }
                }

                if(evt.dataTransfer.types.includes("Files")) {
                    try {
                        EventSystem.triggerEvent("TreeBrowser.Files.Dropped", {
                            files: evt.dataTransfer.files,
                            droppedNode: self,
                            otherWebstrate: otherWebstrate,
                            dragEvent: evt
                        });

                        return;
                    } catch(e) {
                        console.log("Error accepting drop as Files", e);
                    }
                }

                if(evt.dataTransfer.types.includes("treenode/asset")) {
                    try {
                        let assetUrl = evt.dataTransfer.getData("treenode/asset");
                        EventSystem.triggerEvent("TreeBrowser.Asset.Dropped", {
                            assetUrl: assetUrl,
                            droppedNode: self,
                            otherWebstrate: otherWebstrate,
                            dragEvent: evt
                        });

                        return;
                    } catch(e) {
                        console.log("Error accepting drop as Asset", e);
                    }
                }

                if(evt.dataTransfer.types.includes("text/plain")) {
                    try {
                        let text = evt.dataTransfer.getData("text/plain");

                        let tpl = document.createElement("template");
                        tpl.innerHTML = text;

                        WPMv2.stripProtection(tpl.content);

                        EventSystem.triggerEvent("TreeBrowser.DomFragment.Dropped", {
                            fragment: tpl.content,
                            droppedNode: self,
                            otherWebstrate: otherWebstrate,
                            dragEvent: evt
                        });

                        return;
                    } catch(e) {
                        console.log("Error accepting drop as text/plain", e);
                    }
                }

                console.log("No supported data transfers:", evt.dataTransfer.types.slice());

                evt.dataTransfer.types.forEach((type)=>{
                    console.log(type, evt.dataTransfer.getData(type));
                });
            }
        });
    }

    /**
     * @private
     */
    setupClickListeners() {
        let self = this;
        this.html.addEventListener("dblclick", ()=>{
            self.triggerAction();
        });
    }

    /**
     * Trigger the action listeners of this TreeNode
     */
    triggerAction() {
        let preventDefault = EventSystem.triggerEvent("TreeBrowser.TreeNode.Action", {
            node: this,
            treeBrowser: this.getTreeBrowser()
        });

        if(!preventDefault && !this.alwaysOpen) {
            this.toggleFold();
        }
    }

    registerOnDecoratedCallback(callback) {
        this.onDecoratedCallbacks.add(callback);
    }

    deregisterOnDecoratedCallback(callback) {
        this.onDecoratedCallbacks.delete(callback);
    }

    setupMetaMenu() {
        this.metaMenu = MenuSystem.MenuManager.createMenu("TreeBrowser.TreeNode.MetaMenu", {
            context: this.context,
            keepOpen: true,
            layoutDirection: MenuSystem.Menu.LayoutDirection.HORIZONTAL,
            layoutWrapping: false,
            layoutCompact: true,
            defaultFocusState: mdc.menu.DefaultFocusState.NONE
        });

        this.addMetaIcon(this.metaMenu.html);
    }
}

window.TreeNode = TreeNode;

</script>

                <script id="TreeGenerator-script" type="disabled">
/**
 *  TreeGenerator
 *  Superclass for generators of trees
 * 
 *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/

/**
 * A generator that builds trees from some context
 * @abstract
 */
class TreeGenerator {
    /**
     * Create a new TreeGenerator
     */
    constructor() {
        this.treeNodeLookup = new Map();
    }

    /**
     * Lookup the TreeNode associated with lookupKey
     * @param {*} lookupKey
     * @returns {TreeNode} The found TreeNode or null if no TreeNode could be found
     * @protected
     */
    lookupTreeNode(lookupKey) {
        return this.treeNodeLookup.get(lookupKey);
    }

    /**
     * Save the reference from lookupKey to TreeNode
     * @param {TreeNode} node - The TreeNode to save
     * @protected
     */
    saveTreeNode(node) {
        this.treeNodeLookup.set(node.lookupKey, node);
    }

    /**
     * Remove the reference from lookupKey to TreeNode
     * @param {TreeNode} node
     * @protected
     */
    deleteTreeNode(node) {
        let self = this;

        this.treeNodeLookup.delete(node.lookupKey);

        node.childNodes.forEach((child)=>{
            self.deleteTreeNode((child));
        });
    }

    /**
     * Runs through all registered decorators and tries to decorate the given node, the first decorator to do something wins.
     * @param {TreeNode} node - The TreeNode to decorate
     * @protected
     */
    static decorateNode(node) {
        for(let decorator of TreeGenerator.decorators) {
            if(typeof decorator.decorator.decorate === "function" && decorator.decorator.decorate(node)) {
                //First decorator that decorates our node, wins!
                node.onDecorated();
                break;
            }
        }
    }

    /**
     * Runs through all registered decorators and gives them a chance to add DataFlavors to the given dnd DataTransfer
     * @param {TreeNode} node
     * @param {DataTransfer} dataTransfer
     */
    static decorateDataTransfers(node, dataTransfer) {
        for(let decorator of TreeGenerator.decorators) {
            if(typeof decorator.decorator.decorateDataTransfer === "function" && decorator.decorator.decorateDataTransfer(node, dataTransfer)) {
                break;
            }
        }
    }

    /**
     * Register a decorator
     * @param decorator
     * @param {Number} priority
     */
    static registerDecorator(decorator, priority) {
        TreeGenerator.decorators.push({
            decorator: decorator,
            priority: priority
        });

        //Sort decorators according to priority
        TreeGenerator.decorators.sort((i1, i2)=>{
            return i2.priority - i1.priority;
        });
    }
}

window.TreeGenerator = TreeGenerator;

TreeGenerator.decorators = [];

</script>

                <script id="DomTreeGenerator-script" type="disabled">
/**
 *  DOM Tree Generator
 *  Generates trees based on DOM nodes
 * 
 *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/

/* global webstrate */

/**
 * @typedef {Object} DomTreeGenerator~config
 * @property {String[]} [includeRules] - An array of CSS selectors that represents what should be included even if excluded or transient. If empty, everything that is not excluded will be included.
 * @property {String[]} [excludeRules] - An array of CSS selectors that represents what should be excluded.
 * @property {boolean} [includeWebstrateTransients=false] - Should webstrate transient elements be included true/false
 * @property {boolean} [live=true] - Is the Tree live, ie. does changes to the dom reflect in the tree.
 */

/**
 * DomTreeGenerator can traverse DOM and generate TreeNode trees from the visited DOM Nodes
 */
class DomTreeGenerator extends TreeGenerator {
    /**
     * Create a new DomTreeGenerator with the given configuration
     * @param {DomTreeGenerator~config}config
     */
    constructor(config) {
        super();

        this.excludeRules = WebstrateComponents.Tools.fromConfig(config, "excludeRules", []);
        this.includeRules = WebstrateComponents.Tools.fromConfig(config, "includeRules", []);

        //Hardcode that .tree-browser is not observed, could lead to nasty infinite loops if not?
        if(this.excludeRules.indexOf(".tree-browser") === -1) {
            this.excludeRules.push(".tree-browser");
        }

        this.includeWebstrateTransients = WebstrateComponents.Tools.fromConfig(config, "includeWebstrateTransients", false);

        this.live = WebstrateComponents.Tools.fromConfig(config, "live", true);

        if(this.live) {
            this.setupObserver();
        }
    }

    /**
     * Start generation of a tree
     * @param {Element} root - The element to use as the root for this tree
     * @returns {TreeNode}
     */
    generateTree(root) {
        let self = this;

        let node = new TreeNode({
            type: "DomTreeNode",
            context: root
        });

        this.saveTreeNode(node);

        TreeGenerator.decorateNode(node);

        Array.from(root.children).forEach((child)=>{
            if(self.shouldInclude(child)) {
                let childNode = self.generateTree(child);
                node.addNode(childNode, self.findChildIndex(child));
            }
        });

        return node;
    }

    /**
     * Checks if the given HTML element should be included in the tree
     * @param {Element} node
     * @returns {boolean}
     * @private
     */
    shouldInclude(node) {
        for(let includeRule of this.includeRules) {
            if(node.matches(includeRule)) {
                return true;
            }
        }

        for(let excludeRule of this.excludeRules) {
            if(node.matches(excludeRule)) {
                return false;
            }
        }

        if((typeof webstrate !== "undefined") && !this.includeWebstrateTransients) {
            if(webstrate.config.isTransientElement(node)) {
                return false;
            }
        }

        if(this.includeRules.length === 0) {
            return true;
        } else {
            return false;
        }
    }

    /**
     * Returns the child index the given node has in its parents children NodeList
     * @param {Element} node
     * @returns {number}
     * @private
     */
    findChildIndex(node) {
        let parent = node.parentNode;

        if(parent != null) {
            let i = 0;
            for(let child of parent.children) {
                if(this.shouldInclude(child)) {
                    if(child === node) {
                        return i;
                    }

                    i++;
                }
            }
        }

        return -1;
    }

    /**
     * Setup the Live observer
     * @private
     */
    setupObserver() {
        let self = this;

        let observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                let targetTreeNode = self.lookupTreeNode(mutation.target);

                mutation.removedNodes.forEach((removedNode) => {
                    if(removedNode instanceof Element) {
                        //Removed node
                        let removedTreeNode = self.lookupTreeNode(removedNode);
                        if (removedTreeNode != null) {
                            self.deleteTreeNode(removedTreeNode);
                            removedTreeNode.onRemoved();
                            if (targetTreeNode != null) {
                                targetTreeNode.removeNode(removedTreeNode);
                            }
                        }
                    }
                });
                mutation.addedNodes.forEach((addedNode) => {
                    if(addedNode instanceof Element) {
                        if (targetTreeNode != null) {
                            if (self.shouldInclude(addedNode)) {
                                //Check if node is already added to the tree
                                if(self.lookupTreeNode(addedNode) == null) {
                                    //Added children to a treeNode
                                    let addedTreeNode = self.generateTree(addedNode);
                                    targetTreeNode.addNode(addedTreeNode, self.findChildIndex(addedNode));
                                }
                            }
                        }
                    }
                });

                if(targetTreeNode != null) {
                    TreeGenerator.decorateNode(targetTreeNode);
                }
            });
        });

        observer.observe(document, {
            childList: true,
            attributes: true,
            subtree: true,
            characterData: true
        });
    }
}

window.DomTreeGenerator = DomTreeGenerator;

</script>

                <script id="AssetTreeGenerator-script" type="disabled">
/**
 *  Asset Tree Generator
 *  Generates trees based on assets uploaded to a Webstrate
 * 
 *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/
    
class AssetTreeGenerator extends TreeGenerator {
    constructor(config) {
        super();

        this.live = WebstrateComponents.Tools.fromConfig(config, "live", true);

        if(this.live) {
            this.setupObserver();
        }

        this.rootNode = null;
    }

    generateTree() {
        let self = this;

        this.rootNode = new TreeNode({
            type: "AssetRootNode",
            context: null
        });
        if(webstrate != null && webstrate.assets && webstrate.assets.forEach!=null) {

            let filteredAssets = new Map();

            webstrate.assets.forEach((asset)=>{
                if(filteredAssets.has(asset.fileName)) {
                    let oldAsset = filteredAssets.get(asset.fileName);

                    if(asset.v > oldAsset.v) {
                        filteredAssets.set(asset.fileName, asset);
                    }
                } else {
                    filteredAssets.set(asset.fileName, asset);
                }
            });

            let sortedArray = Array.from(filteredAssets.values()).sort((a1, a2)=>{
                return a1.fileName.localeCompare(a2.fileName);
            });

            sortedArray.forEach((asset)=>{
                if(asset.deletedAt != null) {
                    //Deleted asset, skip
                    return;
                }

                let treeNode = AssetTreeGenerator.createNodeFromAsset(asset);

                self.rootNode.addNode(treeNode, self.findAssetIndex(asset));

                self.saveTreeNode(treeNode);
            });
        }

        TreeGenerator.decorateNode(this.rootNode);

        return this.rootNode;
    }

    /**
     * Create a TreeNode from an asset json
     * @param {JSON} asset
     * @returns {TreeNode}
     * @private
     */
    static createNodeFromAsset(asset) {
        let assetNode = null;
        if (asset.fileName.endsWith(".zip")){
            assetNode = new TreeNode({
                lookupKey: asset.fileName,
                context: asset,
                type: "AssetContainer"
            });
            
            // Explore the first zip level
            AssetTreeGenerator.exploreZipLevel(assetNode);
        } else {
            assetNode = new TreeNode({
                lookupKey: asset.fileName,
                context: asset,
                type: "AssetNode"
            });
        }

        TreeGenerator.decorateNode(assetNode);

        return assetNode;
    }

    /**
     * Finds an asset with the given name
     * @param {string} assetName
     * @returns {JSON} - The found asset
     */
    static findAssetFromName(assetName) {
        let filteredAssets = new Map();
        if (webstrate && webstrate.assets && webstrate.assets.forEach){
            webstrate.assets.forEach((asset)=>{
                if(filteredAssets.has(asset.fileName)) {
                    let oldAsset = filteredAssets.get(asset.fileName);

                    if(asset.v > oldAsset.v) {
                        filteredAssets.set(asset.fileName, asset);
                    }
                } else {
                    filteredAssets.set(asset.fileName, asset);
                }
            });
            return filteredAssets.get(assetName);
        } else {
            return null;
        }

    }

    /**
     * Returns the index of this asset
     * @param {JSON} asset
     * @returns {number}
     * @private
     */
    findAssetIndex(asset) {
        let filteredAssets = new Map();

        webstrate.assets.forEach((asset)=>{
            if(filteredAssets.has(asset.fileName)) {
                let oldAsset = filteredAssets.get(asset.fileName);

                if(asset.v > oldAsset.v) {
                    filteredAssets.set(asset.fileName, asset);
                }
            } else {
                filteredAssets.set(asset.fileName, asset);
            }
        });

        let sortedArray = Array.from(filteredAssets.keys()).sort((a1, a2)=>{
            return a1.localeCompare(a2);
        });

        return sortedArray.indexOf(asset.fileName);
    }

    setupObserver() {
        let self = this;

        if(webstrate != null) {
            webstrate.on("asset", (asset)=>{
                console.log("Asset event:", asset);

                let oldTreeNode = self.lookupTreeNode(asset.fileName);

                if(oldTreeNode == null) {
                    //New asset, just add
                    self.rootNode.addNode(AssetTreeGenerator.createNodeFromAsset(asset), self.findAssetIndex(asset));
                } else {
                    //Already existed, update context and redocorate
                    oldTreeNode.context = asset;
                    TreeGenerator.decorateNode(oldTreeNode);
                }
            });
        }
    }
    
    static exploreZipLevel(assetNode){
        // TODO: For now it explores the entire zip
        
        var xhr = new XMLHttpRequest();
        xhr.open('GET', assetNode.context.fileName+"/?dir", true);
        xhr.responseType = 'json';
        xhr.onload = function() {
            var status = xhr.status;
            if (status === 200) {
                xhr.response.forEach((entry)=>{
                    if (!entry.endsWith("/")){
                        let node = new TreeNode({
                            lookupKey: assetNode.context.fileName,
                            context: {
                                fileName: assetNode.context.fileName+"/"+entry,
                                v: 0
                            },                        
                            type: "AssetNode"
                        });
                        TreeGenerator.decorateNode(node);
                        assetNode.addNode(node);
                    }
                });
            } else {
                console.log("Couldn't unzip zip");
            }
        };
        xhr.send();
    }
}

window.AssetTreeGenerator = AssetTreeGenerator;

</script>

                <script id="TreeBrowserHtmlDecorator-script" type="disabled">
/**
 *  HTML Decorator
 *  Decorates HTML nodes in a tree
 * 
 *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/

/**
 * Decorator that decorates HTML elements
 */
class TreeBrowserHtmlDecorator {
    /**
     * Attempts to decorate the given TreeNode
     * @param {TreeNode} node - The node to decorate
     * @returns {boolean} True/False depending on if the node was decorated
     */
    static decorate(node) {
        if(node.type === "DomTreeNode") {

            let id = (node.context.id!=null && node.context.id.trim().length > 0)?" #"+node.context.id:"";
            let name = (node.context.getAttribute("name")!=null && node.context.getAttribute("name").trim().length > 0)?" "+node.context.getAttribute("name"):"";

            node.setProperty("content", node.context.tagName.toLowerCase()+id+name);
            node.setProperty("tooltip", "HTML DOM Element");
            let icon = null;      
            switch (node.context.tagName.toLowerCase()){
                case "body":
                    icon = IconRegistry.createIcon("mdc:accessibility_new");
                    break;
                case "script":
                    icon = IconRegistry.createIcon("mdc:code");
                    break;
                case "style":
                    icon = IconRegistry.createIcon("mdc:brush");
                    break;
                case "ol":
                case "ul":
                    icon = IconRegistry.createIcon("mdc:list");
                    break;
                default:
                    icon = IconRegistry.createIcon("mdc:html");
                    break;
                    
            }
            node.setProperty("icon", icon);
            return true;
        }

        return false;
    }

    /**
     * Attempts to decorate the given DataTransfer based on the given TreeNode
     * @param {TreeNode} node
     * @param {DataTransfer} dataTransfer
     * @returns {boolean} True/False depending on if the DataTransfer was decorated
     */
    static decorateDataTransfer(node, dataTransfer) {
        if(node.type === "DomTreeNode") {
            dataTransfer.setData("text/plain", node.context.outerHTML);

            return true;
        }

        return false;
    }
}

window.TreeBrowserHtmlDecorator = TreeBrowserHtmlDecorator;

TreeGenerator.registerDecorator(TreeBrowserHtmlDecorator, 0);

</script>

                <script id="TreeBrowserFragmentDecorator-script" type="disabled">
/**
 *  Fragment Decorator
 *  Decorates Codestrate Fragments in a tree
 * 
 *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/

/**
 * Decorator that decorates Codestrate fragments
 */
class TreeBrowserFragmentDecorator {
    /**
     * Attempts to decorate the given TreeNode
     * @param {TreeNode} node - The node to decorate
     * @returns {boolean} True/False depending on if the node was decorated
     */
    static decorate(node) {
        if(node.type === "DomTreeNode") {
            if(node.context.matches("code-folder")){
                // Set open/closed icons in the default case
                let iconNode = document.createElement("span");
                let closedNode = IconRegistry.createIcon("mdc:folder");
                closedNode.classList.add("tree-browser-icon-closed");
                iconNode.appendChild(closedNode);
                let unfoldedNode = IconRegistry.createIcon("mdc:folder_open");
                unfoldedNode.classList.add("tree-browser-icon-unfolded");
                iconNode.appendChild(unfoldedNode);                
                node.setProperty("icon", iconNode);
                let content = "Unnamed Folder";
                let name = node.context.getAttribute("name");
                if (name != null && name != ""){
                    content = name+" ";
                }
                if(node.context.id != null && node.context.id!="") {
                    content += "#"+node.context.id;
                }           
                node.setProperty("content", content);
                node.setProperty("tooltip", "Folder");
                return true;
            }
            if(node.context.matches("code-fragment")) {
                let content = "";
                let name = node.context.getAttribute("name");
                if (name != null && name != ""){
                    content = name+" ";
                }
                if(node.context.id != null && node.context.id!="") {
                    content += "#"+node.context.id;
                }
                if (!content){
                    content = node.context.tagName.toLowerCase();

                    if(typeof cQuery !== "undefined") {
                        let fragment = cQuery(node.context).data("Fragment");

                        if(fragment != null) {
                            content = fragment.constructor.name;
                        }
                    }
                }
                let type = node.context.getAttribute("data-type");

                // Find a proper icon either from an icon provider or a default one
                node.setProperty("icon", IconRegistry.createIcon(["code-fragment:"+type, "mdc:insert_drive_file"]));
                node.setProperty("content", content);
                node.setProperty("tooltip", node.context.tagName.toLowerCase()+" ("+type+")");

                if(node.context.getAttribute("auto") != null) {
                    node.setProperty("modifier-a", IconRegistry.createIcon(["A", "mdc:play_circle_outline"]));
                } else {
                    node.setProperty("modifier-a", null);
                }

                return true;
            }
        }

        return false;
    }
}

window.TreeBrowserFragmentDecorator = TreeBrowserFragmentDecorator;

TreeGenerator.registerDecorator(TreeBrowserFragmentDecorator, 10);

</script>

                <script id="TreeBrowserAssetDecorator-script" type="disabled">
/**
 *  Asset Decorator
 *  Decorates Asset nodes in a tree
 * 
 *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/

/**
 * Decorator that decorates Assets
 */
class TreeBrowserAssetDecorator {
    /**
     * Attempts to decorate the given TreeNode
     * @param {TreeNode} node - The node to decorate
     * @returns {boolean} True/False depending on if the node was decorated
     */
    static decorate(node) {
        if(node.type === "AssetNode") {
            let version = " v"+node.context.v;
            node.setProperty("content", node.context.fileName+version);
            node.setProperty("icon", IconRegistry.createIcon("mdc:attachment"));
            return true;
        } else if(node.type === "AssetContainer") {
            let version = " v"+node.context.v;
            let iconNode = document.createElement("div");
            iconNode.classList.add("tree-browser-custom-icon");
            let icon = IconRegistry.createIcon("mdc:work_outline");
            icon.classList.add("tree-browser-icon-closed");
            iconNode.appendChild(icon);
            icon = IconRegistry.createIcon("mdc:work");
            icon.classList.add("tree-browser-icon-unfolded");
            iconNode.appendChild(icon);
            node.setProperty("content", node.context.fileName+version);
            node.setProperty("icon", iconNode);
            return true;
        } else if(node.type === "AssetRootNode") {
            node.setProperty("content", "Assets");
            node.setProperty("icon", IconRegistry.createIcon("mdc:cloud"));
            return true;
        }

        return false;
    }

    /**
     * Attempts to decorate the given DataTransfer based on the given TreeNode
     * @param {TreeNode} node
     * @param {DataTransfer} dataTransfer
     * @returns {boolean} True/False depending on if the DataTransfer was decorated
     */
    static decorateDataTransfer(node, dataTransfer) {
        if(node.type === "AssetNode") {
            let uri = location.href + node.context.fileName;
            dataTransfer.setData("treenode/asset", uri);
            dataTransfer.setData("text/uri-list", uri);
            dataTransfer.setData("text/plain", uri);
            return true;
        }

        return false;
    }
}

window.TreeBrowserAssetDecorator = TreeBrowserAssetDecorator;

TreeGenerator.registerDecorator(TreeBrowserAssetDecorator, 10);

</script>

                <script id="TreeBrowserWPMDecorator-script" type="disabled">
/**
 *  WPM Decorator
 *  Handles decoration of WPM package nodes in a tree
 * 
 *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/

/**
 * Decorator that decorates HTML elements
 */
class TreeBrowserWPMDecorator {
    /**
     * Attempts to decorate the given TreeNode
     * @param {TreeNode} node - The node to decorate
     * @returns {boolean} True/False depending on if the node was decorated
     */
    static decorate(node) {
        if(node.type === "DomTreeNode" && node.context.matches("wpm-package")) {
            let id = (node.context.id!=null && node.context.id.trim().length > 0)?" #"+node.context.id:"";
            node.setProperty("content", node.context.tagName.toLowerCase() + id);
            
            // TODO: add disabled/live state to classes

            let assetRootNode = node.assetRootNode;

            node.childNodes.forEach((child)=>{
                if(child.type === "AssetRootNode") {
                    assetRootNode = child;
                }
            });

            let descriptor = node.context.querySelector("code-fragment[data-type='wpm/descriptor']");

            if(descriptor != null && typeof cQuery !== "undefined") {
                let descFrag = cQuery(descriptor).data("Fragment");

                if(descFrag != null) {

                    if(assetRootNode == null) {
                        assetRootNode = new TreeNode({
                            type: "AssetRootNode"
                        });
                        TreeGenerator.decorateNode(assetRootNode);

                        node.assetRootNode = assetRootNode;

                        //Setup event to look for asset updates

                        let self = this;

                        if(webstrate != null) {
                            webstrate.on("asset", (asset)=>{
                                updateAssets();
                            });
                        }

                        function updateAssets() {
                            if(assetRootNode != null && descFrag != null) {
                                assetRootNode.clearNodes();

                                descFrag.require().then((descJson) => {
                                    descJson.assets.forEach((assetJson) => {
                                        if (typeof assetJson === "string") {
                                            let asset = AssetTreeGenerator.findAssetFromName(assetJson);
                                            if (asset != null) {
                                                let assetNode = AssetTreeGenerator.createNodeFromAsset(asset);
                                                assetRootNode.addNode(assetNode);
                                            }
                                        }
                                    });

                                    if (assetRootNode.isLeaf()) {
                                        node.removeNode(assetRootNode);
                                    } else {
                                        node.addNode(assetRootNode, 9999);
                                        assetRootNode.render();
                                    }
                                });
                            }
                        }

                        descFrag.registerOnFragmentChangedHandler(()=>{
                            updateAssets();
                        });

                        updateAssets();
                    }
                }
            } else {
                if(assetRootNode != null) {
                    node.removeNode(assetRootNode);
                    node.assetRootNode = null;
                    assetRootNode = null;
                }
            }

            // Set open/closed icons in the default case
            let iconNode = document.createElement("span");
            iconNode.classList.add("tree-browser-custom-icon");

            let icon = IconRegistry.createIcon(["webstrates:wpm-package-closed", "mdc:insert_drive_file"]);
            icon.classList.add("tree-browser-icon-closed");
            iconNode.appendChild(icon);
            icon = IconRegistry.createIcon(["webstrates:wpm-package-open", "mdc:insert_drive_file"]);
            icon.classList.add("tree-browser-icon-unfolded");
            iconNode.appendChild(icon);

            node.setProperty("icon", iconNode);            
            return true;
        }

        //Hide wpm-descriptor inside descriptor code-fragment
        if(node.type === "DomTreeNode" && node.context.matches("wpm-descriptor")) {
            if(node.context.parentNode != null && node.context.parentNode.matches("code-fragment[data-type='wpm/descriptor']")) {
                node.hideSelf = true;
            }
        }

        return false;
    }
}

window.TreeBrowserWPMDecorator = TreeBrowserWPMDecorator;

TreeGenerator.registerDecorator(TreeBrowserWPMDecorator, 10);

</script>
                
                <template id="TreeBrowser_Main">
    <ul class="mdc-list tree-browser tree-browser-root" role="list">
    </ul>
</template>

<template id="TreeBrowser_Leaf">
    <li tabindex="-1" class="mdc-list-item tree-browser-leaf tree-browser-node">
        <div class="rippley"><span class='mdc-list-item__ripple'></span></div>
        <span class="mdc-list-item__graphic tree-browser-navigator" aria-hidden="true"></span>
        <span class="mdc-list-item__graphic tree-browser-icons" aria-hidden="true"></span>
        <span class="mdc-list-item__text tree-browser-content"></span>
        <span aria-hidden="true" class="mdc-list-item__meta"></span>
    </li>
</template>

<template id="TreeBrowser_Children">
    <li class="tree-browser-children">
        <ul class="mdc-list tree-browser" role="list">
        </ul>
    </li>
</template>

<template id="TreeBrowser_Modifier">
    <span class="tree-browser-modifier" aria-hidden="true"></span>
</template>

            </div>

            <div class="package" id="RevisionBrowser">
                <script id="descriptor-script" type="descriptor">
{
    "friendlyName": "Revision Browser",
    "description": "Browse, tag and restore revisions of your webstrate with a visual UI",
    "dependencies": [
        "wpm_js_libs #material-design-components",
        "wpm_js_libs #material-design-icons",
        "WebstrateComponents_Tools"
    ],
    "assets": [],
    "version": "1.0",
    "license": "Apache 2.0",
    "changelog": {
        "1.0": "Initial version"
    }
}

</script>

                <style id="mdc-revision-browser-style">
/**
 *  Revision Browser Styles
 * 
 *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/
@keyframes revision-browser-card-appears {
  from {
    opacity: 0; }
  to {
    opacity: 1; } }

.revision-browser-base {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  box-sizing: border-box;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(12em, auto));
  background: var(--mdc-theme-background, white); }
  .revision-browser-base .tag-button {
    margin-left: auto; }
  .revision-browser-base .revision-input-spinner {
    width: 100%; }
  .revision-browser-base .revision-browser-scrollable {
    overflow-y: auto;
    max-width: 24em; }
  .revision-browser-base .revision_framecontainer {
    flex: 1 1 auto;
    width: 100vw;
    max-width: 100%;
    min-height: 10%;
    max-height: 100%;
    display: flex;
    justify-content: stretch;
    background: white; }
  .revision-browser-base .revision-framescaler {
    flex: 1 1 auto;
    overflow: hidden;
    margin-left: 1em;
    margin-right: 1em; }
  .revision-browser-base .revision_framecontainer iframe {
    border: 0;
    animation: 0.5s revision-browser-card-appears ease-out;
    animation-delay: 0.1s;
    transform-origin: 0 0;
    transform: scale(0.5);
    width: 200%;
    height: 200%; }
  .revision-browser-base .mdc-card {
    border-radius: 0;
    flex: 1 1 auto; }
  .revision-browser-base .revision-card__primary, .revision-browser-base .mdc-card__actions {
    padding: 0em 1.5em; }
  .revision-browser-base .revision-browser-base .mdc-card__actions {
    justify-content: flex-end; }
</style>

                <script id="webstrate-revision-browser-script" type="disabled">
/**
 *  Revision Browser
 *  Manage revisions of a Webstrate in a visual editor
 * 
 *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/
   
/**
 * Manage revisions of a Webstrate in a visual editor
 */
window.RevisionBrowser = class RevisionBrowser {
    constructor() {
        let self = this;

        this.selfItemTemplate = WebstrateComponents.Tools.loadTemplate("#revisionBrowserSelfItem");
        this.listItemTemplate = WebstrateComponents.Tools.loadTemplate("#revisionBrowserListItem");
        this.cardTemplate = WebstrateComponents.Tools.loadTemplate("#revisionBrowserPresentationCard");
        this.tagTemplate = WebstrateComponents.Tools.loadTemplate("#revisionBrowserTaggingCard");

        this.html = WebstrateComponents.Tools.loadTemplate("#revision-browser-base");

        this.populateList();

        webstrate.on("tag", ()=>{
            self.populateList();
        });

        let revisionSelector = cQuery(this.html).find(".revisionSelector");
        revisionSelector[0].value = webstrate.version;

        revisionSelector.on("input", ()=>{
            if(parseInt(revisionSelector[0].value) > webstrate.version) {
                revisionSelector[0].value = webstrate.version;
            }
            self.loadRevision(revisionSelector[0].value);
            self.unselect();
            self.selectTagFromRevision(revisionSelector[0].value);

        });
    }

    loadTagUI() {
        let self = this;
        let target = cQuery(this.html).find(".revision_framecontainer");
        target.empty();
        let card = this.tagTemplate.cloneNode(true);
        let tagButton = cQuery(card).find(".tagButton");
        tagButton.on("click", ()=>{        
            let label = window.prompt("Enter wanted tag label:");

            if(label != null && label.trim() !== "") {
                webstrate.on("tag", function once(version, label) {
                    console.log("Saved tag:", version, label);
                    webstrate.off("tag", once);
                });

                webstrate.tag(label);
            }        
        });
        
        mdc.autoInit(card);        
        target.append(card);
    }

    loadRevision(revision, tagLabel = null) {
        let self = this;

        let tags = webstrate.tags();
        let tagList = Object.keys(tags).sort((v1, v2)=>{
            return parseInt(v2) - parseInt(v1);
        });

        let target = cQuery(this.html).find(".revision_framecontainer");

        let card = this.cardTemplate.cloneNode(true);
        let frameTarget = cQuery(card).one("iframe");
        let authorTarget = cQuery(card).one(".revision-author");
        let deleteButton = cQuery(card).find(".deleteButton");
        let restoreButton = cQuery(card).find(".restoreButton");

        target.empty();
        if (!revision) return;
        
        frameTarget.src = revision;
        cQuery(card).one(".revision-name").innerText = tags[revision];
        mdc.autoInit(card);
        target.append(card);

        webstrate.getOps(parseInt(revision)-1,parseInt(revision), (err, ops) => {
            let username = "System";
            if (ops != null && ops.length > 0){
                if (ops[0].session){
                    username = ops[0].session.userId;
                } else {
                    username = ops[0].src;
                }
            }
            if (username == "anonymous:") username = "Anonymous";
            authorTarget.innerText = "by "+username;
        });

        restoreButton.on("click", ()=>{
            webstrate.restore(parseInt(revision), (err, newVersion) =>{
                if(err) {
                    console.error(err);
                } else {
                    console.log("Successfully restored");
                    EventSystem.triggerEvent("RevisionBrowser.OnRestore", self);
                }
            });
        });

        if(tagLabel != null) {
            deleteButton.on("click", ()=>{

                console.log("Deleting: ", tagLabel);

                webstrate.untag(tagLabel);

                target.empty();

                self.populateList();
            });
        } else {
            deleteButton.remove();
        }
    }
    
    unselect(){
        cQuery(this.html).find(".mdc-list-item--selected").removeClass("mdc-list-item--selected");
        cQuery(this.html).find(".mdc-list")[0].MDCList.foundation.selectedIndex_ = -1;
    }

    selectTagFromRevision(revision) {
        let listItem = cQuery(this.html).find(".mdc-list-item[data-revision='"+revision+"']");

        if(listItem != null) {
            let foundIndex = -1;

            cQuery(this.html).find(".mdc-list")[0].MDCList.listElements.forEach((listElement, index)=>{
                if(listItem[0] === listElement) {
                    foundIndex = index;
                }
            });

            cQuery(this.html).find(".mdc-list")[0].MDCList.selectedIndex = foundIndex;
        }
    }

    populateList() {
        let self = this;

        // Populate list
        let tags = webstrate.tags();
        let tagList = Object.keys(tags).sort((v1, v2)=>{
            return parseInt(v2) - parseInt(v1);
        });
        let browserList = cQuery(this.html).one(".mdc-list");

        //Clear old entries
        cQuery(browserList).find(".mdc-list-item").remove();

        let currentItem = this.selfItemTemplate.cloneNode(true);
        cQuery(currentItem).one(".revision-subtext").innerText = "Revision "+webstrate.version;
        currentItem.setAttribute("data-revision", webstrate.version);
        browserList.append(currentItem);        

        tagList.forEach((revision)=>{
            let listItem = this.listItemTemplate.cloneNode(true);
            cQuery(listItem).one(".revision-name").innerText = tags[revision];
            cQuery(listItem).one(".revision-subtext").innerText = "Revision "+revision;
            browserList.append(listItem);
            listItem.setAttribute("data-revision", revision);
        });

        // Auto-init all the components
        mdc.autoInit(this.html);

        // Configure list and preview
        let list = browserList.MDCList;
        list.singleSelection = true;

        list.listen("MDCList:action", (evt)=>{
            if (evt.detail.index>0){
                let revision = tagList[evt.detail.index-1];
                let tagLabel = tags[revision];

                self.loadRevision(revision, tagLabel);
                cQuery(self.html).find(".revisionSelector")[0].value=revision;
            } else {
                self.loadTagUI();
            }
        });
        
        list.selectedIndex = 0;
        this.loadTagUI();
    }
};

</script>

                <template id="revision-browser-base">
    <div class="revision-browser-base">

        <div class="revision-browser-scrollable">
            <div>
                <label class="mdc-text-field mdc-text-field--filled revision-input-spinner" data-mdc-auto-init="MDCTextField">
                    <span class="mdc-text-field__ripple"></span>
                    <input type="number" min="1" class="mdc-text-field__input revisionSelector" value="0">
                    <span class="mdc-floating-label">Browse revision</span>
                    <span class="mdc-line-ripple"></span>                    
                </label>
            </div>
            <ul class="mdc-list mdc-list--two-line" data-mdc-auto-init="MDCList">
            </ul>
        </div>
        <div class="mdc-card revision_framecontainer">
        </div>
    </div>    
</template>

<template id="revisionBrowserSelfItem">
    <li class="mdc-list-item" data-mdc-auto-init="MDCRipple" tabindex="0">
        <span class="mdc-list-item__ripple"></span>
        <span class="mdc-list-item__text">
            <span class="mdc-list-item__primary-text revision-name">&lt;Current Revision&gt;
            </span>
            <span class="mdc-list-item__secondary-text revision-subtext">Secondary text</span>
        </span>
    </li>
</template>

<template id="revisionBrowserListItem">
    <li class="mdc-list-item" data-mdc-auto-init="MDCRipple" tabindex="0">
        <span class="mdc-list-item__ripple"></span>
        <span class="mdc-list-item__text">
            <span class="mdc-list-item__primary-text revision-name">Two-line item
            </span>
            <span class="mdc-list-item__secondary-text revision-subtext">Secondary text</span>
        </span>
    </li>
</template>

<template id="revisionBrowserPresentationCard">
    <div class="mdc-card">
        <div class="revision-card__primary">
            <h2 class="mdc-typography mdc-typography--headline6 revision-name">The Title</h2>
            <h3 class="mdc-typography mdc-typography--subtitle2 revision-author">by</h3>
        </div>
        <div class="revision-framescaler mdc-elevation--z3">
            <iframe class="mdc-card__media"></iframe>
        </div>
        <div class="mdc-card__actions">
            <div class="mdc-card__action-buttons">
                <button class="mdc-button mdc-card__action mdc-card__action--button deleteButton" data-mdc-auto-init="MDCRipple">Delete<span class="mdc-button__ripple"></span></button>
                <button class="mdc-button mdc-button--raised mdc-card__action mdc-card__action--button restoreButton" data-mdc-auto-init="MDCRipple">Restore<span class="mdc-button__ripple"></span></button>
            </div>
        </div>
    </div>
</template>

<template id="revisionBrowserTaggingCard">
    <div class="mdc-card">
        <div class="revision-card__primary">
            <h2 class="mdc-typography mdc-typography--headline6 revision-name">Tags and Revisions</h2>
            <h3 class="mdc-typography mdc-typography--subtitle2 revision-author">Store a tagged revision of the current webstrate - restore it from the list later</h3>
        </div>
        <div class="mdc-card__actions">
            <div class="mdc-card__action-buttons">
                <button class="mdc-button mdc-button--raised mdc-card__action mdc-card__action--button tagButton" data-mdc-auto-init="MDCRipple">Tag this<span class="mdc-button__ripple"></span></button>
            </div>
        </div>
    </div>
</template>

            </div>
            
            <div class="package" id="WPMPackageBrowser">
                <script id="descriptor-script" type="descriptor">
{
    "friendlyName": "Manage WPMv2 packages in your webstrate",
    "description": "Easily install, update or remove packages in your webstrate with a visual UI",
    "dependencies": [
        "#WebstrateComponents_Tools"
    ],
    "optionalDependencies": [
        "wpm_js_libs #material-design-components",
        "wpm_js_libs #material-design-icons",
        "#MaterialDesignOutlinedIcons",
        "#ModalDialog",
        "#MenuSystem",
        "#MaterialMenu"
    ],
    "assets": [],
    "version": "2.0",
    "license": "Apache 2.0",
    "changelog": {
        "1.0": "Initial version",
        "2.0": "No longer initial version"
    }
}

</script>

                <style id="mdc-package-browser-style">
/**
 *  Package Browser Styles
 * 
 *  Copyright 2021 Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/
.package-browser-base {
  display: flex;
  flex-direction: column;
  position: relative; }
  .package-browser-base #packageBrowserMain {
    border-top: 1px solid lightgray;
    display: flex;
    height: 100%;
    width: 100%;
    min-height: 0; }
    .package-browser-base #packageBrowserMain .tabcontent {
      display: flex;
      flex-direction: column;
      width: 100%;
      min-height: 0; }
      .package-browser-base #packageBrowserMain .tabcontent.padded {
        padding: 1em; }
    .package-browser-base #packageBrowserMain .split {
      display: flex;
      flex: 1 1 auto;
      min-height: 0; }
      .package-browser-base #packageBrowserMain .split > .mdc-list {
        flex: 0 0 auto;
        width: 20em;
        max-width: 25vw;
        min-height: 0;
        overflow-y: auto;
        background: rgba(100, 100, 100, 0.2);
        padding: 0; }
        .package-browser-base #packageBrowserMain .split > .mdc-list .mdc-list-item {
          padding-right: 0; }
        .package-browser-base #packageBrowserMain .split > .mdc-list .repository-name {
          text-transform: capitalize; }
      .package-browser-base #packageBrowserMain .split > .scroller {
        flex: 1 1 auto;
        min-height: 0;
        overflow-y: auto; }
    .package-browser-base #packageBrowserMain .install-options-icon {
      position: absolute;
      line-height: 1.5em;
      margin-left: 0.3em;
      color: var(--mdc-theme-text-icon-on-light);
      user-select: none; }
    .package-browser-base #packageBrowserMain .mdc-data-table__row.missing {
      background: rgba(255, 0, 0, 0.6); }
    .package-browser-base #packageBrowserMain .mdc-data-table {
      border: none;
      display: block; }
    .package-browser-base #packageBrowserMain .mdc-data-table__table-container {
      overflow-x: hidden; }
    .package-browser-base #packageBrowserMain .mdc-data-table__table {
      width: 100%;
      border-spacing: 0;
      border-collapse: initial; }
      .package-browser-base #packageBrowserMain .mdc-data-table__table .mdc-data-table__header-cell {
        background: rgba(0, 0, 255, 0.1); }
      .package-browser-base #packageBrowserMain .mdc-data-table__table .mdc-data-table__cell {
        height: 43px;
        border-top: 1px dotted var(--mdc-theme-text-secondary-on-background); }
      .package-browser-base #packageBrowserMain .mdc-data-table__table tbody tr:first-child .mdc-data-table__cell {
        border-top: 1px solid var(--mdc-theme-text-secondary-on-background); }
    .package-browser-base #packageBrowserMain .package-required[data-indirect-requirement] .mdc-checkbox__background:after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 100, 255, 0.22); }
    .package-browser-base #packageBrowserMain .package-required, .package-browser-base #packageBrowserMain .package-embedded {
      width: 3.5rem; }
    .package-browser-base #packageBrowserMain .package-name {
      width: 12rem; }
    .package-browser-base #packageBrowserMain .package-version {
      width: 6rem; }
    .package-browser-base #packageBrowserMain .package-license {
      width: 9rem; }
    .package-browser-base #packageBrowserMain .package-options {
      width: 1rem; }
    .package-browser-base #packageBrowserMain .package-description {
      width: 100%;
      overflow: hidden; }
</style>

                <script id="webstrate-package-browser-script" type="disabled">
/**
 *  Package Browser
 *  Visual browser for installing WPM packages into a Webstrate
 *
 *  Copyright 2021 Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/

/**
 * Visual browser for installing WPM packages into a Webstrate
 */
window.WPMPackageBrowser = class WPMPackageBrowser {
    constructor(autoOpen = true) {
        let self = this;
        self.topLevelComponent = document.documentElement;

        self.itemTemplate = WebstrateComponents.Tools.loadTemplate("#packageBrowserPackageItem");
        self.html = WebstrateComponents.Tools.loadTemplate("#packageBrowserBase");
        self.mainView = self.html.querySelector("#packageBrowserMain");

        wpm.require(["material-design-components", "material-design-icons", "ModalDialog", "MenuSystem", "MaterialMenu", "MaterialDesignOutlinedIcons"]).then(() => {
            mdc.autoInit(self.html);
            let tabs = self.html.querySelector(".mdc-tab-bar").MDCTabBar;

            tabs.listen("MDCTabBar:activated", (evt) => {
                // Switch tabs
                switch (evt.detail.index) {
                    case 0:
                        self.showRepositories();
                        break;
                    default:
                        self.showSystem();
                }
            });

            try {
                tabs.activateTab(0); //self.showRepositories();
            } catch (ex) {
                tabs.activateTab(1); //self.showSystem();
            }

            self.repositoryURLDialog = this.getURLDialog();
            self.repositoryDevURLDialog = this.getDevURLDialog();
        });

        if (autoOpen) this.openInBody();
    }

    openInBody() {
        let parent = document.createElement("transient");
        parent.appendChild(this.html);
        document.body.appendChild(parent);
    }

    setTopLevelComponent(component) {
        this.topLevelComponent = component;
    }

    getURLDialog() {
        let self = this;
        let repoAddTemplate = WebstrateComponents.Tools.loadTemplate("#packageBrowserRepositoryURL");
        let repositoryURLDialog = new WebstrateComponents.ModalDialog(
            repoAddTemplate,
            {
                "title": "Repository URL",
                "actions": {
                    "cancel": {},
                    "set": { primary: true, mdcIcon: "add_link" }
                }
            }
        );
        this.topLevelComponent.appendChild(repositoryURLDialog.html);

        repositoryURLDialog.setTarget = (target) => {
            repositoryURLDialog.target = target;

            let stepRepositoryRegistrations = WPMv2.getRegisteredRepositories(false);
            if (stepRepositoryRegistrations[target]) {
                repoAddTemplate.querySelector("#repourl").value = stepRepositoryRegistrations[target];
            }
        };

        EventSystem.registerEventCallback('ModalDialog.Closing', function (evt) {
            if (evt.detail.dialog === repositoryURLDialog && evt.detail.action === "set") {
                let bootConfig = self.getBootConfig();

                if (bootConfig.require && Array.isArray(bootConfig.require)) {
                    let repo = {};
                    repo[repositoryURLDialog.target] = repoAddTemplate.querySelector("#repourl").value;
                    if (bootConfig.require.length === 0) {
                        bootConfig.require = {
                            repositories: repo,
                            dependencies: []
                        };
                    } else {
                        let oldRepos = bootConfig.require[0].repositories;
                        if (!oldRepos) {
                            bootConfig.require[0].repositories = repo;
                        } else {
                            bootConfig.require[0].repositories = { ...bootConfig.require[0].repositories, ...repo };
                        }
                    }

                    // Effectuate immediately too
                    WPMv2.registerRepository(repositoryURLDialog.target, repo[repositoryURLDialog.target]);
                }

                self.setBootConfig(bootConfig);
                self.showRepositories();
            }
        });

        return repositoryURLDialog;
    }

    getDevURLDialog() {
        let self = this;
        let repoDevTemplate = WebstrateComponents.Tools.loadTemplate("#packageBrowserRepositoryDevURL");
        let repositoryDevURLDialog = new WebstrateComponents.ModalDialog(
            repoDevTemplate,
            {
                "title": "Repository Dev Override",
                "actions": {
                    "cancel": {},
                    "remove": {},
                    "set": { primary: true, mdcIcon: "add_link" }
                }
            }
        );
        this.topLevelComponent.appendChild(repositoryDevURLDialog.html);

        repositoryDevURLDialog.setTarget = (target) => {
            repositoryDevURLDialog.target = target;

            let stepRepositoryRegistrations = WPMv2.getRegisteredRepositories(true);
            if (stepRepositoryRegistrations[target]) {
                repoDevTemplate.querySelector("#repodevurl").value = stepRepositoryRegistrations[target];
            }
        };

        EventSystem.registerEventCallback('ModalDialog.Closing', function (evt) {
            if (evt.detail.dialog === repositoryDevURLDialog) {
                let value = repoDevTemplate.querySelector("#repodevurl").value;
                if (evt.detail.action === "remove" || (evt.detail.action === "set" && value.trim().length === 0)) {
                    WPMv2.unregisterRepository(repositoryDevURLDialog.target, true);
                } else if (evt.detail.action === "set") {
                    WPMv2.registerRepository(repositoryDevURLDialog.target, value, true);
                }
            }
            self.showRepositories();
        });

        return repositoryDevURLDialog;
    }


    async renderRepository(repositoryName, repositoryView) {
        let self = this;
        let repositoryPackages = await WPMv2.getPackagesFromRepository(repositoryName);
        let bootConfig = this.getBootConfig();

        let repositoryRepositoryTemplate = WebstrateComponents.Tools.loadTemplate("#packageBrowserRepositoryItem_repository");
        let repositoryBodyTemplate = WebstrateComponents.Tools.loadTemplate("#packageBrowserRepositoryItem_body");
        let repoListDiv = repositoryView.querySelector(".repository-list");
        repoListDiv.innerHTML = "";
        repoListDiv.appendChild(repositoryRepositoryTemplate);
        repoListDiv.appendChild(repositoryBodyTemplate);

        let renderBody = () => {
            let installedFromRepository = WPMv2.getCurrentlyInstalledPackages().filter(pkg => pkg.repository && pkg.repository == repositoryName);
            // TODO: Handle packages that are in the bootConfig requirestep for this repo but aren't in the repo
            let repositoryIsThisPage = WPMv2.getLocalRepositoryURL && (repositoryName == WPMv2.getLocalRepositoryURL());

            for (let packageInfo of repositoryPackages) {
                if (packageInfo.repository && packageInfo.repository != repositoryName) continue; // This package is not actually from here but somewhere else
                repositoryBodyTemplate.appendChild(self.renderPackageItem(packageInfo, bootConfig, { repositoryIsThisPage: repositoryIsThisPage }));
                installedFromRepository = installedFromRepository.filter(pkg => pkg.name != packageInfo.name);
            }

            // Render packages that claim to be in this repository, but aren't
            installedFromRepository.forEach((packageInfo) => {
                repositoryBodyTemplate.appendChild(self.renderPackageItem(packageInfo, bootConfig, { missingInRepository: true }));
            });
        };
        await renderBody();

        // Repository-wide override buttons
        repositoryRepositoryTemplate.querySelector(".repository-require input").checked = self.isConfigDirectlyRequiringRepository(bootConfig, repositoryName);
        repositoryRepositoryTemplate.querySelector(".repository-require input").addEventListener("click", async (evt) => {
            // Enabled repository-wide require option, remove any per-package settings from bootConfig
            for (let packageInfo of repositoryPackages) {
                await self.removePackageRequire(packageInfo);
            }

            if (evt.target.checked) {
                await self.addRepositoryRequire(repositoryName);
            } else {
                await self.removeRepositoryRequire(repositoryName);
            }

            bootConfig = self.getBootConfig();
            repositoryBodyTemplate.innerHTML = "";
            await renderBody();
        });

        repositoryRepositoryTemplate.querySelector(".repository-embed").addEventListener("click", async (evt) => {
            let embedMenu = MenuSystem.MenuManager.createMenu("PackageBrowser.RepositoryEmbed", {
                growDirection: MenuSystem.Menu.GrowDirection.DOWN
            });
            embedMenu.addItem({
                label: "Embed In-Use",
                order: 100,
                group: "Fetching",
                groupOrder: 200,
                icon: IconRegistry.createIcon("mdc:downloading"),
                onAction: async () => {
                    let packagesToEmbed = [];
                    for (let packageInfo of repositoryPackages) {
                        let inUse = self.getLocalPackageElement(packageInfo.name);
                        if (inUse && (self.isTransientPackageElement(inUse))) {
                            packagesToEmbed.push(packageInfo);
                        }
                    }
                    console.log(packagesToEmbed);
                    await self.embedPackages(packagesToEmbed);
                    self.renderRepository(repositoryName, repositoryView);
                }
            });
            embedMenu.addItem({
                label: "Embed All",
                icon: IconRegistry.createIcon("mdc:download_for_offline"),
                group: "Fetching",
                groupOrder: 200,
                order: 200,
                onAction: async () => {
                    if (confirm("This will bloat the page, the repository may not be designed to have ALL packages embedded and newly added packages will not be included")) {
                        let packagesToEmbed = []
                        for (let packageInfo of repositoryPackages) {
                            let localPackageElement = self.getLocalPackageElement(packageInfo.name);

                            if ((!localPackageElement) || self.isTransientPackageElement(localPackageElement)) {
                                packagesToEmbed.push(packageInfo);
                            }
                        }
                        await self.embedPackages(packagesToEmbed);
                        self.renderRepository(repositoryName, repositoryView);
                    }
                }
            });
            embedMenu.addItem({
                label: "Remove All Embedded",
                icon: IconRegistry.createIcon("mdc:delete"),
                group: "Destruction",
                groupOrder: 999,
                order: 999,
                onAction: async () => {
                    let packagesOnlyOnThisPage = 0;
                    let packagesToUnembed = [];
                    for (let packageInfo of repositoryPackages) {
                        let localPackageElement = self.getLocalPackageElement(packageInfo.name);
                        if (localPackageElement && !self.isTransientPackageElement(localPackageElement)) {
                            if (packageInfo.repository && WPMv2.getLocalRepositoryURL && packageInfo.repository == WPMv2.getLocalRepositoryURL()) {
                                packagesOnlyOnThisPage++;
                            }
                            packagesToUnembed.push(packageInfo);
                        }
                    }

                    if ((!packagesOnlyOnThisPage) || confirm("This will permanently delete " + packagesOnlyOnThisPage + " packages that ONLY exist in this page"))
                        for (let pkg of packagesToUnembed) {
                            await self.unembedPackage(pkg);
                        }

                    self.renderRepository(repositoryName, repositoryView);
                }
            });

            embedMenu.registerOnCloseCallback(() => {
                if (embedMenu.html.parentNode !== null) {
                    embedMenu.html.parentNode.removeChild(embedMenu.html);
                }
            });

            self.html.appendChild(embedMenu.html);

            embedMenu.open({
                x: evt.clientX,
                y: evt.clientY
            });
            evt.stopPropagation();
            evt.preventDefault();
        });
    };

    showRepositories() {
        let self = this;
        this.mainView.innerHTML = "";

        let repositoryView = WebstrateComponents.Tools.loadTemplate("#packageBrowserRepositoryList");

        // General actions for repositories
        let repoAddTemplate = WebstrateComponents.Tools.loadTemplate("#packageBrowserRepositoryAdder");
        let addRepositoryDialog = new WebstrateComponents.ModalDialog(
            repoAddTemplate,
            {
                "title": "Add Repository",
                "actions": {
                    "cancel": {},
                    "next": { primary: true, mdcIcon: "add_link" }
                }
            }
        );
        self.topLevelComponent.appendChild(addRepositoryDialog.html);
        EventSystem.registerEventCallback('ModalDialog.Closing', function (evt) {
            if (evt.detail.dialog === addRepositoryDialog && evt.detail.action === "next") {
                let bootConfig = self.getBootConfig();
                let value = repoAddTemplate.querySelector("#repoid").value.trim();
                if (value.length > 0) {
                    if ((!bootConfig.knownRepositories) || !Array.isArray(bootConfig.knownRepositories)) {
                        bootConfig.knownRepositories = []; // Destructive conformity
                    }
                    bootConfig.knownRepositories.push(repoAddTemplate.querySelector("#repoid").value);
                    self.setBootConfig(bootConfig);
                    self.showRepositories();

                    // TODO: .scrollIntoView() ?
                }
            }
        });

        // Gather a list of used repositories, both site-wide from WPM and previously added from this browser
        let knownRepositories = [];
        let installedPackages = WPMv2.getCurrentlyInstalledPackages();
        for (let packageInfo of installedPackages) {
            if (packageInfo.repository && !knownRepositories.includes(packageInfo.repository)) {
                knownRepositories.push(packageInfo.repository);
            }
        }
        let bootConfig = this.getBootConfig();
        if (bootConfig.knownRepositories && Array.isArray(bootConfig.knownRepositories)) {
            for (let repoName of bootConfig.knownRepositories) {
                if (!knownRepositories.includes(repoName)) {
                    knownRepositories.push(repoName);
                }
            }
        }

        // Sort it and show it
        let sortedRepositories = knownRepositories.sort();
        let overviewAddItemTemplate = WebstrateComponents.Tools.loadTemplate("#packageBrowserAddListItem");
        for (let repositoryName of sortedRepositories) {
            let overviewListItemTemplate = WebstrateComponents.Tools.loadTemplate("#packageBrowserRepositoryListItem");
            if (WPMv2.getLocalRepositoryURL && repositoryName == WPMv2.getLocalRepositoryURL()) {
                overviewListItemTemplate.querySelector(".repository-name").innerHTML = "⌂ This Page";
                overviewListItemTemplate.querySelector(".repository-url").innerText = repositoryName;
            } else {
                overviewListItemTemplate.querySelector(".repository-name").title = repositoryName;
                overviewListItemTemplate.querySelector(".repository-name").innerText = repositoryName.replace("-repos", "").replaceAll("_", " ").replaceAll("-", " ");
            }

            // Check if this is mapped somewhere with the bootloader
            // STUB: Currently this uses WPMv2 instead of the bootstep to resolve it
            let stepRepositoryRegistrations = WPMv2.getRegisteredRepositories(false);
            if (stepRepositoryRegistrations[repositoryName]) {
                overviewListItemTemplate.querySelector(".repository-url").innerText = stepRepositoryRegistrations[repositoryName];
                overviewListItemTemplate.querySelector(".repository-url").title = stepRepositoryRegistrations[repositoryName];
            }

            // Check if this is mapped somewhere with any overrides
            // STUB: Currently this uses WPMv2 instead of the bootstep to resolve it
            let overrideRepositoryRegistrations = WPMv2.getRegisteredRepositories(true);
            if (overrideRepositoryRegistrations[repositoryName]) {
                overviewListItemTemplate.querySelector(".repository-url").title = overviewListItemTemplate.querySelector(".repository-url").innerText + " overridden by site-wide developer setting in this browser";
                overviewListItemTemplate.querySelector(".repository-url").innerText = overrideRepositoryRegistrations[repositoryName];
                overviewListItemTemplate.querySelector(".repository-url").style.color = "red";
            }

            overviewListItemTemplate.querySelector(".repository-more").addEventListener("click", (evt) => {
                let moreMenu = MenuSystem.MenuManager.createMenu("PackageBrowser.RepositoryMore", {
                    growDirection: MenuSystem.Menu.GrowDirection.DOWN
                });
                moreMenu.addItem({
                    label: "Remove",
                    order: 10,
                    icon: IconRegistry.createIcon("mdc:delete_outline"),
                    onAction: () => {
                        let bootConfig = self.getBootConfig();
                        if ((!bootConfig.knownRepositories) || !Array.isArray(bootConfig.knownRepositories)) {
                            console.log("Couldn't understand bootConfig.knownRepositories", bootConfig.knownRepositories);
                            return;
                        } else {
                            bootConfig.knownRepositories = bootConfig.knownRepositories.filter(e => e !== repositoryName);
                            self.setBootConfig(bootConfig);
                            self.showRepositories();
                        }
                    }
                });
                moreMenu.addItem({
                    label: "Source URL...",
                    icon: IconRegistry.createIcon("mdc:link"),
                    order: 900,
                    onAction: () => {
                        self.repositoryURLDialog.setTarget(repositoryName);
                        self.repositoryURLDialog.open();
                    }
                });
                moreMenu.addItem({
                    label: "Dev Override...",
                    icon: IconRegistry.createIcon("mdc:assistant_direction"),
                    order: 999,
                    onAction: () => {
                        self.repositoryDevURLDialog.setTarget(repositoryName);
                        self.repositoryDevURLDialog.open();
                    }
                });

                moreMenu.registerOnCloseCallback(() => {
                    if (moreMenu.html.parentNode !== null) {
                        moreMenu.html.parentNode.removeChild(moreMenu.html);
                    }
                });

                self.html.appendChild(moreMenu.html);
                moreMenu.open({
                    x: evt.clientX,
                    y: evt.clientY
                });
                evt.stopPropagation();
                evt.preventDefault();
            });

            // Insert into overview of repositories
            repositoryView.querySelector(".repository-overview").appendChild(overviewListItemTemplate);
        }
        repositoryView.querySelector(".repository-overview").appendChild(overviewAddItemTemplate);
        repositoryView.querySelector(".add-repository").addEventListener("click", () => {
            addRepositoryDialog.html.querySelector("#repoid").value = "";
            addRepositoryDialog.open();
        });

        mdc.autoInit(repositoryView);
        let list = repositoryView.querySelector(".repository-overview").MDCList;
        list.singleSelection = true;
        list.listen("MDCList:action", async (evt) => {
            if (evt.detail.index > sortedRepositories.length) return;
            let repositoryName = sortedRepositories[evt.detail.index];
            self.renderRepository(repositoryName, repositoryView);
        });
        list.selectedIndex = 0;
        if (sortedRepositories.length > 0) self.renderRepository(sortedRepositories[0], repositoryView);

        this.mainView.appendChild(repositoryView);
    }

    showSystem() {
        let self = this;
        this.mainView.innerHTML = "";

        let systemView = WebstrateComponents.Tools.loadTemplate("#packageBrowserSystem");
        this.mainView.appendChild(systemView);
        let wpmInfo = systemView.querySelector("#wpm-info");
        let bootLoaderInfo = systemView.querySelector("#bootloader-info");
        let bootLoaderConfig = systemView.querySelector("#bootloader-config");

        // Package Manager
        if (WPMv2) {
            wpmInfo.querySelector(".name").innerText = "WPMv2";
            if (WPMv2.version) {
                wpmInfo.querySelector(".version").innerText = WPMv2.version;
                wpmInfo.querySelector(".wpm-version-warning").remove();
            }
            if (WPMv2.revision) {
                wpmInfo.querySelector(".revision").innerText = WPMv2.revision;
            }
        }

        // Config
        const bootconfigElement = document.querySelector("script[type='text/json+bootconfig']")
        const editor = bootLoaderConfig.querySelector(".editor");
        const saveButton = bootLoaderConfig.querySelector(".bootloader-save");
        const resetButton = bootLoaderConfig.querySelector(".bootloader-reset");

        const oldConfig = bootconfigElement.innerText;
        editor.value = oldConfig;

        saveButton.addEventListener("click", () => {
            bootconfigElement.innerHTML = editor.value;
        });

        resetButton.addEventListener("click", () => {
            editor.value = oldConfig;
        });
    }

    getBootConfig() {
        try {
            let element = document.querySelector("script[type='text/json+bootconfig']");
            if (!element) throw Error("No bootconfig defined");

            let j = JSON.parse(element.textContent);
            return j;
        } catch (ex) {
            console.log("PackageBrowser error", ex);
        }

        // We assume that we may create a new empty boot config if it doesn't exist
        let bootConfig = {
            creator: "WPMPackageManager",
            created: Date.now(),
            require: []
        };

        return bootConfig;
    }

    setBootConfig(config) {
        let element = document.querySelector("script[type='text/json+bootconfig']");
        if (!element) {
            element = document.createElement("script");
            element.setAttribute("type", "text/json+bootconfig");
            WPMv2.stripProtection(element);
            document.head.appendChild(element);
            console.warn("Installing new boot config");
        }

        config["updated"] = Date.now();
        element.textContent = JSON.stringify(config, null, 4);
    }

    isLive(packageElement) {
        return packageElement.getAttribute("transient-wpm-live") !== null;
    }

    isConfigDirectlyRequiringPackage(config, name) {
        if (!config) throw new Error("Boot config is undefined");
        if (!config.require) throw new Error("Boot config does not contain require");
        if (!Array.isArray(config.require)) throw new Error("Boot config require is not an array");

        for (let requireStep of config.require) {
            if (!requireStep.dependencies) continue;
            if (!Array.isArray(requireStep.dependencies)) continue;
            for (let dependency of requireStep.dependencies) {
                if (dependency.package && dependency.package === name) {
                    return true;
                }
            }
        }
        return false;
    }

    isConfigDirectlyRequiringRepository(config, name) {
        if (!config) throw new Error("Boot config is undefined");
        if (!config.require) throw new Error("Boot config does not contain require");
        if (!Array.isArray(config.require)) throw new Error("Boot config require is not an array");

        for (let requireStep of config.require) {
            if (!requireStep.dependencies) continue;
            if (!Array.isArray(requireStep.dependencies)) continue;
            for (let dependency of requireStep.dependencies) {
                if (dependency.repository && dependency.repository === name && !dependency.package) {
                    return true;
                }
            }
        }
        return false;
    }



    getLocalPackageElement(packageName) {
        return document.querySelector(".packages .package#" + packageName + ", wpm-package#" + packageName);
    }

    isTransientPackageElement(packageElement) {
        if (typeof webstrate !== "undefined") {
            // In webstrate mode webstrates defines what is transient
            if (webstrate.config.isTransientElement(packageElement)) return true;
        } else {
            // Otherwise we assume a transient-element tag is used to mark it
            console.log("Trying to match ", packageElement.tagName);
            if (packageElement.closest("[transient-wpmid]")) {
                return true;
            } else {
                return false;
            }
        }

        let parent = packageElement.parentElement;
        if (parent) {
            return this.isTransientPackageElement(parent);
        } else {
            return false;
        }
    }

    isForcedEmbeddedPackage(packageInfo) {
        if (packageInfo.descriptor) {
            if (packageInfo.descriptor.forceEmbedding) {
                return true;
            }
        }
        return false;
    }

    /**
     * Adds a package to the boot config and installs it
     *
     * @param {type} packageInfo
     * @param {type} step
     * @returns {undefined}
     */
    async addPackageRequire(packageInfo, step = -1) {
        let config = this.getBootConfig();

        if (step === -1 || step > config.require.length) {
            step = config.require.length - 1;
        }
        if (step === -1) {
            config.require.push({ dependencies: [], options: {} });
            step = 0;
        }

        // Add it and load it
        let packageRequire = { package: packageInfo.name, repository: packageInfo.repository };
        await WPMv2.require(packageRequire); // also install it right away
        config.require[step].dependencies.push(packageRequire);
        this.setBootConfig(config);
    }

    async removePackageRequire(packageInfo) {
        let config = this.getBootConfig();

        let removedIt = false;
        for (let requireStep of config.require) {
            if (!requireStep.dependencies) continue;
            if (!Array.isArray(requireStep.dependencies)) continue;

            let newDependencies = [];
            for (let dependency of requireStep.dependencies) {
                if (dependency.package && dependency.package === packageInfo.name) {
                    removedIt = true;
                } else {
                    newDependencies.push(dependency);
                }
            }
            requireStep.dependencies = newDependencies;
        }

        if (removedIt) {
            let localPackageElement = this.getLocalPackageElement(packageInfo.name);
            if (this.isTransientPackageElement(localPackageElement)) {
                localPackageElement.remove();
                document.querySelector("[transient-wpmid='" + packageInfo.name + "']")?.remove();
            }
        }

        this.setBootConfig(config);
    }

    async removeRepositoryRequire(repositoryURL) {
        let config = this.getBootConfig();

        let removedIt = false;
        for (let requireStep of config.require) {
            if (!requireStep.dependencies) continue;
            if (!Array.isArray(requireStep.dependencies)) continue;

            let newDependencies = [];
            for (let dependency of requireStep.dependencies) {
                if (dependency.repository && dependency.repository === repositoryURL && !dependency.package) {
                    removedIt = true;
                } else {
                    newDependencies.push(dependency);
                }
            }
            requireStep.dependencies = newDependencies;
        }

        if (removedIt) {
            // TODO: Figure out if something else also depends on it
            // If not, remove it from runtime too
        }

        this.setBootConfig(config);
    }

    /**
     * Adds a package to the boot config and installs it
     *
     * @param {type} repositoryURL
     * @param {type} step
     * @returns {undefined}
     */
    async addRepositoryRequire(repositoryURL, step = -1) {
        let config = this.getBootConfig();

        if (step === -1 || step > config.require.length) {
            step = config.require.length - 1;
        }
        if (step === -1) {
            config.require.push({ dependencies: [], options: {} });
            step = 0;
        }

        // Add it and load it
        let repositoryRequire = { repository: repositoryURL };
        await WPMv2.require(repositoryRequire); // also install it right away
        config.require[step].dependencies.push(repositoryRequire);
        this.setBootConfig(config);
    }

    async embedPackages(wpmPackages) {
        // Prepare for this package to be embedded
        let requiredPackages = [];
        wpmPackages.forEach((wpmPackage) => {
            let localPackageElement = this.getLocalPackageElement(wpmPackage.name);
            if (localPackageElement && this.isTransientPackageElement(localPackageElement)) {
                // Already installed transiently, remove first
                localPackageElement.remove();
                //Also remove wpm transient element if found
                document.querySelector("[transient-wpmid='" + wpmPackage.name + "']")?.remove();
            };
            requiredPackages.push({ package: wpmPackage.name, repository: wpmPackage.repository, appendTarget: "head" });
        });

        await WPMv2.require(requiredPackages, { "bootstrap": "false" }); // install it right away
    }

    async unembedPackage(wpmPackage) {
        let localPackageElement = this.getLocalPackageElement(wpmPackage.name); // update the package element
        localPackageElement.remove();

        if (this.isConfigDirectlyRequiringPackage(this.getBootConfig(), wpmPackage.name)) {
            // Re-install transiently if required
            await WPMv2.require(wpmPackage);
        };
    }

    renderPackageItem(wpmPackage, bootConfig, displayOptions = {}) {
        let self = this;

        let packageItemTemplate = WebstrateComponents.Tools.loadTemplate("#packageBrowserPackageItem");
        if (displayOptions.missingInRepository) {
            packageItemTemplate.classList.add("missing");
            packageItemTemplate.title = "This package could not be found in the repository";
        };

        if (!wpmPackage.name) {
            return WebstrateComponents.Tools.loadTemplate("#packageBrowserPackageItemError");
        }
        packageItemTemplate.querySelector(".package-name").innerText = wpmPackage.name;
        packageItemTemplate.querySelector(".package-name").title = wpmPackage.name;

        ["version", "description", "license"].forEach((packageProperty) => {
            if (wpmPackage[packageProperty]) {
                packageItemTemplate.querySelector(".package-" + packageProperty).innerText = wpmPackage[packageProperty];
                packageItemTemplate.querySelector(".package-" + packageProperty).title = wpmPackage[packageProperty];
            }
        });

        let localPackageElement = this.getLocalPackageElement(wpmPackage.name);
        if (localPackageElement) {
            // Check if required directly or because of dependency/system
            if (this.isConfigDirectlyRequiringPackage(bootConfig, wpmPackage.name)) {
                packageItemTemplate.querySelector(".package-required input").checked = true;
            } else {
                if (this.isLive(localPackageElement)) {
                    packageItemTemplate.querySelector(".package-required").setAttribute("data-indirect-requirement", "true");
                    packageItemTemplate.querySelector(".package-required .mdc-checkbox").setAttribute("title", "Indirectly required by another package at runtime");

                    try {
                        // Add which package pulled this in
                        let pulledInBy = [];
                        WPMv2.getCurrentlyInstalledPackages().forEach(function (pkg) {
                            pkg.dependencies.forEach(function (dep) {
                                if (typeof dep === "string" && dep.indexOf("#" + wpmPackage.name) != -1) {
                                    pulledInBy.push(pkg);
                                }
                            });
                        });
                        if (pulledInBy.length > 0) {
                            packageItemTemplate.querySelector(".package-required .mdc-checkbox").setAttribute("title", "Indirectly required by " + pulledInBy);
                        }
                    } catch (ex) {
                        console.warn(ex);
                    }
                }
            }

            // Embedding status
            packageItemTemplate.querySelector(".package-embedded input").checked = !this.isTransientPackageElement(localPackageElement);
            if (this.isForcedEmbeddedPackage(wpmPackage)) {
                packageItemTemplate.querySelector(".package-embedded input").setAttribute("title", "This package wants to be embedded when installed");
            }
        }


        // Click handlers
        packageItemTemplate.querySelector(".package-required input").addEventListener("click", async (box) => {
            if (box.target.checked) {
                // Require a package
                if (self.isForcedEmbeddedPackage(wpmPackage) && !packageItemTemplate.querySelector(".package-embedded input").checked) {
                    await self.embedPackages([wpmPackage]);
                    packageItemTemplate.querySelector(".package-embedded input").checked = true;

                }
                await self.addPackageRequire(wpmPackage);
            } else {
                if (self.isForcedEmbeddedPackage(wpmPackage) && packageItemTemplate.querySelector(".package-embedded input").checked) {
                    await self.unembedPackage(wpmPackage);
                    packageItemTemplate.querySelector(".package-embedded input").checked = false;
                }

                // Remove require for a package
                await self.removePackageRequire(wpmPackage);
            }
            localPackageElement = self.getLocalPackageElement(wpmPackage.name); // update the package element
        });

        packageItemTemplate.querySelector(".package-embedded input").addEventListener("click", async (box) => {
            if (box.target.checked) {
                await self.embedPackages([wpmPackage]);
                packageItemTemplate.querySelector(".package-embedded input").checked = true;
            } else {
                if (((!displayOptions.missingInRepository) || confirm("This package is missing in the repository, removing it will permanently delete it"))
                    &&
                    ((!displayOptions.repositoryIsThisPage) || confirm("The package only exists in this page, removing it will permanently delete it"))) {
                    await self.unembedPackage(wpmPackage);
                    packageItemTemplate.querySelector(".package-embedded input").checked = false;
                    if (self.isForcedEmbeddedPackage(wpmPackage) && packageItemTemplate.querySelector(".package-required input").checked) {
                        await self.removePackageRequire(wpmPackage);
                        packageItemTemplate.querySelector(".package-required input").checked = false;
                    }
                } else {
                    packageItemTemplate.querySelector(".package-embedded input").checked = true;
                }
            }
            localPackageElement = self.getLocalPackageElement(wpmPackage.name); // update the package element
        });


        // Check repository includes
        if (wpmPackage.repository && self.isConfigDirectlyRequiringRepository(bootConfig, wpmPackage.repository)) {
            packageItemTemplate.querySelector(".package-required input").disabled = true;
            packageItemTemplate.querySelector(".package-required input").checked = true;
            packageItemTemplate.querySelector(".package-embedded input").disabled = true;
        }

        return packageItemTemplate;
    }
};

</script>

                <template id="packageBrowserBase">
    <div class="package-browser-base">
        <div class="mdc-tab-bar package-browser-tabs" role="tablist" data-mdc-auto-init="MDCTabBar">
            <div class="mdc-tab-scroller">
                <div class="mdc-tab-scroller__scroll-area">
                    <div class="mdc-tab-scroller__scroll-content">
                        <button class="mdc-tab" role="tab">
                            <span class="mdc-tab__content">
                                <span class="mdc-tab__icon material-icons" aria-hidden="true">inventory</span>
                                <span class="mdc-tab__text-label">Browse Repositories</span>
                            </span>
                            <span class="mdc-tab-indicator">
                                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                            </span>
                            <span class="mdc-tab__ripple"></span>
                        </button>
                        <button class="mdc-tab" role="tab">
                            <span class="mdc-tab__content">
                                <span class="mdc-tab__icon material-icons" aria-hidden="true">settings</span>
                                <span class="mdc-tab__text-label">System Setup</span>
                            </span>
                            <span class="mdc-tab-indicator">
                                <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                            </span>
                            <span class="mdc-tab__ripple"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="packageBrowserMain"></div>
    </div>
</template>

<template id="packageBrowserSystem">
    <div class="tabcontent padded">
        <div id="wpm-info">
            <h2>Webstrate Package Manager</h2>
            <table>

                <tr><th>Name</th><td class="name">Unknown Platform</td></tr>
                <tr><th>API</th><td class="version">Legacy</td></tr>
                <tr><th>Specific Revision</th><td class="revision">?</td></tr>
            </table>
            <div class="wpm-version-warning">
                <h2>Warning!</h2>
                <p>
                    The version of WPM you are running may not be compatible with this package manager or the required bootloader script.<br />
                    Please consider upgrading before continuing!
                </p>
            </div>
        </div>

        <div id="bootloader-config">
            <h2>Boot Config</h2>
            <p>
                You may manually edit the boot configuration JSON here if you like.<br />
                <b>Be careful, you were warned!</b>
            </p>

            <textarea class="editor" rows="10" cols="50"></textarea>
            <div class="buttons">
                <button class="mdc-button mdc-button--raised bootloader-save">Save Boot Config</button>
                <button class="mdc-button mdc-button--raised bootloader-reset">Reset Boot Config</button>
            </div>
        </div>
    </div>
</template>

<template id="packageBrowserBootloaderSyntaxError">
    <div class="bootconfig-missing-warning">
        <h2>Syntax Error!</h2>
        <p class="error"></p>
        <p>
            The boot configuration contains a syntax error and is guaranteed to crash the page!<br />
            Please correct the errors before saving.
        </p>
    </div>
</template>

<template id="packageBrowserPackageItemError">
    <tr class="mdc-data-table__row">
        <td>
           ?
        </td>
    </tr>
</template>

<template id="packageBrowserPackageItem">
    <tr class="mdc-data-table__row">
        <td class="mdc-data-table__cell mdc-data-table__cell--checkbox package-required">
            <div class="mdc-checkbox mdc-data-table__row-checkbox" data-mdc-auto-init="MDCCheckbox">
                <input type="checkbox" class="mdc-checkbox__native-control" />
                <div class="mdc-checkbox__background">
                    <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                    <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59" />
                    </svg>
                    <div class="mdc-checkbox__mixedmark"></div>
                </div>
                <div class="mdc-checkbox__ripple"></div>
            </div>
        </td>
        <td class="mdc-data-table__cell mdc-data-table__cell--checkbox package-embedded">
            <div class="mdc-checkbox mdc-data-table__row-checkbox" data-mdc-auto-init="MDCCheckbox">
                <input type="checkbox" class="mdc-checkbox__native-control" />
                <div class="mdc-checkbox__background">
                    <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                    <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59" />
                    </svg>
                    <div class="mdc-checkbox__mixedmark"></div>
                </div>
                <div class="mdc-checkbox__ripple"></div>
            </div>
        </td>
        <th class="mdc-data-table__cell package-name" scope="row">[unnamed]</th>
        <td class="mdc-data-table__cell package-version">[version-less]</td>
        <td class="mdc-data-table__cell package-license"></td>
        <td class="mdc-data-table__cell package-description"></td>
        <td class="mdc-data-table__cell package-options"></td>
    </tr>
</template>

<template id="packageBrowserRepositoryItem_repository">
    <thead>
        <tr>
            <th class="package-required mdc-data-table__header-cell mdc-data-table__header-cell--checkbox repository-require" role="columnheader" scope="col" title="Require entire repository at boot">
                <div class="mdc-checkbox mdc-data-table__header-row-checkbox mdc-checkbox--selected" title="Automatically require at boot">
                    <i class="material-icons install-options-icon">play_arrow</i>
                    <input type="checkbox" class="mdc-checkbox__native-control"/>
                    <div class="mdc-checkbox__background">
                        <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                        <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59" />
                        </svg>
                        <div class="mdc-checkbox__mixedmark"></div>
                    </div>
                    <div class="mdc-checkbox__ripple"></div>
                </div>
            </th>
            <th class="package-embedded mdc-data-table__header-cell mdc-data-table__header-cell--checkbox repository-embed" role="columnheader" scope="col">
                <div class="mdc-checkbox mdc-data-table__header-row-checkbox mdc-checkbox--selected" title="Embed locally into webstrate">
                    <i class="material-icons install-options-icon">archive</i>
                    <input type="checkbox" class="mdc-checkbox__native-control" disabled/>
                    <div class="mdc-checkbox__background">
                        <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                        <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59" />
                        </svg>
                        <div class="mdc-checkbox__mixedmark"></div>
                    </div>
                    <div class="mdc-checkbox__ripple"></div>
                </div>
            </th>
            <th class="package-name mdc-data-table__header-cell" role="columnheader" scope="col">Package</th>
            <th class="mdc-data-table__header-cell package-version" role="columnheader" scope="col">Version</th>
            <th class="mdc-data-table__header-cell package-license" role="columnheader" scope="col">License</th>
            <th class="mdc-data-table__header-cell package-description" role="columnheader" scope="col">Description</th>
            <th class="mdc-data-table__header-cell package-options" role="columnheader" scope="col">
            </th>
        </tr>
    </thead>
</template>

<template id="packageBrowserRepositoryItem_body">
    <tbody class="mdc-data-table__content package-browser-package-rows">
    </tbody>
</template>

<template id="packageBrowserRepositoryList">
    <div class="tabcontent">
        <div class="split">
            <ul class="mdc-list mdc-list--two-line repository-overview" data-mdc-auto-init="MDCList">
            </ul>
            <div class="scroller">
                <div class="mdc-data-table">
                    <div class="mdc-data-table__table-container">
                        <table class="mdc-data-table__table repository-list">
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="packageBrowserRepositoryAdder">
    <div>
        <label class="mdc-text-field mdc-text-field--filled" data-mdc-auto-init="MDCTextField">
          <span class="mdc-text-field__ripple"></span>
          <span class="mdc-floating-label" id="repo-label-id">Repository Identifier</span>
          <input class="mdc-text-field__input" type="text"
                 aria-labelledby="repo-label-id"
                 aria-controls="repo-helper-text"
                 aria-describedby="repo-helper-text" id="repoid">
          <span class="mdc-line-ripple"></span>
        </label>
        <div class="mdc-text-field-helper-line">
          <div id="repo-helper-text" class="mdc-text-field-helper-text" aria-hidden="true">
            Identification token - e.g. 'cauldron-repos'
          </div>
        </div>
        WPM will search for the repository in:
        <ul style="margin:0">
            <li>/[identifier]/?raw - using Webstrates</li>
            <li>./[identifier]/index.html - on filesystem</li>
        </ul>
    </div>
</template>

<template id="packageBrowserRepositoryURL">
    <div>
        Specify the URL to use load this repository
        <label class="mdc-text-field mdc-text-field--filled" data-mdc-auto-init="MDCTextField">
          <span class="mdc-text-field__ripple"></span>
          <span class="mdc-floating-label" id="repo-label-id">Repository Source</span>
          <input class="mdc-text-field__input" type="text"
                 aria-labelledby="repo-label-id"
                 aria-controls="repo-helper-text"
                 aria-describedby="repo-helper-text" id="repourl">
          <span class="mdc-line-ripple"></span>
        </label>
        <div class="mdc-text-field-helper-line">
          <div id="repo-helper-text" class="mdc-text-field-helper-text" aria-hidden="true">
            Repository URL - e.g. 'https://mydomain.com/awesome-repos'
          </div>
        </div>
        <ul style="margin:0">
            <li>Absolute https://mydomain.com/awesome-repos</li>
            <li>Relative ./something/index.html</li>
            <li>Server-relative: /something/?raw</li>
        </ul>
    </div>
</template>

<template id="packageBrowserRepositoryDevURL">
    <div>
        Specify the Dev Override URL to use locally for this repository
        <label class="mdc-text-field mdc-text-field--filled" data-mdc-auto-init="MDCTextField">
          <span class="mdc-text-field__ripple"></span>
          <span class="mdc-floating-label" id="repo-label-id">Repository Override</span>
          <input class="mdc-text-field__input" type="text"
                 aria-labelledby="repo-label-id"
                 aria-controls="repo-helper-text"
                 aria-describedby="repo-helper-text" id="repodevurl">
          <span class="mdc-line-ripple"></span>
        </label>
        <div class="mdc-text-field-helper-line">
          <div id="repo-helper-text" class="mdc-text-field-helper-text" aria-hidden="true">
            Repository Override - e.g. '/something/?raw'
          </div>
        </div>
        <ul style="margin:0">
            <li>Absolute https://mydomain.com/awesome-repos</li>
            <li>Relative ./something/index.html</li>
            <li>Server-relative: /something/?raw</li>
        </ul>
    </div>
</template>

<template id="packageBrowserRepositoryListItem">
    <li class="mdc-list-item" data-mdc-auto-init="MDCRipple" tabindex="0">
        <span class="mdc-list-item__ripple"></span>
        <span class="mdc-list-item__text">
            <span class="mdc-list-item__primary-text repository-name">Two-line item
            </span>
            <span class="mdc-list-item__secondary-text repository-url">Automatic Repository URL</span>
        </span>
        <button data-mdc-ripple-is-unbounded="" class="mdc-list-item__meta mdc-icon-button material-icons repository-more">
        more_vert
    </button>
    </li>
</template>

<template id="packageBrowserAddListItem">
    <li class="mdc-list-item add-repository" data-mdc-auto-init="MDCRipple" tabindex="0">
        <span class="mdc-list-item__ripple"></span>
        <i class="material-icons" aria-hidden="true">add</i>
        <span>
            Add Repository
        </span>
    </li>
</template>

            </div>            

            <div class="package" id="PermissionManager">
                <script id="descriptor-script" type="descriptor">
{
    "friendlyName": "Permission Manager",
    "description": "Manage permissions on a webstrate",
    "dependencies": [
        "wpm_js_libs #material-design-components",
        "wpm_js_libs #material-design-icons",
        "WebstrateComponents_Tools"
    ],
    "assets": [],
    "version": "1.0",
    "license": "Apache 2.0",
    "changelog": {
        "1.0": "Initial version"
    }
}

</script>

                <style id="main-style">
/**
 *  Permission Manager Styles
 * 
 *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/
.webstrate-components-permission-ui .wcp-permission-column {
  white-space: normal;
  width: 1em;
  text-align: center; }

.webstrate-components-permission-ui .wcp-user-column {
  width: 15em; }

.webstrate-components-permission-ui .mdc-data-table__cell:last-child {
  text-align: right; }
</style>

                <script id="webstrate-permission-manager-script" type="disabled">
/**
 *  Permission Manager
 *  Low-level interface to control permissions on a Webstrate
 * 
 *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen
 *  Copyright 2025, Janus B. Kristensen, CAVI
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *  
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/

/**
 * Handles managing permissions
 */
class PermissionManager {
    constructor() {
        this.permissions = [];

        this.loadPermissions();

        this.observer = new MutationObserver((mutations)=>{
            this.loadPermissions();
        });

        this.startObserver();
    }

    async executeObserverless(executor) {
        let mutations = this.observer.takeRecords();
        if(mutations.length > 0) {
            this.loadPermissions();
        }
        this.observer.disconnect();

        await executor();

        this.startObserver();
    }

    startObserver() {
        this.observer.observe(document.querySelector("html"), {
            attributes: true,
            attributeFilter: ["data-auth"]
        });
    }

    loadPermissions() {
        let self = this;

        let permissionJson = JSON.parse(document.querySelector("html").getAttribute("data-auth"));

        self.permissions = [];

        if(permissionJson != null) {
            permissionJson.forEach((perm)=>{
                if(perm.webstrateId != null) {
                    //Inherit permissions
                    console.warn("This webstrate is inheriting permissions (Unsupported) from: ", perm.webstrateId);
                } else {
                    self.permissions.push(new Permission(perm.username, perm.provider, perm.permissions));
                }
            });
        }

        this.checkAnonymousUser();

        EventSystem.triggerEvent("PermissionManager.Permissions.Changed", {
            permissions: this.permissions
        });
    }

    checkAnonymousUser() {
        if(this.permissions.length === 0){
            // STUB: We currently have no way of knowing the default permissions on this server so we assume "arw" for anonymous
            this.permissions.push(new Permission("anonymous", "", "arw"));
        }
    }

    setPermission(permission) {
        console.log("Setting permission: ", permission);

        let oldPermission = this.permissions.find((perm)=>{
            return permission.username === perm.username && permission.provider === perm.provider;
        });

        if(oldPermission != null) {
            oldPermission.permissions = permission.permissions;
        } else {
            this.permissions.push(permission);
        }

        this.checkAnonymousUser();

        EventSystem.triggerEvent("PermissionManager.Permissions.Changed", {
            permissions: this.permissions
        });
    }

    removePermission(permission) {
        this.permissions = this.permissions.filter((perm)=>{
            return permission.username !== perm.username || permission.provider !== perm.provider;
        });

        this.checkAnonymousUser();

        EventSystem.triggerEvent("PermissionManager.Permissions.Changed", {
            permissions: this.permissions
        });
    }

    save() {
        if(this.permissions.length === 0 || (this.permissions.length === 1 && this.permissions[0].username === "anonymous")) {
            //Empty permissions, remove auth property, everyone can do anything!
            if(confirm("After saving everyone has full access to this webstrate.\nContinue?")) {
                document.querySelector("html").removeAttribute("data-auth");
                return true;
            } else {
                return false;
            }
        } else {
            //Checks for the current user not locking himself out
            let ourPermissions = this.permissions.find((perm)=>{
                return perm.username === webstrate.user.username && perm.provider === webstrate.user.provider;
            });

            let anonPermissions = this.permissions.find((perm)=>{
                return perm.username === "anonymous" && perm.provider === "";
            });

            let anyAdmin = this.permissions.find((perm)=>{
                return perm.hasPermission("a");
            }) != null;

            if(ourPermissions == null) {
                //If our user does not exist, we are anon
                ourPermissions = anonPermissions;
            }

            let canRead = ourPermissions!=null?ourPermissions.hasPermission("r"):false;
            let canWrite = ourPermissions!=null?ourPermissions.hasPermission("w"):false;
            let canAdmin = ourPermissions!=null?((anyAdmin)?ourPermissions.hasPermission("a"):canWrite):false;

            let permissionsJson = JSON.stringify(this.permissions.map((perm)=>{
                return perm.toJson();
            }));

            if(!canAdmin) {
                if(confirm("You are removing your own admin permission.\nContinue?")) {
                    document.querySelector("html").setAttribute("data-auth", permissionsJson, {approved: true});
                    return true;
                } else {
                    return false;
                }
            } else {
                document.querySelector("html").setAttribute("data-auth", permissionsJson, {approved: true});
                return true;
            }
        }
    }
    
    static isAdmin(){
        return webstrate.user.permissions.includes("a");
    }
}

window.WebstrateComponents.PermissionManager = PermissionManager;

class Permission {
    constructor(username, provider, permissionString) {
        this.username = username;
        this.provider = provider;
        this.permissions = new Set();

        this.loadPermissions(permissionString);
    }

    loadPermissions(permissionString) {
        this.permissions.clear();

        for(let i = 0; i<permissionString.length; i++) {
            let p = permissionString.charAt(i);

            switch(p) {
                case "a":
                    this.permissions.add("a");
                case "w":
                    this.permissions.add("w");
                case "r":
                    this.permissions.add("r");
                    break;

                default:
                    console.warn("Unknown permission: ", p);
            }
        }
    }

    setPermission(perm) {
        this.permissions.clear();

        switch(perm) {
            case "a":
                this.permissions.add("a");
            case "w":
                this.permissions.add("w");
            case "r":
                this.permissions.add("r");
            default:
                console.warn("Unknown permission: ", perm);
        }
    }

    hasPermission(perm) {
        return this.permissions.has(perm);
    }

    toJson() {
        return {
            username: this.username,
            provider: this.provider,
            permissions: Array.from(this.permissions).join("")
        };
    }
}

window.WebstrateComponents.Permission = Permission;

//Load right away
WebstrateComponents.PermissionManager.singleton = new PermissionManager();

</script>

                <script id="webstrate-permission-manager-ui-script" type="disabled">
/**
 *  Permission Manager UI
 *  UI code for controlling permissions on a Webstrate
 * 
 *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen
 *  Copyright 2025, Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/
    
/**
 * UI code for controlling permissions on a Webstrate
 */
class PermissionManagerUI {
    constructor() {
        let self = this;
        
        this.topLevelComponent = document.body;

        this.html = WebstrateComponents.Tools.loadTemplate("#webstrate-components-permission-ui-tpl");

        this.html.querySelectorAll(".mdc-button").forEach((button)=>{
            new mdc.ripple.MDCRipple(button);
        });

        EventSystem.registerEventCallback("PermissionManager.Permissions.Changed", ({detail:{permissions: permissions}})=>{
            self.reload(permissions);
        });

        this.reload(WebstrateComponents.PermissionManager.singleton.permissions);

        this.html.querySelector("button.addPermission").addEventListener("click", ()=>{
            self.showAddDialog();
        });
                
        this.html.querySelector("button.addMe").addEventListener("click", ()=>{
            let permission = new WebstrateComponents.Permission(webstrate.user.username, webstrate.user.provider, "arw");
            WebstrateComponents.PermissionManager.singleton.setPermission(permission);
        });

        this.html.querySelector("button.savePermissions").addEventListener("click", ()=>{
            if(WebstrateComponents.PermissionManager.singleton.save()) {
                EventSystem.triggerEvent("PermissionManagerUI.Saved", this);
            }
        });
    }
    
    setTopLevelComponent(component){
        this.topLevelComponent = component;
    }
    
    open() {
        let parent = document.createElement("transient");
        parent.appendChild(this.html);
        this.topLevelComponent.appendChild(parent);
    }

    async showAddDialog() {
        let dialogTpl = WebstrateComponents.Tools.loadTemplate("#webstrate-components-permission-add-permission-dialog-tpl");

        let dialog = new WebstrateComponents.ModalDialog(dialogTpl);
        let transient = document.createElement("transient");
        transient.appendChild(dialog.html);
        this.topLevelComponent.appendChild(transient);

        let permissionTpl = WebstrateComponents.Tools.loadTemplate("#webstrate-components-permission-adduser-tpl");
        dialogTpl.querySelector("tbody").appendChild(permissionTpl);

        new mdc.textField.MDCTextField(permissionTpl.querySelector('.mdc-text-field'));

        dialog.open();
        
        EventSystem.registerEventCallback('ModalDialog.Closed', function(evt) {
            //Remove template after use
            transient.remove();

            if(evt.detail.dialog===dialog && evt.detail.action === "add") {
                let usernameProvider = dialogTpl.querySelector(".username input").value.split(":");
                let permissionString = dialogTpl.querySelector("input[type='radio']:checked").value;

                if(usernameProvider.length === 2 && usernameProvider[0].trim() !== "" && usernameProvider[1].trim() !== "") {
                    let permission = new WebstrateComponents.Permission(usernameProvider[0], usernameProvider[1], permissionString);

                    WebstrateComponents.PermissionManager.singleton.setPermission(permission);
                } else {
                    alert("You mistyped something, must be 'username:provider'");
                }
            }
        });
    }

    reload(permissions) {
        let tbody = this.html.querySelector("tbody");

        //Empty tbody
        while(tbody.firstChild) tbody.firstChild.remove();

        let selfInList = false;
        permissions.forEach((perm)=>{
            let permissionTpl = WebstrateComponents.Tools.loadTemplate("#webstrate-components-permission-user-tpl");

            let prefix = perm.username.replaceAll(" ","-")+"_"+perm.provider+"_";
            if (perm.username === webstrate.user.username && perm.provider === webstrate.user.provider) selfInList = true;

            //Rename all input id and name attributes
            permissionTpl.querySelectorAll("input").forEach((input)=>{
                input.id = prefix + input.id;
                input.name = prefix + input.name;

                input.addEventListener("input", ()=>{
                    perm.setPermission(input.value);
                });
            });

            //Rename all label for attributes
            permissionTpl.querySelectorAll("label").forEach((label)=>{
                label.setAttribute("for", prefix + label.getAttribute("for"));
            });

            permissionTpl.querySelectorAll('.mdc-radio').forEach((radio)=>{
                new mdc.radio.MDCRadio(radio);
            });

            permissionTpl.querySelectorAll('.mdc-form-field').forEach((formField)=>{
                new mdc.formField.MDCFormField(formField);
            });

            let checkedSelector = "";

            if(perm.hasPermission("a")) {
                checkedSelector = prefix+"admin";
            } else if(perm.hasPermission("w")) {
                checkedSelector = prefix+"write";
            } else if(perm.hasPermission("r")) {
                checkedSelector = prefix+"read";
            } else {
                checkedSelector = prefix+"none";
            }

            permissionTpl.querySelector("#"+checkedSelector).checked = true;

            permissionTpl.querySelector(".username").textContent = perm.username+(perm.provider.trim()===""?"":":"+perm.provider);

            if(perm.username === "anonymous" && perm.provider === "") {
                permissionTpl.querySelector(".deletePermission").remove();
            } else {
                permissionTpl.querySelector(".deletePermission").addEventListener("click", ()=>{
                    WebstrateComponents.PermissionManager.singleton.removePermission(perm);
                });
            }

            tbody.appendChild(permissionTpl);
        });

        // Show an addMe button if logged in and not already in list
        if (webstrate.user.provider){
            this.html.querySelector(".addMe").style.display = selfInList?"none":"initial";
        }
    }
}

window.WebstrateComponents.PermissionManagerUI = PermissionManagerUI;

</script>

                <template id="webstrate-components-permission-ui-tpl">
    <div class="webstrate-components-permission-ui">
        <table class="mdc-data-table__table" aria-label="User permissions">
            <thead>
                <tr class="mdc-data-table__header-row">
                    <th></th>
                    <th colspan="4" class="" role="columnheader" scope="col">Permissions</th>
                    <th class="mdc-data-table__header-cell" role="columnheader" scope="col"></th>
                </tr>
                <tr>
                    <th rowspan="2" class="mdc-data-table__header-cell wcp-user-column" role="columnheader" scope="col">User</th>                                        
                    <th class="mdc-data-table__header-cell wcp-permission-column">Admin</th>
                    <th class="mdc-data-table__header-cell wcp-permission-column">Write&nbsp;&amp; Read</th>
                    <th class="mdc-data-table__header-cell wcp-permission-column">Read Only</th>
                    <th class="mdc-data-table__header-cell wcp-permission-column">No Access</th>
                </tr>
            </thead>
            <tbody class="mdc-data-table__content">
            </tbody>
            <tfoot>
                <tr class="mdc-data-table__row mdc-data-table__footer-row">
                    <td colspan='6'>
                        <button class="mdc-button mdc-button--touch addMe">
                            <div class="mdc-button__ripple"></div>
                            <i class="material-icons mdc-button__icon" aria-hidden="true">person_add</i>
                            <span class="mdc-button__label">Add My User</span>
                            <div class="mdc-button__touch"></div>
                        </button>                        
                        
                        <button class="mdc-button mdc-button--touch addPermission">
                            <div class="mdc-button__ripple"></div>
                            <i class="material-icons mdc-button__icon" aria-hidden="true">person_add</i>
                            <span class="mdc-button__label">Add Another User</span>
                            <div class="mdc-button__touch"></div>
                        </button>                        
                    </td>
                </tr>
            </tfoot>
        </table>
        <div class="mdc-dialog__actions">
            <button class="mdc-button mdc-button--touch mdc-button--raised savePermissions" tabindex="1">
                <div class="mdc-button__ripple"></div>
                <span class="mdc-button__label">Save</span>
                <div class="mdc-button__touch"></div>
            </button>
        </div>
    </div>
</template>

<template id="webstrate-components-permission-user-tpl">
    <tr class="mdc-data-table__row">
        <td class="mdc-data-table__cell username"></td>
        <td class="mdc-data-table__cell">
            <div class="mdc-form-field">
                <div class="mdc-radio">
                    <input class="mdc-radio__native-control" type="radio" id="admin" value="a" name="permissions">
                    <div class="mdc-radio__background">
                        <div class="mdc-radio__outer-circle"></div>
                        <div class="mdc-radio__inner-circle"></div>
                    </div>
                    <div class="mdc-radio__ripple"></div>
                </div>
            </div>
        </td><td class="mdc-data-table__cell">
            <div class="mdc-form-field">
                <div class="mdc-radio">
                    <input class="mdc-radio__native-control" type="radio" id="write" value="w" name="permissions">
                    <div class="mdc-radio__background">
                        <div class="mdc-radio__outer-circle"></div>
                        <div class="mdc-radio__inner-circle"></div>
                    </div>
                    <div class="mdc-radio__ripple"></div>
                </div>
            </div>
        </td><td class="mdc-data-table__cell">
            <div class="mdc-form-field">
                <div class="mdc-radio">
                    <input class="mdc-radio__native-control" type="radio" id="read" value="r" name="permissions">
                    <div class="mdc-radio__background">
                        <div class="mdc-radio__outer-circle"></div>
                        <div class="mdc-radio__inner-circle"></div>
                    </div>
                    <div class="mdc-radio__ripple"></div>
                </div>
            </div>
        </td><td class="mdc-data-table__cell">
            <div class="mdc-form-field">
                <div class="mdc-radio">
                    <input class="mdc-radio__native-control" type="radio" id="none" value="" name="permissions">
                    <div class="mdc-radio__background">
                        <div class="mdc-radio__outer-circle"></div>
                        <div class="mdc-radio__inner-circle"></div>
                    </div>
                    <div class="mdc-radio__ripple"></div>
                </div>
            </div>
        </td>
        <td class="mdc-data-table__cell">
            <button class="mdc-button mdc-button--touch deletePermission">
                <div class="mdc-button__ripple"></div>
                <span class="mdc-button__label">Delete</span>
                <div class="mdc-button__touch"></div>
            </button>
        </td>
    </tr>
</template>

<template id="webstrate-components-permission-adduser-tpl">
    <tr class="mdc-data-table__row">
        <td class="mdc-data-table__cell username">
            <label class="mdc-text-field mdc-text-field--filled">
              <span class="mdc-text-field__ripple"></span>
              <input placeholder="F.x. 'bob:au'" class="mdc-text-field__input" type="text" aria-labelledby="webstrate-components-permission-adduser-username">
              <span class="mdc-floating-label" id="id="webstrate-components-permission-adduser-username"">username:provider</span>
              <span class="mdc-line-ripple"></span>
            </label>            
        </td>
        <td class="mdc-data-table__cell">
            <div class="mdc-form-field">
                <div class="mdc-radio">
                    <input class="mdc-radio__native-control" type="radio" id="webstrate-components-permission-adduser-admin" value="a" name="webstrate-components-permission-adduser-permissions" checked>
                    <div class="mdc-radio__background">
                        <div class="mdc-radio__outer-circle"></div>
                        <div class="mdc-radio__inner-circle"></div>
                    </div>
                    <div class="mdc-radio__ripple"></div>
                </div>
                <label for="webstrate-components-permission-adduser-admin">Admin, Write and Read</label>
            </div><br />
            <div class="mdc-form-field">
                <div class="mdc-radio">
                    <input class="mdc-radio__native-control" type="radio" id="webstrate-components-permission-adduser-write" value="w" name="webstrate-components-permission-adduser-permissions">
                    <div class="mdc-radio__background">
                        <div class="mdc-radio__outer-circle"></div>
                        <div class="mdc-radio__inner-circle"></div>
                    </div>
                    <div class="mdc-radio__ripple"></div>
                </div>
                <label for="webstrate-components-permission-adduser-write">Write and Read</label>
            </div><br />
            <div class="mdc-form-field">
                <div class="mdc-radio">
                    <input class="mdc-radio__native-control" type="radio" id="webstrate-components-permission-adduser-read" value="r" name="webstrate-components-permission-adduser-permissions">
                    <div class="mdc-radio__background">
                        <div class="mdc-radio__outer-circle"></div>
                        <div class="mdc-radio__inner-circle"></div>
                    </div>
                    <div class="mdc-radio__ripple"></div>
                </div>
                <label for="webstrate-components-permission-adduser-read">Read Only</label>
            </div><br />
            <div class="mdc-form-field">
                <div class="mdc-radio">
                    <input class="mdc-radio__native-control" type="radio" id="webstrate-components-permission-adduser-none" value="" name="webstrate-components-permission-adduser-permissions">
                    <div class="mdc-radio__background">
                        <div class="mdc-radio__outer-circle"></div>
                        <div class="mdc-radio__inner-circle"></div>
                    </div>
                    <div class="mdc-radio__ripple"></div>
                </div>
                <label for="webstrate-components-permission-adduser-none">None</label>
            </div>
        </td>
    </tr>
</template>

<template id="webstrate-components-permission-add-permission-dialog-tpl">
    <div>
        <table class="mdc-data-table__table" aria-label="User permissions">
            <thead>
            <tr class="mdc-data-table__header-row">
                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">User</th>
                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Permissions</th>
            </tr>
            </thead>
            <tbody class="mdc-data-table__content">
            </tbody>
        </table>    
        <div class="mdc-dialog__actions">
            <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="cancel">
                <div class="mdc-button__ripple"></div>
                <span class="mdc-button__label">Cancel</span>
            </button>
            <button type="button" class="mdc-button mdc-dialog__button mdc-button--raised" data-mdc-dialog-action="add">
                <div class="mdc-button__ripple"></div>
                <span class="mdc-button__label">Add</span>
            </button>
        </div>
    </div>
</template>

            </div>
            <div class="package" id="HeadEditorComponent">
                <script id="descriptor-script" type="descriptor">
{
    "friendlyName": "Head Editor Component",
    "description": "Easily modify the properties in the head of the page",
    "dependencies": [
        "#WebstrateComponents_Tools"
    ],
    "optionalDependencies": [
        "wpm_js_libs #material-design-components",
        "wpm_js_libs #material-design-icons"
    ],
    "assets": [],
    "version": "1.0",
    "license": "Apache 2.0",
    "changelog": {
        "1.0": "Initial version"
    }
}

</script>

                <template id="headEditorBase">
    <div class="head-editor-base">

        <div class="inline-text-field-container">
            <div class="mdc-text-field mdc-text-field--filled mdc-text-field--with-leading-icon" data-mdc-auto-init="MDCTextField">
                <i aria-hidden="true" class="material-icons mdc-text-field__icon mdc-text-field__icon--leading">title</i>  
                <input class="mdc-text-field__input" id="title-input" type="text" aria-labelledby="title-label">
                <div class="mdc-line-ripple"></div>
                <label class="mdc-floating-label" id="title-label">Title</label>
            </div>
            <div class="mdc-text-field-helper-line">
                <div class="mdc-text-field-helper-text">Shown in browser tabs and history</div>
            </div>
        </div>

        <div class="inline-text-field-container">
            <div class="mdc-text-field mdc-text-field--filled mdc-text-field--with-leading-icon" data-mdc-auto-init="MDCTextField">
                <i aria-hidden="true" class="material-icons mdc-text-field__icon mdc-text-field__icon--leading">person</i>  
                <input class="mdc-text-field__input" type="text" aria-labelledby="author-label" id="author-input">
                <span class="mdc-line-ripple"></span>
                <label class="mdc-floating-label" id="author-label">Author</label>
            </div>
            <div class="mdc-text-field-helper-line">
                <div class="mdc-text-field-helper-text">The name of your or your team</div>
            </div>
        </div>

        <div class="inline-text-field-container">
            <div class="mdc-text-field mdc-text-field--filled mdc-text-field--with-leading-icon" data-mdc-auto-init="MDCTextField">
                <i aria-hidden="true" class="material-icons mdc-text-field__icon mdc-text-field__icon--leading">tag</i>  
                <input class="mdc-text-field__input" type="text" aria-labelledby="keywords-label" id="keywords-input">
                <span class="mdc-line-ripple"></span>
                <label class="mdc-floating-label" id="keywords-label">Keywords</label>
            </div>
            <div class="mdc-text-field-helper-line">
                <div class="mdc-text-field-helper-text">Comma separated list of keywords</div>
            </div>
        </div>
        
        
        <div class="inline-text-field-container">
            <div class="mdc-text-field mdc-text-field--filled mdc-text-field--with-leading-icon" data-mdc-auto-init="MDCTextField">
                <i aria-hidden="true" class="material-icons mdc-text-field__icon mdc-text-field__icon--leading">edit_note</i>  
                <input class="mdc-text-field__input" type="text" aria-labelledby="description-label" id="description-input">
                <span class="mdc-line-ripple"></span>
                <label class="mdc-floating-label" id="description-label">Description</label>
            </div>
            <div class="mdc-text-field-helper-line">
                <div class="mdc-text-field-helper-text">Short textual description</div>                
            </div>
        </div>  
    </div>
</template>

                <script id="head-editor-component-script" type="disabled">
/**
 *  Head Editor
 * 
 *  Copyright 2022, 2024 Rolf Bagge & Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 **/

/**
 * Editor for adding/removing and changing common document attributes
 */
window.HeadEditorComponent = class HeadEditorComponent {
    constructor(autoOpen = true) {
        let self = this;
        self.html = WebstrateComponents.Tools.loadTemplate("#headEditorBase");

        // WPMv2 then
        self.setupBasicProperties();
        //

        if (autoOpen)
            this.openInBody();
    }

    setupBasicProperties() {
        let self = this;
        
        // Title
        self.html.querySelector("#title-input").value = document.title;
        self.html.querySelector("#title-input").addEventListener("input", () => {
            let newTitle = self.html.querySelector("#title-input").value.trim();
            document.title = newTitle;
            let titleElement = document.head.querySelector("title");
            if (newTitle.length === 0) {
                if (titleElement){
                    titleElement.remove();
                }
            } else {
                if (titleElement){
                    WPMv2.stripProtection(titleElement);
                }
            }
        });
        
        ["author","keywords","description"].forEach((metaField)=>{
            try {
                self.html.querySelector("#"+metaField+"-input").value = document.querySelector("head meta[name='"+metaField+"']").getAttribute("content");
            } catch (ex){
                // Ignore missing fields
            }
            
            self.html.querySelector("#"+metaField+"-input").addEventListener("input", () => {
                let newValue = self.html.querySelector("#"+metaField+"-input").value.trim();
                
                let metaElement = document.head.querySelector('meta[name="'+metaField+'"]');
                if (newValue.length === 0){
                    if (metaElement){
                        metaElement.remove();
                    }
                } else {
                    if (!metaElement){
                        metaElement = document.createElement("meta");
                        metaElement.setAttribute("name", metaField);
                        WPMv2.stripProtection(metaElement);
                        document.head.appendChild(metaElement);
                    }
                    metaElement.setAttribute("content", newValue);
                }
            });
        });
    }

    openInBody() {
        let parent = document.createElement("transient");
        parent.appendChild(this.html);
        document.body.appendChild(parent);
    }
};


// tags: 
//  title
//  script:not(unapproved)
//  link rel href
//  base href, target
// meta: 
//  viewport, keywords, description, author

</script>
                
            </div>            

            <div class="package" id="ModalDialog">
                <script id="descriptor-script" type="descriptor">
{
    "friendlyName": "Modal Dialog",
    "description": "Generic Modal Dialog",
    "dependencies": [
        "wpm_js_libs #material-design-components",
        "wpm_js_libs #material-design-icons",
        "wpm_js_libs #UUIDGenerator",
        "#WebstrateComponents_Tools",
        "codestrates-repos #EventSystem"
    ],
    "assets": [ 
    ],
    "version": "1.0",
    "license": "Apache 2.0",
    "changelog": {
        "1.0": "Initial version"
    }
}

</script>

                <style id="main-style">
/**
 *  Modal styles
 * 
 *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/
.wc-modal-dialog {
  z-index: 9000; }
  .wc-modal-dialog .mdc-dialog__surface {
    max-width: 95%; }
  .wc-modal-dialog .mdc-dialog__content.flexcontent {
    display: flex;
    padding: 0; }
  .wc-modal-dialog.wc-modal-maximized .mdc-dialog__container {
    min-width: 85%; }
    .wc-modal-dialog.wc-modal-maximized .mdc-dialog__container .mdc-dialog__surface {
      min-width: 100%;
      height: 100%; }
</style>

                <script id="ModalDialog-script" type="disabled">
/**
 *  Modal
 *  Provides a way to open modal dialogs
 * 
 *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
 *  Center for Advanced Visualization and Interacion, Aarhus University
 *    
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0

 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
**/

/* global mdc */

/**
 * @typedef {Object} ModalDialog~ModalDialogOptions
 * @property {string} [title=""] - The dialog title
 * @property {boolean} [closeOnOutsideClick=true] - Automatically close the dialog when clicking outside the dialog
 * @property {boolean} [closeOnEscape=true] - Automatically close the dialog when ESCAPE is pressed
 * @property {boolean} [autoStackButtons=true] - Automatically stack buttons if they do not fit horizontally
 */

/**
 * Modal component using MDCDialog as a framework
 */
class ModalDialog {

    /**
     * Creates a new ModalDialog
     * @param {Node} content - The content to place inside the Dialog
     * @param {ModalDialog~ModalDialogOptions} [options]
     */
    constructor(content, options = {}) {
        const self = this;

        const defaultOptions = {
            title: "",
            classes: [],
            closeOnOutsideClick: true,
            closeOnEscape: true,
            autoStackButtons: true,
            maximize: false,
            flexContent: false,
            actions: {}
        };

        this.uuid = UUIDGenerator.generateUUID("dialog-");

        this.options = Object.assign({}, defaultOptions, options);

        this.html = WebstrateComponents.Tools.loadTemplate("#webstrate-components-modal-dialog-tpl");

        this.title = this.html.querySelector(".mdc-dialog__title");
        this.content = this.html.querySelector(".mdc-dialog__content");
        this.actions = this.html.querySelector(".mdc-dialog__actions");

        this.title.id = this.uuid + "-title";
        this.content.id = this.uuid + "-content";

        this.html.querySelector(".mdc-dialog__surface").setAttribute("aria-labelledby", this.title.id);
        this.html.querySelector(".mdc-dialog__surface").setAttribute("aria-describedby", this.content.id);

        // Action buttons
        if (this.options.actions === null || Object.keys(this.options.actions).length===0){
                this.actions.remove();
        } else {
                for (const [action, actionOptions] of Object.entries(this.options.actions)) {
                        let actionButton = document.createElement("button");
                        actionButton.classList.add("mdc-button");
                        actionButton.classList.add("mdc-dialog__button");
                        if (actionOptions.primary){
                                actionButton.classList.add("mdc-button--raised");
                        }
                        actionButton.setAttribute("data-mdc-dialog-action", action);
                        
                        if (actionOptions.mdcIcon){
                                let icon = document.createElement("i");
                                icon.classList.add("material-icons");
                                icon.classList.add("mdc-button__icon");
                                icon.innerText = actionOptions.mdcIcon;
                                actionButton.appendChild(icon);
                        }
                        
                        let ripple = document.createElement("div");
                        ripple.classList.add("mdc-button__ripple");
                        actionButton.appendChild(ripple);
                        
                        let label = document.createElement("span");
                        label.classList.add("mdc-button__label");
                        if (actionOptions.label){
                                label.innerText = actionOptions.label;
                        } else {
                                label.innerText = action;
                        }
                        actionButton.append(label);
                        
                        this.actions.appendChild(actionButton);
                }
        }

        if (this.options.flexContent){
            this.content.classList.add("flexcontent");
        }
        this.content.appendChild(content);
        if(this.options.title != null && this.options.title.trim() !== "") {
            this.title.textContent = this.options.title.trim();
        } else {
            this.title.remove();
        }

        if(this.options.classes != null) {
            let classes = this.options.classes;
            if(!Array.isArray(classes)) {
                classes = [classes];
            }

            classes.forEach((c)=>{
                this.html.classList.add(c);
            });
        }

        if (this.options.maximize){
            this.html.classList.add("wc-modal-maximized");
        }
        
        this.dialog = new mdc.dialog.MDCDialog(this.html);

        //Dont add anything to body!
        this.dialog.foundation.adapter.addBodyClass = ()=>{};

        this.dialog.autoStackButtons = this.options.autoStackButtons;

        if(!this.options.closeOnEscape) {
            this.dialog.escapeKeyAction = "";
        }

        if(!this.options.closeOnOutsideClick) {
            this.dialog.scrimClickAction = "";
        }

        this.dialog.listen("MDCDialog:opening", (evt)=>{
            EventSystem.triggerEvent("ModalDialog.Opening", {
                dialog: self
            });
        });

        this.dialog.listen("MDCDialog:opened", (evt)=>{
            EventSystem.triggerEvent("ModalDialog.Opened", {
                dialog: self
            });
        });

        this.dialog.listen("MDCDialog:closing", (evt)=>{
            EventSystem.triggerEvent("ModalDialog.Closing", {
                dialog: self,
                action: evt.detail.action
            });
        });

        this.dialog.listen("MDCDialog:closed", (evt)=>{
            EventSystem.triggerEvent("ModalDialog.Closed", {
                dialog: self,
                action: evt.detail.action
            });
        });
        
        mdc.autoInit(this.html);
    }

    open() {
        this.dialog.open();
    }

    close(action = null) {
        this.dialog.close(action);
    }
}

window.WebstrateComponents.ModalDialog = ModalDialog;

</script>

                <template id="webstrate-components-modal-dialog-tpl">
    <div class="wc-modal-dialog mdc-dialog">
        <div class="mdc-dialog__container">
            <div class="mdc-dialog__surface"
                 role="alertdialog"
                 aria-modal="true"
                 aria-labelledby="my-dialog-title"
                 aria-describedby="my-dialog-content">
                <h2 class="mdc-dialog__title" id="my-dialog-title"></h2>
                <div class="mdc-dialog__content" id="my-dialog-content"></div>
                <div class="mdc-dialog__actions"></div>                
            </div>
        </div>
        <div class="mdc-dialog__scrim"></div>
    </div>
</template>

            </div>

        </div>
    </body>
</html> 

